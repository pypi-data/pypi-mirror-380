## 静态应用安全测试（SAST）自动修复流程说明

### 概述

该流程图描述了从接收SAST报告到生成最终漏洞修复报告的完整自动化处理流程，分为四个阶段：

* **阶段0：检查状态和初始化**
* **阶段1：解析SAST报告并转换为JSON**
* **阶段2：漏洞分类与修复**
* **阶段3：生成最终漏洞修复报告**

![alt text](../image/arch_diag.png)

### 阶段0 - 检查状态和初始化

1. 检查`.scanissuefix`目录及其内部是否存在后缀为`_new.json`的文件。
2. 根据检测结果：
   * **无未完成修复任务**：清理或创建`.scanissuefix`目录，进入阶段1新会话。
   * **存在未完成修复任务**：提示用户选择继续之前会话(`resume`)或开始新会话(`new`)。
5. 用户选择后，流程进入阶段1（新会话）或阶段2（继续修复）。


### 阶段1 - 解析SAST报告转JSON

1. 清除`.scanissuefix`目录中的旧文件。
2. 使用`MCP-Doc`工具解析`.docx`格式的SAST报告，转换成结构化的JSON文件，存储为`_new.json`格式。
3. 解析完成后，生成相应JSON文件，进入阶段2。


### 阶段2 - 漏洞分类和修复

1. 用户选择修复方式：
   * **审查代码并修复**：人工审查每个漏洞的代码差异和误报概率，决定是否应用修复。
   * **自动修复漏洞**：自动应用所有漏洞的修复补丁，无需人工审查。
2. 系统遍历`.scanissuefix`目录中的所有`_new.json`文件，逐个处理漏洞。
3. 对每个漏洞，依据用户选择：
   * 展示代码修复差异(diff)和误报概率。
   * 用户可选择“应用修复”、“忽略修复”或“标记误报”。
   * 根据选择，更新代码和JSON状态。
4. 自动修复模式下，系统自动应用diff并更新状态。
5. 每个JSON文件修复完成后，文件名由`_new.json`更改为`_finished.json`。


### 阶段3 - 生成最终漏洞修复报告
1. 系统汇总所有`_finished.json`文件中的数据。
2. 调用`generate_csv_report`工具，生成最终的CSV格式漏洞修复报告`sast_fix_report.csv`，存储于`.scanissuefix`目录。
3. 报告字段包括：漏洞标题(issue\_title)、漏洞级别(issue\_level)、代码位置(code\_location)、代码行号(code\_line\_num)、代码详情(code\_details)、修复状态(status)、误报概率(false\_positive\_probability)及误报原因(false\_positive\_reason)。