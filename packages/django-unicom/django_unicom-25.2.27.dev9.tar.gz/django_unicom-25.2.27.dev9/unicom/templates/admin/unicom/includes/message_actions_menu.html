{# Modular context menu for message actions. Usage: include with message in context as 'message' #}
<style>
.message-actions-menu .menu-action {
  display: block;
  width: 100%;
  text-align: left;
  background: none;
  border: none;
  padding: 10px;
  cursor: pointer;
  color: var(--link-fg);
  text-decoration: none;
  font: inherit;
  transition: background 0.15s;
}
/* Ensure the actions button is visible on tool messages */
.message-tool .message-actions-btn {
  opacity: 1 !important;
  z-index: 15;
}
.message-actions-menu .menu-action:hover {
  background: var(--selected-row, #f0f0f0);
  text-decoration: none;
}
</style>
<div class="message-actions-menu-container" style="position: absolute; top: 8px; right: 12px; z-index: 10;">
  <button class="message-actions-btn" title="More actions" style="background: none; border: none; cursor: pointer; font-size: 1.2em; color: var(--body-quiet-color);">
    <i class="fas fa-ellipsis-v"></i>
  </button>
  <div class="message-actions-menu" style="display: none; position: absolute; top: 28px; right: 0; background: var(--form-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 180px;">
    {# Always show Copy HTML for email, or if html exists #}
    {% if message.html or message.platform == 'Email' %}
      <button class="menu-action message-action-copy-html" data-message-id="{{ message.id }}">Copy HTML</button>
    {% endif %}
    <button class="menu-action message-action-copy-text" data-message-id="{{ message.id }}">Copy Text</button>
    {% if message.platform == 'Email' and message.subject %}
      <button class="menu-action message-action-copy-subject" data-message-id="{{ message.id }}" data-subject="{{ message.subject|escapejs }}">Copy Subject</button>
    {% endif %}
    {% if message.platform == 'Email' %}
      {% if message.to or message.cc or message.bcc %}
        <button class="menu-action message-action-copy-recipients" data-message-id="{{ message.id }}" data-to="{{ message.to|join:', '|escapejs }}" data-cc="{{ message.cc|join:', '|escapejs }}" data-bcc="{{ message.bcc|join:', '|escapejs }}">Copy Recipients</button>
      {% endif %}
    {% endif %}
    <button class="menu-action message-action-copy-id" data-message-id="{{ message.id }}">Copy Message ID</button>
    <button class="menu-action message-action-copy-llm-chat" data-message-id="{{ message.id }}" data-mode="chat">Copy As LLM Chat (Chat Mode)</button>
    <button class="menu-action message-action-copy-llm-thread" data-message-id="{{ message.id }}" data-mode="thread">Copy As LLM Chat (Thread Mode)</button>
    {% if message.platform == 'Email' %}
      <button class="menu-action message-action-download-pdf" data-message-id="{{ message.id }}">Download PDF</button>
    {% endif %}
    <a href="/admin/unicom/message/{{ message.id }}/change/" target="_blank" class="menu-action">View Message Details</a>
  </div>
</div>
<script>
(function() {
  var scriptId = 'script_' + Math.random().toString(36).substr(2, 9);
  console.log('[MESSAGE_ACTIONS] Script executing with ID:', scriptId);
  console.log('[MESSAGE_ACTIONS] Script location:', window.location.href);
  console.log('[MESSAGE_ACTIONS] Document ready state:', document.readyState);

  // Toggle menu directly on button click
  var buttons = document.querySelectorAll('.message-actions-btn');
  console.log('[MESSAGE_ACTIONS] Found', buttons.length, 'buttons with class .message-actions-btn');

  buttons.forEach(function(btn, index) {
    console.log('[MESSAGE_ACTIONS] Processing button', index + 1, ':', btn);
    console.log('[MESSAGE_ACTIONS] Button parent element:', btn.parentElement);
    console.log('[MESSAGE_ACTIONS] Button closest .message:', btn.closest('.message'));

    // Check if button already has our event listener
    if (btn.hasAttribute('data-listener-attached')) {
      console.log('[MESSAGE_ACTIONS] Button', index + 1, 'already has event listener, skipping');
      return;
    }

    btn.addEventListener('click', function(e) {
      console.log('[MESSAGE_ACTIONS] Button clicked!', btn);
      console.log('[MESSAGE_ACTIONS] Click event:', e);
      e.stopPropagation();

      var container = btn.closest('.message-actions-menu-container');
      console.log('[MESSAGE_ACTIONS] Found container:', container);

      var menu = container ? container.querySelector('.message-actions-menu') : null;
      console.log('[MESSAGE_ACTIONS] Found menu:', menu);

      if (menu) {
        var isOpen = menu.style.display === 'block';
        console.log('[MESSAGE_ACTIONS] Menu current display:', menu.style.display, 'isOpen:', isOpen);

        // Close all other menus
        var allMenus = document.querySelectorAll('.message-actions-menu');
        console.log('[MESSAGE_ACTIONS] Closing', allMenus.length, 'menus');
        allMenus.forEach(function(m) {
          m.style.display = 'none';
        });

        var newDisplay = isOpen ? 'none' : 'block';
        menu.style.display = newDisplay;
        console.log('[MESSAGE_ACTIONS] Set menu display to:', newDisplay);
      } else {
        console.error('[MESSAGE_ACTIONS] Could not find menu element!');
      }
    });

    // Mark button as having event listener
    btn.setAttribute('data-listener-attached', 'true');
    console.log('[MESSAGE_ACTIONS] Added event listener to button', index + 1);
  });
  console.log('[MESSAGE_ACTIONS] Script', scriptId, 'finished processing buttons');

  // Debug function to inspect button state
  window.debugMessageActions = function() {
    console.log('=== MESSAGE ACTIONS DEBUG ===');
    var allButtons = document.querySelectorAll('.message-actions-btn');
    console.log('Total buttons found:', allButtons.length);

    allButtons.forEach(function(btn, i) {
      console.log('Button', i + 1, ':', {
        element: btn,
        hasListener: btn.hasAttribute('data-listener-attached'),
        parent: btn.parentElement,
        container: btn.closest('.message-actions-menu-container'),
        menu: btn.closest('.message-actions-menu-container') ?
              btn.closest('.message-actions-menu-container').querySelector('.message-actions-menu') : null,
        messageId: btn.closest('.message') ? btn.closest('.message').id : 'no-message-parent'
      });
    });
    console.log('=== END DEBUG ===');
  };

  // Hide all menus if clicking outside
  document.addEventListener('click', function(e) {
    console.log('[MESSAGE_ACTIONS] Document click detected, target:', e.target);
    var menus = document.querySelectorAll('.message-actions-menu');
    console.log('[MESSAGE_ACTIONS] Hiding', menus.length, 'menus due to outside click');
    menus.forEach(function(m) {
      m.style.display = 'none';
    });
  });
  // Copy HTML
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-html')) {
      console.log('[MESSAGE_ACTIONS] Copy HTML clicked for message:', e.target.getAttribute('data-message-id'));
      var msgId = e.target.getAttribute('data-message-id');
      var msgElem = document.getElementById('message_' + msgId);
      var htmlElem = msgElem ? msgElem.querySelector('.message-content') : null;
      if (htmlElem) {
        var html = htmlElem.innerHTML;
        navigator.clipboard.writeText(html);
        console.log('[MESSAGE_ACTIONS] HTML copied to clipboard');
      }
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Copy Text
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-text')) {
      console.log('[MESSAGE_ACTIONS] Copy Text clicked for message:', e.target.getAttribute('data-message-id'));
      var msgId = e.target.getAttribute('data-message-id');
      var msgElem = document.getElementById('message_' + msgId);
      console.log('[MESSAGE_ACTIONS] Found message element:', msgElem);

      var textElem = msgElem ? msgElem.querySelector('pre') : null;
      var text = textElem ? textElem.innerText : '';
      console.log('[MESSAGE_ACTIONS] Found pre element text:', text);

      if (!text && msgElem) {
        // fallback: try .message-content (for html emails)
        var htmlElem = msgElem.querySelector('.message-content');
        if (htmlElem) text = htmlElem.innerText;
        console.log('[MESSAGE_ACTIONS] Fallback to .message-content:', text);
      }
      if (!text && msgElem) {
        // fallback: try tool call/response messages
        var toolElem = msgElem.querySelector('.tool-call-message, .tool-response-message');
        if (toolElem) text = toolElem.innerText;
        console.log('[MESSAGE_ACTIONS] Fallback to tool element:', text);
      }
      if (text) {
        navigator.clipboard.writeText(text);
        console.log('[MESSAGE_ACTIONS] Text copied to clipboard');
      } else {
        console.log('[MESSAGE_ACTIONS] No text found to copy');
      }
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Copy Subject
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-subject')) {
      var subject = e.target.getAttribute('data-subject');
      if (subject) navigator.clipboard.writeText(subject);
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Copy Recipients
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-recipients')) {
      var to = e.target.getAttribute('data-to');
      var cc = e.target.getAttribute('data-cc');
      var bcc = e.target.getAttribute('data-bcc');
      var recipients = '';
      if (to) recipients += 'To: ' + to + '\n';
      if (cc) recipients += 'Cc: ' + cc + '\n';
      if (bcc) recipients += 'Bcc: ' + bcc + '\n';
      if (recipients) navigator.clipboard.writeText(recipients.trim());
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Copy ID
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-id')) {
      var msgId = e.target.getAttribute('data-message-id');
      navigator.clipboard.writeText(msgId);
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Download PDF
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-download-pdf')) {
      var msgId = e.target.getAttribute('data-message-id');
      // Download from backend endpoint (to be implemented)
      window.open(`/admin/unicom/message/${msgId}/download_pdf/`, '_blank');
      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
  // Copy As LLM Chat
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('message-action-copy-llm-chat') || e.target.classList.contains('message-action-copy-llm-thread')) {
      var msgId = e.target.getAttribute('data-message-id');
      var mode = e.target.getAttribute('data-mode');
      var url = `/unicom/api/message/${msgId}/as_llm_chat/?mode=${mode}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            navigator.clipboard.writeText(data.formatted_json).then(() => {
              // Show brief success feedback
              var originalText = e.target.textContent;
              e.target.textContent = 'Copied!';
              setTimeout(() => {
                e.target.textContent = originalText;
              }, 1000);
            }).catch(err => {
              console.error('Failed to copy to clipboard:', err);
              alert('Failed to copy to clipboard');
            });
          } else {
            console.error('API error:', data.error);
            alert('Error: ' + data.error);
          }
        })
        .catch(err => {
          console.error('Fetch error:', err);
          alert('Failed to fetch LLM chat data');
        });

      e.target.closest('.message-actions-menu').style.display = 'none';
      e.stopPropagation();
    }
  });
})();
</script> 