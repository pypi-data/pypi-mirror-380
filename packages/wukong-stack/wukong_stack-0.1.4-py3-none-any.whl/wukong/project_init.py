import os
import json
import click
from wukong.llmclient import LLMClient
from wukong.prompts import PROJECT_INIT_PROMPT


@click.group()
def init_project():
    """Initialize various project structures."""
    pass


project_name = click.option(
    "--project-name",
    type=str,
    default="MyProject",
    help="Name of the project.",
)

project_description = click.option(
    "--project-description",
    type=str,
    default="A sample project generated by Wukong.",
    help="Description of the project.",
)

additional_instructions = click.option(
    "--additional-instructions",
    type=str,
    default="",
    help="Additional instructions for project generation.",
)


@click.command()
@project_name
@project_description
@additional_instructions
def init_flask(project_name, project_description, additional_instructions):
    """Initialize a Flask project structure."""
    get_project_structure(
        project_type="flask",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Flask project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_fastapi(project_name, project_description, additional_instructions=""):
    """Initialize a FastAPI project structure."""
    get_project_structure(
        project_type="fastapi",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("FastAPI project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_fastmcp(project_name, project_description, additional_instructions=""):
    """Initialize a Fast MCP project structure."""
    get_project_structure(
        project_type="fastmcp",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Fast MCP project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_vue3(project_name, project_description, additional_instructions=""):
    """Initialize a Vue 3 project structure."""
    get_project_structure(
        project_type="vue3",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Vue 3 project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_react(project_name, project_description, additional_instructions=""):
    """Initialize a React project structure."""
    get_project_structure(
        project_type="react",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("React project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_pypi(project_name, project_description, additional_instructions=""):
    """Initialize a PyPI package structure."""
    get_project_structure(
        project_type="pypi",
        project_name=project_name,
        project_description=project_description,
    )
    click.echo("PyPI package initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_npm(project_name, project_description, additional_instructions=""):
    """Initialize an NPM package structure."""
    get_project_structure(
        project_type="npm",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("NPM package initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_golang(project_name, project_description, additional_instructions=""):
    """Initialize a Go project structure."""
    get_project_structure(
        project_type="golang",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Go project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_gogin(project_name, project_description, additional_instructions=""):
    """Initialize a Go Gin project structure."""
    get_project_structure(
        project_type="gogin",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Go Gin project initialized!")


@click.command()
@project_name
@project_description
@additional_instructions
def init_rust(project_name, project_description, additional_instructions=""):
    """Initialize a Rust project structure."""
    get_project_structure(
        project_type="rust",
        project_name=project_name,
        project_description=project_description,
        additional_instructions=additional_instructions,
    )
    click.echo("Rust project initialized!")


init_project.add_command(init_flask, "flask")
init_project.add_command(init_fastapi, "fastapi")
init_project.add_command(init_fastmcp, "fastmcp")
init_project.add_command(init_vue3, "vue3")
init_project.add_command(init_react, "react")
init_project.add_command(init_pypi, "pypi")
init_project.add_command(init_npm, "npm")
init_project.add_command(init_golang, "golang")
init_project.add_command(init_gogin, "gogin")
init_project.add_command(init_rust, "rust")


def create_file(parent_path, structure: dict):
    for name, content in structure.items():
        path = os.path.join(parent_path, name)
        if content is None:
            # It's a file
            with open(path, "w", encoding="utf-8") as f:
                f.write("")  # Create an empty file
        elif isinstance(content, dict):
            # It's a directory
            os.makedirs(path, exist_ok=True)
            create_file(path, content)
        else:
            # It's a file with content
            with open(path, "w", encoding="utf-8") as f:
                f.write(content)


def get_project_structure(**args):
    final_prompt = PROJECT_INIT_PROMPT.format(
        project_type=args.get("project_type", "pypi"),
        project_name=args.get("project_name", "backend"),
        project_description=args.get(
            "project_description", "A sample project generated by Wukong."
        ),
    )
    llm_client = LLMClient()
    response = llm_client.invoke_llm(final_prompt, max_tokens=3000)
    projects = json.loads(response)
    create_file(os.getcwd(), projects["directory_structure"])
    create_file(os.getcwd(), projects["key_files"])
