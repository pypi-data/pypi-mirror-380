import numpy as np
import numpy.typing as npt

from pygfn0._pygfn0 import gfn0


def coffeine() -> tuple[npt.ArrayLike, npt.ArrayLike]:
    Z = [6, 7, 6, 7, 6, 6, 6, 8, 7, 6, 8, 7, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    R = [
        [2.02799738646442, 0.09231312124713, -0.14310895950963],
        [4.75011007621000, 0.02373496014051, -0.14324124033844],
        [6.33434307654413, 2.07098865582721, -0.14235306905930],
        [8.72860718071825, 1.38002919517619, -0.14265542523943],
        [8.65318821103610, -1.19324866489847, -0.14231527453678],
        [6.23857175648671, -2.08353643730276, -0.14218299370797],
        [5.63266886875962, -4.69950321056008, -0.13940509630299],
        [3.44931709749015, -5.48092386085491, -0.14318454855466],
        [7.77508917214346, -6.24427872938674, -0.13107140408805],
        [10.30229550927022, -5.39739796609292, -0.13672168520430],
        [12.07410272485492, -6.91573621641911, -0.13666499342053],
        [10.70038521493902, -2.79078533715849, -0.14148379504141],
        [13.24597858727017, -1.76969072232377, -0.14218299370797],
        [7.40891694074004, -8.95905928176407, -0.11636933482904],
        [1.38702118184179, 2.05575746325296, -0.14178615122154],
        [1.34622199478497, -0.86356704498496, 1.55590600570783],
        [1.34624089204623, -0.86133716815647, -1.84340893849267],
        [5.65596919189118, 4.00172183859480, -0.14131371969009],
        [14.67430918222276, -3.26230980007732, -0.14344911021228],
        [13.50897177220290, -0.60815166181684, 1.54898960808727],
        [13.50780014200488, -0.60614855212345, -1.83214617078268],
        [5.41408424778406, -9.49239668625902, -0.11022772492007],
        [8.31919801555568, -9.74947502841788, 1.56539243085954],
        [8.31511620712388, -9.76854236502758, -1.79108242206824],
    ]
    return Z, R


def test_coffeine_sp() -> None:
    from time import perf_counter_ns

    Z, R = coffeine()
    e_ref = -40.90885036015837
    f_ref = [
        [-8.27600088e-03, 6.74981652e-04, 4.84752711e-06],
        [6.68264513e-04, -4.20477185e-02, -5.36340436e-05],
        [2.98706405e-02, 1.80417260e-02, 4.71087404e-05],
        [-1.43976918e-02, -7.83036074e-04, -2.51166615e-05],
        [-2.56520941e-02, 1.17099290e-03, -3.98790979e-05],
        [-5.41458174e-03, 1.94781572e-02, 2.58499838e-05],
        [2.17199464e-03, 2.76382672e-03, -2.77619947e-05],
        [-6.33937103e-03, 9.61410855e-03, -9.51442331e-05],
        [-7.19508749e-03, -2.33952598e-02, 1.42400425e-04],
        [-3.51011731e-03, 1.64061988e-03, -5.48340770e-05],
        [2.25088116e-02, -1.81167412e-02, -3.89166542e-05],
        [1.08458311e-02, 2.37273375e-02, -3.36242754e-05],
        [9.14000641e-03, 1.07015045e-03, -5.14057730e-06],
        [-8.52016482e-03, -3.50412184e-03, 1.69497137e-06],
        [-1.91096100e-03, 2.48935361e-03, 4.18536985e-06],
        [1.24315142e-03, 9.34470115e-04, 1.84857760e-03],
        [1.24563709e-03, 9.31685537e-04, -1.85170458e-03],
        [-2.70419520e-03, 9.58339557e-03, 2.71637379e-05],
        [5.50141780e-03, 2.33415846e-03, 2.93162229e-06],
        [1.00709328e-04, -1.35677303e-04, 1.51092169e-03],
        [1.19765751e-04, -1.16613514e-04, -1.51395370e-03],
        [-5.86838167e-04, -6.79993166e-03, 7.70036038e-05],
        [5.43218119e-04, 2.26162233e-04, 6.96572112e-04],
        [5.47655374e-04, 2.17973525e-04, -6.49547492e-04],
    ]

    t0 = perf_counter_ns()
    e, f = gfn0(numbers=Z, positions=R)
    print(e)
    print(f)
    t1 = perf_counter_ns()

    np.testing.assert_approx_equal(e, e_ref)
    np.testing.assert_array_almost_equal(f, f_ref)
    print(f"SPE for coffeine: {(t1 - t0) / 1e6:.2f}ms")
