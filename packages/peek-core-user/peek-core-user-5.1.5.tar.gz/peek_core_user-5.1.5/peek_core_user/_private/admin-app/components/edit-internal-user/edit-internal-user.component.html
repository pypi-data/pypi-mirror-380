<nz-card nzTitle="Edit Internal Users">
    <div class="card-content">
        <div class="search-form">
            <nz-form-label>Title Search</nz-form-label>
            <nz-input-group [nzSuffix]="suffixIcon">
                <input
                    type="text"
                    nz-input
                    [(ngModel)]="likeTitle"
                    (ngModelChange)="load()"
                    placeholder="Search by title"
                />
            </nz-input-group>
            <ng-template #suffixIcon>
                <i nz-icon nzType="search"></i>
            </ng-template>
        </div>

        <p *ngIf="needFilter()" class="empty-message">
            Enter a filter with a length of 3 or more.
        </p>

        <p *ngIf="!needFilter() && !haveItems()" class="empty-message">
            No users found!
        </p>

        <div *ngIf="haveItems()" class="table-container">
            <nz-table
                #basicTable
                [nzData]="items$ | async"
                [nzFrontPagination]="false"
                [nzShowSizeChanger]="true"
            >
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Display Name</th>
                        <th>UUID</th>
                        <th>Mobile</th>
                        <th>Email</th>
                        <th class="actions-cell">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let item of basicTable.data">
                        <!-- User Row -->
                        <tr class="user-row">
                            <td>
                                <nz-form-item>
                                    <nz-form-control>
                                        <input
                                            nz-input
                                            [(ngModel)]="item.userName"
                                            required
                                            placeholder="Enter username"
                                        />
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td>
                                <nz-form-item>
                                    <nz-form-control>
                                        <input
                                            nz-input
                                            [(ngModel)]="item.userTitle"
                                            required
                                            placeholder="Enter title"
                                        />
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td>
                                <nz-form-item>
                                    <nz-form-control>
                                        <input
                                            nz-input
                                            [(ngModel)]="item.userUuid"
                                            required
                                            placeholder="Enter UUID"
                                        />
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td>
                                <nz-form-item>
                                    <nz-form-control>
                                        <input
                                            nz-input
                                            [(ngModel)]="item.mobile"
                                            placeholder="Enter mobile"
                                        />
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td>
                                <nz-form-item>
                                    <nz-form-control>
                                        <input
                                            nz-input
                                            [(ngModel)]="item.email"
                                            type="email"
                                            placeholder="Enter email"
                                        />
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td class="actions-cell">
                                <button
                                    nz-button
                                    nzType="default"
                                    (click)="
                                        showPasswordModal(item, passwordModal)
                                    "
                                >
                                    <i nz-icon nzType="lock"></i>
                                </button>
                                <button
                                    nz-button
                                    nzType="default"
                                    nz-popconfirm
                                    nzPopconfirmTitle="Are you sure you want to delete this user?"
                                    (nzOnConfirm)="removeRow(item)"
                                >
                                    <i nz-icon nzType="delete"></i>
                                </button>
                                <button
                                    nz-button
                                    nzType="default"
                                    (click)="addGroupRow(item)"
                                >
                                    <i nz-icon nzType="plus"></i>
                                </button>
                            </td>
                        </tr>

                        <!-- Group Rows -->
                        <tr
                            *ngFor="let groupId of item.groupIds; let i = index"
                            class="user-row group-row"
                        >
                            <td colspan="3"></td>
                            <td>Group</td>
                            <td>
                                <nz-select
                                    *ngIf="groupId == null"
                                    (ngModelChange)="
                                        updateGroup(item, i, $event)
                                    "
                                    [ngModel]="null"
                                >
                                    <nz-option
                                        nzValue="null"
                                        nzLabel="-- Select --"
                                    ></nz-option>
                                    <nz-option
                                        *ngFor="let group of groups$ | async"
                                        [nzValue]="group.id"
                                        [nzLabel]="group.groupTitle"
                                    ></nz-option>
                                </nz-select>
                                <span *ngIf="groupId != null">
                                    {{ groupTitleForId(groupId) }}
                                </span>
                            </td>
                            <td class="actions-cell">
                                <button
                                    nz-button
                                    nzType="text"
                                    nzDanger
                                    (click)="removeGroupRow(item, i)"
                                >
                                    <i nz-icon nzType="minus"></i>
                                </button>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </nz-table>
        </div>

        <div class="table-footer">
            <nz-space>
                <button
                    *nzSpaceItem
                    nz-button
                    nzType="primary"
                    (click)="save()"
                >
                    <i nz-icon nzType="save"></i>
                    Save
                </button>
                <button
                    *nzSpaceItem
                    nz-button
                    nzType="default"
                    (click)="load()"
                >
                    <i nz-icon nzType="reload"></i>
                    Reset
                </button>
                <button
                    *nzSpaceItem
                    nz-button
                    nzType="default"
                    (click)="addRow()"
                >
                    <i nz-icon nzType="plus"></i>
                    Add
                </button>
            </nz-space>
        </div>
    </div>
</nz-card>

<ng-template #passwordModal>
    <form nz-form>
        <nz-form-item>
            <nz-form-label>New Password</nz-form-label>
            <nz-form-control>
                <nz-input-group [nzSuffix]="showPasswordIcon">
                    <input
                        nz-input
                        [type]="showPassword ? 'text' : 'password'"
                        [(ngModel)]="selectedUser.newPassword"
                        name="password"
                        placeholder="Enter new password"
                    />
                </nz-input-group>
            </nz-form-control>
        </nz-form-item>

        <nz-form-item>
            <nz-form-label>Confirm Password</nz-form-label>
            <nz-form-control>
                <nz-input-group [nzSuffix]="showPasswordIcon">
                    <input
                        nz-input
                        [type]="showPassword ? 'text' : 'password'"
                        [(ngModel)]="selectedUser.confirmPassword"
                        name="confirmPassword"
                        placeholder="Confirm new password"
                    />
                </nz-input-group>
            </nz-form-control>
        </nz-form-item>
    </form>

    <ng-template #showPasswordIcon>
        <i
            nz-icon
            [nzType]="showPassword ? 'eye-invisible' : 'eye'"
            (click)="showPassword = !showPassword"
        ></i>
    </ng-template>
</ng-template>
