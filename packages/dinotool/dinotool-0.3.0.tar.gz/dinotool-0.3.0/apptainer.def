Bootstrap: docker
From: nvidia/cuda:12.1.0-cudnn8-devel-rockylinux9

%environment
    export PATH=/opt/conda/bin:$PATH
    export PATH=/root/.local/bin:$PATH
    export PATH=/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export TORCH_CUDA_ARCH_LIST="7.0"

%post
    cp /usr/bin/true /usr/sbin/useradd
    cp /usr/bin/true /usr/sbin/groupadd

    yum install -y \
        git \
        cmake \
        wget \
        bash \
        gcc \
        gcc-c++ \
        make \
        which \
        patch \
        tar \
        unzip \
        bzip2 \
        file \
        findutils \
        util-linux \
        shadow-utils \
        zlib-devel \
        libpng-devel \
        libjpeg-turbo-devel \
        freetype-devel \
        mesa-libGL \
        mesa-libGLU-devel \
        boost-devel \
        gmp-devel \
        mpfr-devel \
        python3-devel \
        && yum clean all

    # Install Python tools
    wget -qO- https://astral.sh/uv/install.sh | sh
    source $HOME/.local/bin/env

    # Set env variables for CUDA
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export TORCH_CUDA_ARCH_LIST="7.0"

    uv python install 3.12
    uv python pin 3.12
    uv venv
    source .venv/bin/activate

    uv pip install dinotool