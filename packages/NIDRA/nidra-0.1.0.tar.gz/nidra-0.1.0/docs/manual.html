<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIDRA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="NIDRA Logo" class="sidebar-logo">
        </div>
        <ul>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#gui-guide">GUI (Overview)</a></li>
            <li><a href="#preparing-data">Preparing Your Data</a></li>
            <li><a href="#gui-walkthrough">GUI (Walkthrough)</a></li>
            <li><a href="#model-performance">Model Validation</a></li>
            <li><a href="#understanding-results">Understanding Results</a></li>
            <li><a href="#cli-guide">CLI Guide</a></li>
            <li><a href="#python-package">Python Guide</a></li>
            <li><a href="#install-from-source">Install from Source</a></li>
            <li><a href="#how-to-cite">How to Cite</a></li>
            <li><a href="#faq">FAQ & Troubleshooting</a></li>
            <li><a href="#attribution">Attribution</a></li>
            <li><a href="#license">License</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </nav>
    <main class="content">
        <section id="introduction">
            <h2>NIDRA v0.1 - super simple sleep scoring</h2>
            <p>Neural networks can perform highly accurate, automated sleep scoring, but these technologies are often difficult to implement.</p>
            <p>NIDRA is a fool-proof, simple-to-use tool for scoring sleep recordings using the best currently available autoscoring machine learning algorithms. No programming required, but a CLI and python endpoints are available.</p>
            <p>NIDRA can autoscore data from polysomnography (PSG) recordings, as well as from 2-channel EEG wearables (such as ZMax).</p>
            <p>NIDRA enables anyone, including researchers without any programming experience, to use cutting-edge sleep scoring models.</p>
            <p>NIDRA uses the highly accurate U-Sleep2.0 and ez6moe models by default. Both models have been validated (see below) and perform sleep scoring on the level of human interrater agreement.</p>
            <p> </p>
            <p>NIDRA lives here: <a href="https://github.com/paulzerr/nidra">github.com/paulzerr/nidra</a></p>
        </section>

        <section id="installation">
            <h2>Installation</h2>
            <h3>Option 1: Standalone executable</h3>
            <p>The easiest way to use NIDRA on Windows is via the portable, ready-to-go executable which requires no installation.</p>

            <h3><strong><a href="https://github.com/paulzerr/nidra/releases/latest/download/NIDRA.exe">Download standalone NIDRA for Windows</a></strong></h3>

            <p><strong>Note:</strong> due to the restrictive environment of Windows, you may see a "Search on app store" popup window. Click "No". You may also see the blue Smartscreen warning. In that case click "run anyway". Should this fail, try installing via pip (see below).</p>
            <br>
            <h3>Option 2: Install from PyPI</h3>
            <p>First, make sure you have Python installed (3.10 or later recommended). 
            <p>It is highly recommended to create a clean virtual environment to install NIDRA. This prevents conflicts with other packages.</p>
            <p><strong>Windows:</strong></p>
            <pre><code>python -m venv nidra-env
nidra-env\Scripts\activate
pip install nidra</code></pre>
            <p><strong>Mac/Linux:</strong></p>
            <pre><code>python -m venv nidra-env
source nidra-env/bin/activate
pip install nidra</code></pre>
            <p><strong>Or install using Conda (Windows/Mac/Linux):</strong></p>
            First install e.g., <a href="https://www.anaconda.com/download/success">Miniconda</a>.</p>
            <pre><code>conda create -n nidra-env
conda activate nidra-env
pip install nidra</code></pre>
            <p>Launch the graphical interface:</p>
            <pre><code>nidra</code></pre>
            <p><strong>Note:</strong> If you installed via pip, the first time you run NIDRA, the necessary model files will be automatically downloaded from <a href="https://huggingface.co/pzerr/NIDRA_models/">https://huggingface.co/pzerr/NIDRA_models/</a> (~152MB). </p>
            <br>
            <h3>Option 3: Install from source</h3>
            <p><strong>macOS and Linux:</strong></p>
            <pre><code>git clone https://github.com/paulzerr/nidra.git
cd NIDRA
python -m venv nidra-env
source nidra-env/bin/activate
pip install .</code></pre>
            <p><strong>Windows:</strong></p>
            <pre><code>git clone https://github.com/paulzerr/nidra.git
cd NIDRA
python -m venv nidra-env
nidra-env\Scripts\activate
pip install .</code></pre>
        </section>

        <section id="gui-guide">
            <h2>Graphical User Interface (GUI)</h2>
            <p>The GUI provides an intuitive, point-and-click way to score sleep recordings. The easiest way to launch the GUI is by running the standalone executable. If you installed NIDRA as a package, you can launch it by opening your terminal and running the command: <code>nidra</code></p>
            <img src="gui.png" alt="Screenshot of the NIDRA GUI" style="width: 90%; display: block; margin: 20px 0;">
            <p><b>Fig.1</b> - Screenshot of the GUI</p>
            <h3>Quick Guide</h3>
            <ol>
                <li><strong>Input Folder</strong>: Select the directory containing the sleep recording data.</li>
                <li><strong>Output Folder</strong>: Select the directory where the results will be saved.</li>
                <li><strong>Scoring Mode</strong>: Choose to score a single recording or batch-process all subdirectories, eaching containing one recording.</li>
                <li><strong>Data Source</strong>: Select "Forehead EEG" or "PSG".</li>
                <li><strong>Model</strong>: Select the appropriate model for your data source. Default models are reliable.</li>
                <li><strong>Options</strong>: Choose whether to generate plots and statistics.</li>
                <li><strong>Run</strong>: Start the scoring process.</li>
            </ol>
            <p>A more detailed walkthrough is provided in the sections below.</p>
        </section>

        <section id="preparing-data">
            <h2>Preparing Your Data</h2>
            <p>For NIDRA to process your recordings, your files and folders must be organized in a specific way.</p>

            <ul>
                <li><strong>File Format:</strong> Currently NIDRA exclusively works with European Data Format (.edf) files.</li>
                <li><strong>Channel Labels:</strong> Ideally your EDF files have standard channel labels (e.g., 'EEG Fpz-Cz', 'EOG left', 'Fp1', 'O2-M1') for PSG data, as NIDRA uses these to identify channel types.</li>
            </ul>

            <p>Whether you are scoring a single file or batch processing, NIDRA expects each recording session to be in its own folder. When using the "Score all subdirectories" mode, NIDRA will treat every subfolder in your input directory as a separate recording.</p>
            <p><strong>Structure for Forehead EEG (e.g., ZMax):</strong></p>
            <p>For two-channel forehead EEG data, the left and right channel files must be in the same directory. For ZMax data, these are typically named <code>EEG_L.edf</code> and <code>EEG_R.edf</code>.</p>
            <pre>
forehead_study/
├── subject_01/
|   ├── EEG_L.edf
|   └── EEG_R.edf
├── subject_02/
|   ├── night01_L.edf
|   └── night01_R.edf
</pre>
            <p><strong>Structure for PSG:</strong></p>
            <p>Similarly, for PSG data, each EDF file should be in its own directory. NIDRA can process multiple recordings in subdirectories, as shown in this example with three recordings:</p>
            <pre>
psg_study/
├── subject_02/
|   └── night_recording_1.edf
├── subject_03/
|   └── night_recording_2.edf
└── subject_04/
    └── another_night.edf
</pre>
        </section>

        <section id="gui-walkthrough">
            <h2>GUI Guide: A Step-by-Step Walkthrough</h2>
            <p>This guide provides a detailed walkthrough of how to score a sleep recording using the NIDRA graphical interface, from launching the application to interpreting your results.</p>
            <h3>Step 1: Launching the Application</h3>
            <p>The easiest way is to double-click the standalone executable file you downloaded. Alternatively, if you installed NIDRA as a package, open your terminal and type <code>nidra</code>, then press Enter. The main application window will appear.</p>
            <h3>Step 2: Setting Input and Output Paths</h3>
            <p>Your first step is to tell NIDRA where your data is and where the results should go.</p>
            <ul>
                <li><strong>Input Directory:</strong> Click the "Browse files..." button. A file dialog will open. Navigate to and select the folder that contains your sleep recording file(s). For batch processing, this would be your main project folder containing subdirectories for each subject.</li>
                <li><strong>Output Directory:</strong> Specify the folder where NIDRA will save the scoring results. If you leave this blank, NIDRA will automatically create a new folder named <code>autoscorer_output</code> inside your input directory. This is the recommended approach for keeping your data and results organized.</li>
            </ul>
            <h3>Step 3: Configuring the Scoring Mode</h3>
            <p>NIDRA offers two modes for processing:</p>
            <ul>
                <li><strong>Score single recording:</strong> Choose this if the folder you selected as your input contains the files for only one sleep session.</li>
                <li><strong>Score all recordings (in subfolders):</strong> Choose this for batch processing. NIDRA will look for subdirectories within your selected input folder and process each one as a separate recording.</li>
            </ul>
            <h3>Step 4: Selecting the Data Source and Model</h3>
            <p>This is a critical step to ensure high-quality scoring.</p>
            <ul>
                <li><strong>Data Source:</strong> Select the type of recording you have. Choose "Forehead EEG" for 2-channel wearable data or "PSG" for standard polysomnography data.</li>
                <li><strong>Model:</strong> The available models will change based on your data source. For forehead EEG, <code>ez6moe</code> is recommended for its high accuracy. For PSG, <code>u-sleep-nsrr-2024</code> is the standard choice.</li>
            </ul>
            <h3>Step 5: Running the Analysis and Monitoring Progress</h3>
            <p>Before starting, you can choose to generate plots and sleep statistics using the checkboxes. It is highly recommended to keep these enabled. Click the <strong>"Run NIDRA autoscoring"</strong> button to begin. The button will be disabled and read "Running..." during processing. You can monitor the real-time progress in the console panel on the right. This log will show which files are being processed and report any warnings or errors.</p>
        </section>

        <section id="model-performance">
            <h2>Model Validation and Performance</h2>
            <p>The models included in NIDRA have been rigorously validated against manually scored data from human experts. Below is a summary of their performance.</p>
            <h3>ez6 and ez6moe for Forehead EEG</h3>
            <p>The <code>ez6moe</code> model was validated against expert-scored PSG recordings. The confusion matrix below shows the model's predictions (y-axis) versus the expert labels (x-axis). The diagonal represents correct classifications. As you can see, the model shows high agreement with the expert scorer, particularly for Wake, N2, and REM sleep.</p>
            <img src="matrix.png" alt="Confusion matrix of the ez6moe model" style="width: 60%; max-width: 600px; display: block; margin: 20px 0;">
            <p><b>Fig.2</b> - Confusion matrix (vs. manually scored PSG) of the artefact-aware ez6moe model.</p>
            <p>Key performance metrics, such as accuracy and Cohen's Kappa (a measure of inter-rater agreement), are comparable to the agreement levels seen between different human experts. For full details, please refer to the original publication.</p>
            <h3>U-Sleep for PSG</h3>
            <p>The U-Sleep model is a well-established, state-of-the-art algorithm for PSG sleep scoring. The version used in NIDRA (<code>u-sleep-nsrr-2024</code>) is a robust implementation trained on a large dataset. It demonstrates high performance across diverse populations and recording conditions. For detailed performance metrics, please see the original U-Sleep and SLEEPYLAND publications linked in the Attribution section.</p>
        </section>

        <section id="understanding-results">
            <h2>Understanding Your Results</h2>
            <p>Once NIDRA has finished processing, you will find several output files in your specified output directory. Here's what they are and how to use them.</p>
            <h3>The Output Files</h3>
            <p>For each recording, NIDRA generates up to four files:</p>
            <ul>
                <li><strong>Hypnogram File (<code>..._hypnogram.csv</code>):</strong> A CSV file with a single column of numbers, where each number is the sleep stage for one 30-second epoch.</li>
                <li><strong>Probabilities File (<code>..._probabilities.csv</code>):</strong> This file contains the raw classifier probabilities for each sleep stage for every epoch. Each row corresponds to an epoch, and each column corresponds to a sleep stage (Wake, N1, N2, N3, REM, Artifact).</li>
                <li><strong>Dashboard Plot (<code>..._dashboard.png</code>):</strong> A graph with a hypnogram, a time-frequency representation, and a hypnodensity plot visualizing classifier probabilities.</li>
                <li><strong>Sleep Statistics (<code>..._sleep_statistics.csv</code>):</strong> A summary of sleep metrics like Total Sleep Time, Sleep Efficiency, and time spent in each stage.</li>
            </ul>
            
            <h3>Sleep Stage Key</h3>
            <p>The hypnogram uses the following standard numeric codes for sleep stages:</p>
            <ul>
                <li><strong>0:</strong> Wake</li>
                <li><strong>1:</strong> N1</li>
                <li><strong>2:</strong> N2</li>
                <li><strong>3:</strong> N3</li>
                <li><strong>5:</strong> REM</li>
                <li><strong>6:</strong> Artifact</li>
            </ul>
        </section>

        <section id="cli-guide">
            <h2>Commandline interface (CLI)</h2>
            <p>The basic command is <code>nidra score</code>. You must provide the input path, output directory, and the type of scorer.</p>
            <pre><code>nidra score --input_path /path/to/data --output_dir /path/to/output --scorer_type forehead</code></pre>
            <h3>Example: Batch Processing a Full Study</h3>
            <p>Let's say you have a study with data structured as recommended in the "Preparing Your Data" section. You can process all subjects with a single command by pointing the <code>--input_path</code> to the main study directory.</p>
            <pre><code>nidra score --input_path /my_study_data/ --output_dir /my_study_results/ --scorer_type forehead --model_name ez6moe</code></pre>
            <p>NIDRA will automatically find the subdirectories, process the recording in each one, and place the results in a correspondingly named folder inside <code>/my_study_results/</code>.</p>
        </section>

        <section id="python-package">
            <h2>Python Endpoints</h2>
            <p>You can use NIDRA as a Python package to integrate automated scoring directly into your data analysis pipelines.</p>

            <p>The main entry point is the <code>NIDRA.scorer()</code> factory function. You call this function to create a scorer instance, providing it with the configuration for your scoring task. Then, you call the <code>.score()</code> method on the returned object to run the analysis.</p>
            
            <h4><code>NIDRA.scorer(...)</code> Parameters</h4>
            <p>When creating a scorer, you must provide the following arguments:</p>
            <ul>
                <li><code>scorer_type</code> (str): The type of data. Must be either <code>'forehead'</code> or <code>'psg'</code>.</li>
                <li><code>output_dir</code> (str): The path to the directory where results will be saved.</li>
                <li><code>input_file</code> (str, optional): The full path to the input EDF file. Required if not providing data as a NumPy array.</li>
                <li><code>data</code> (np.ndarray, optional): An in-memory NumPy array of the EEG/PSG data. If you use this, <code>input_file</code> should be <code>None</code>.</li>
                <li><code>model_name</code> (str, optional): The name of the model to use. If not provided, a default model will be selected.</li>
                <li><strong>For PSG data from NumPy array:</strong>
                    <ul>
                        <li><code>sfreq</code> (float): The sampling frequency of the data.</li>
                        <li><code>ch_names</code> (list of str): A list of channel names.</li>
                    </ul>
                </li>
            </ul>

            <h4><code>scorer.score(...)</code> Method</h4>
            <p>This method runs the scoring process. It takes one optional argument:</p>
            <ul>
                <li><code>plot</code> (bool, optional): If <code>True</code>, a graph will be generated. Defaults to <code>False</code>.</li>
            </ul>
            <p><strong>Returns:</strong></p>
            <p>The method returns a tuple containing two NumPy arrays:</p>
            <ol>
                <li><strong>hypnogram</strong> (<code>numpy.ndarray</code>): A 1D array of integers representing the sleep stage for each 30-second epoch. See the <a href="#understanding-results">Sleep Stage Key</a> for the meaning of each integer.</li>
                <li><strong>probabilities</strong> (<code>numpy.ndarray</code>): A 2D array of shape (n_epochs, n_classes). Each row corresponds to an epoch, and each column contains the model's predicted probability for a specific sleep stage.</li>
            </ol>

            <h3>Example 1: Scoring a PSG File</h3>
            <p>This example shows how to score a single PSG recording from an EDF file.</p>
            <pre>
import NIDRA

# Initialize the scorer
scorer = NIDRA.scorer(
    scorer_type='psg',
    input_file='/path/to/your/data/sleep_recording.edf',
    output_dir='/path/to/your/output',
    model_name='u-sleep-nsrr-2024'
)

# Run scoring
hypnogram, probabilities = scorer.score(plot=True)

</pre>

            <h3>Example 2: Scoring In-Memory NumPy Data</h3>
            <p>You can also score data that you already have in memory as a NumPy array. This is useful for real-time applications or custom data loading pipelines. When scoring PSG data from an array, you must provide the sampling frequency (<code>sfreq</code>). Providing channel names is recommended but optional; if not provided, they will be auto-generated. All channels are then assumed to contain EEG data.</p>
            <pre>
import NIDRA
import numpy as np

# Create some dummy PSG data
sfreq = 256
ch_names = ['F3-A2', 'C4-A1', 'O2-A1', 'EOG-L']
n_samples = sfreq * 60 * 60  # 1 hour of data
dummy_data = np.random.randn(len(ch_names), n_samples)

scorer = NIDRA.scorer(
    scorer_type='psg',
    output_dir='/path/to/numpy_psg_output',
    data=dummy_data,
    sfreq=sfreq
)
hypnogram, probabilities = scorer.score()

</pre>
            <h3>Example 3: Batch Processing a Study</h3>
            <p>For batch processing, NIDRA provides a convenient <code>batch_scorer</code>. This function automatically discovers all valid recordings in the subdirectories of your input path, mirroring the behavior of the GUI. This is the recommended way to process a full study. Please see the <a href="#preparing-data">Preparing Your Data</a> section for details on how to structure your study directory.</p>
            <pre>
import NIDRA

batch = NIDRA.batch_scorer(
    input_dir='/path/to/your/study_data',
    output_dir='/path/to/your/study_output',
    scorer_type='forehead',  # or 'psg'
    model_name='ez6moe'
)

batch.score()

</pre>
            <p>This simplified approach removes the need to manually loop through directories and handle file paths, making your analysis scripts cleaner and more reliable.</p>
        </section>

        <section id="how-to-cite">
            <h2>How to Cite NIDRA</h2>
            <p>If you use NIDRA in your research, please cite both the NIDRA software itself and the paper for the specific model you used.</p>
            <h3>1. Citing the NIDRA Software</h3>
            <p>Please cite this repository to ensure reproducibility:</p>
            <pre>
Zerr, P. (2025). NIDRA: super simple sleep scoring. GitHub. https://github.com/paulzerr/nidra
</pre>
            <h3>2. Citing the Scoring Model</h3>
            <p><strong>If you used the ez6 or ez6moe models:</strong></p>
            <pre>
Coon WG, Zerr P, Milsap G, et al. (2025). "ezscore-f: A Set of Freely Available, Validated Sleep Stage Classifiers for Forehead EEG." bioRxiv. doi: 10.1101/2025.06.02.657451.
</pre>
            <p><strong>If you used the u-sleep-nsrr-2024 model:</strong></p>
            <p>Please cite the original U-Sleep paper and the SLEEPYLAND paper for the re-trained model weights:</p>
            <pre>
Perslev, M., et al. (2021). "U-Sleep: resilient high-frequency sleep staging." NPJ digital medicine.
Rossi, A. D., et al. (2025). "SLEEPYLAND: trust begins with fair evaluation of automatic sleep staging models." arXiv preprint.
</pre>
        </section>

        <section id="faq">
            <h2>FAQ & Troubleshooting</h2>
            <h3>Installation Issues</h3>
            <p><strong>Q: I'm having trouble installing with pip. What can I do?</strong><br>
            A: Installation problems can be frustrating, but they are often solvable. Here are a few common troubleshooting steps:
            <ul>
                <li><strong>1. Update Core Packages:</strong> Ensure you have the latest versions of pip, setuptools, and wheel, as outdated versions can cause issues. You can update them by running:
                    <pre><code>pip install --upgrade pip setuptools wheel</code></pre>
                </li>
                <li><strong>2. Use a Clean Virtual Environment:</strong> Conflicts with other installed packages are a common source of errors. Creating a fresh virtual environment ensures that NIDRA's dependencies are installed in an isolated space. If you are still having issues, try creating a new environment from scratch.</li>
                <li><strong>3. Try Installing with Conda:</strong> If pip continues to fail, installing NIDRA via a Conda environment can be a more reliable alternative. Conda's package management is often better at resolving complex dependencies. Follow the Conda installation instructions in the <a href="#installation">Installation</a> section.</li>
            </ul></p>
            <h3>GUI Issues</h3>
            <p><strong>Q: The GUI window is not appearing when I run <code>nidra</code>.</strong><br>
            A: Check the terminal for any error messages. This could be due to a missing dependency. Try reinstalling NIDRA in a clean virtual environment.</p>
            <p><strong>Q: Why is the "Run" button greyed out?</strong><br>
            A: The "Run" button is disabled until you have selected a valid Input Directory.</p>
            <h3>Scoring Errors</h3>
            <p><strong>Q: I got an error about "missing channels" or "could not find required channels".</strong><br>
            A: This is a common error that occurs when the channel labels in your EDF file do not match what the model expects, or when you've selected the wrong "Data Source". For example, selecting "PSG" for a forehead EEG file will cause this error. Double-check your data source selection and ensure your EDF channel labels are standard.</p>
            <p><strong>Q: The scoring process is very slow.</strong><br>
            A: Sleep scoring is computationally intensive, but a typical overnight recording should take less than a minute on modern hardware. If it is taking much longer, ensure no other resource-heavy processes are running on your computer.</p>
            <h3>General Questions</h3>
            <p><strong>Q: Can I trust the results?</strong><br>
            A: The models in NIDRA are validated and perform at a level comparable to human experts. However, like any automated algorithm, they are not perfect. It is always good practice to visually inspect the generated hypnogram plot for any obvious anomalies, especially for noisy or unusual recordings.</p>
        </section>

        <section id="attribution">
            <h2>Attribution</h2>
            <p>ez6 and ez6moe models were developed by Coon et al., see:
            <br>Coon WG, Zerr P, Milsap G, Sikder N, Smith M, Dresler M, Reid M.
            <br>"ezscore-f: A Set of Freely Available, Validated Sleep Stage Classifiers for Forehead EEG."
            <br><a href="https://www.biorxiv.org/content/10.1101/2025.06.02.657451v1">https://www.biorxiv.org/content/10.1101/2025.06.02.657451v1</a>
            <br><a href="https://github.com/coonwg1/ezscore">github.com/coonwg1/ezscore</a></p>
            
            <p>U-Sleep models were developed by  Perslev et al., see:
            <br>Perslev, M., Darkner, S., Kempfner, L., Nikolic, M., Jennum, P. J., & Igel, C. (2021).
            <br>U-Sleep: resilient high-frequency sleep staging. NPJ digital medicine
            <br><a href="https://www.nature.com/articles/s41746-021-00440-5">https://www.nature.com/articles/s41746-021-00440-5</a>
            <br><a href="https://github.com/perslev/U-Time">https://github.com/perslev/U-Time</a></p>

            <p>The U-Sleep model weights used in this repo were re-trained by Rossi et al., see:
            <br>Rossi, A. D., Metaldi, M., Bechny, M., Filchenko, I., van der Meer, J., Schmidt, M. H., ... & Fiorillo, L. (2025).
            <br>SLEEPYLAND: trust begins with fair evaluation of automatic sleep staging models. arXiv preprint arXiv:2506.08574.
            <br><a href="https://arxiv.org/abs/2506.08574v1">https://arxiv.org/abs/2506.08574v1</a></p>
        </section>

        <section id="license">
            <h2>License</h2>
            <p>This project is licensed under the MIT License. See the LICENSE file for details.</p>
        </section>

        <section id="contact">
            <h2>Contact</h2>
            <p>For questions, bug reports, or feedback, please contact Paul Zerr at <a href="mailto:zerr.paul@gmail.com">zerr.paul@gmail.com</a>.</p>
        </section>

    </main>
</body>
</html>
