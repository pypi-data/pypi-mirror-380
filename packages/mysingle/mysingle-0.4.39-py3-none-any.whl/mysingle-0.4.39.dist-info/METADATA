Metadata-Version: 2.4
Name: mysingle
Version: 0.4.39
Summary: Common library for MySingle services
Author-email: Dan Kim <daniel@mysingle.io>
Requires-Python: >=3.12
Requires-Dist: beanie>=1.25.0
Requires-Dist: fastapi>=0.116.1
Requires-Dist: httpx>=0.25.0
Requires-Dist: motor>=3.5.0
Requires-Dist: prometheus-client>=0.19.0
Requires-Dist: pydantic-settings>=2.2.1
Requires-Dist: pydantic>=2.7.0
Requires-Dist: pydantic[email]>=2.7.0
Requires-Dist: pyjwt>=2.10.1
Requires-Dist: redis>=6.4.0
Provides-Extra: build
Requires-Dist: build>=1.0.0; extra == 'build'
Requires-Dist: twine>=4.0.0; extra == 'build'
Provides-Extra: dev
Requires-Dist: mypy>=1.17.0; extra == 'dev'
Requires-Dist: pre-commit>=3.0.0; extra == 'dev'
Requires-Dist: pytest-asyncio>=0.24.0; extra == 'dev'
Requires-Dist: pytest-cov>=4.0.0; extra == 'dev'
Requires-Dist: pytest>=8.4.1; extra == 'dev'
Requires-Dist: ruff>=0.4.0; extra == 'dev'
Description-Content-Type: text/markdown

# MySingle

**MySingle í”Œë«í¼ì„ ìœ„í•œ í†µí•© Python ë¼ì´ë¸ŒëŸ¬ë¦¬** - ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ SaaS í”Œë«í¼ì„ ìœ„í•œ ì¸ì¦/ì¸ê°€, ë°ì´í„° ëª¨ë¸, ë³´ì•ˆ, API êµ¬ì„±ìš”ì†Œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

[![Build Status](https://github.com/Br0therDan/mysingle-pack/workflows/Build%20and%20Publish/badge.svg)](https://github.com/Br0therDan/mysingle-pack/actions)
[![PyPI version](https://badge.fury.io/py/mysingle.svg)](https://badge.fury.io/py/mysingle)
[![Python Version](https://img.shields.io/pypi/pyversions/mysingle.svg)](https://pypi.org/project/mysingle/)

> **ğŸ“¢ v2.5.0 ì—…ë°ì´íŠ¸ (2025.09.25)**: ëª©ì ì„± ê¸°ë°˜ ëª¨ë“ˆ êµ¬ì¡°ë¡œ ì™„ì „ ì¬ì„¤ê³„! ë” ì§ê´€ì ì´ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ 6ê°œ í•µì‹¬ ëª¨ë“ˆë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸš€ ì„¤ì¹˜ ë° ê¸°ë³¸ ì‚¬ìš©ë²•

### ì„¤ì¹˜

```bash
pip install mysingle
# ë˜ëŠ”
uv add mysingle
```

### ìƒˆë¡œìš´ ëª¨ë“ˆ êµ¬ì¡° (v2.5.0)

MySingleì€ ì´ì œ **ëª©ì ì„± ê¸°ë°˜ 6ê°œ ëª¨ë“ˆ**ë¡œ êµ¬ì„±ë˜ì–´ ë” ì§ê´€ì ì´ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤:

```
mysingle/
â”œâ”€â”€ ğŸ—ï¸ core/          # í•µì‹¬ ì„¤ì •, ë¡œê¹…, ì˜ˆì™¸ ì²˜ë¦¬
â”œâ”€â”€ ğŸ“Š data/           # ë°ì´í„°ë² ì´ìŠ¤, ëª¨ë¸, CRUD
â”œâ”€â”€ ğŸ” auth/           # í†µí•© ì¸ì¦/ì¸ê°€ (IAM + RBAC)
â”œâ”€â”€ ğŸ›¡ï¸ security/       # ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´, ê°€ë“œë ˆì¼
â”œâ”€â”€ ğŸŒ services/       # ì™¸ë¶€ ì„œë¹„ìŠ¤ í´ë¼ì´ì–¸íŠ¸
â””â”€â”€ âš¡ api/            # FastAPI ì•± íŒ©í† ë¦¬, ë¯¸ë“¤ì›¨ì–´
```

### ê¸°ë³¸ ì‚¬ìš© ì˜ˆì œ

```python
# ìƒˆë¡œìš´ êµ¬ì¡°ì—ì„œ ê°„ë‹¨í•œ import
from mysingle import (
    # ğŸ—ï¸ Core: ì„¤ì •ê³¼ ë¡œê¹…
    CommonSettings, get_logger, setup_logging,

    # ğŸ“Š Data: ëª¨ë¸ê³¼ CRUD
    BaseDoc, BaseResponseSchema, BaseCRUDService,

    # ğŸ” Auth: í†µí•© ì¸ì¦/ì¸ê°€
    UnifiedIAMClient, require_permission, get_access_context,

    # âš¡ API: FastAPI í†µí•©
    create_fastapi_app, PrometheusMiddleware,

    # ğŸ›¡ï¸ Security: ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´
    SecurityMiddleware
)

# MongoDB ë„íë¨¼íŠ¸ ëª¨ë¸
class UserDocument(BaseDoc):
    username: str
    email: str

    class Settings:
        name = "users"
        indexes = [("email", 1)]

# API ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
class UserResponse(BaseResponseSchema):
    username: str
    email: str

# í†µí•© IAM í´ë¼ì´ì–¸íŠ¸
iam = UnifiedIAMClient()
user_info = await iam.verify_token(token)

# ê¶Œí•œ í™•ì¸ ë°ì½”ë ˆì´í„°
@require_permission("users", "create")
async def create_user_logic(request, data):
    return await user_service.create(data)
```

## ğŸ“¦ ì£¼ìš” ê¸°ëŠ¥ (ëª¨ë“ˆë³„)

### âš¡ API ëª¨ë“ˆ - FastAPI ì•± íŒ©í† ë¦¬ (`create_fastapi_app`)

ëª¨ë“  ë¯¸ë“¤ì›¨ì–´ì™€ ì„¤ì •ì´ í†µí•©ëœ FastAPI ì•±ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.

```python
from mysingle import create_fastapi_app

# ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì•± ìƒì„±
app = create_fastapi_app(
    title="My Service",
    version="1.0.0",
    enable_auth=True,         # ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ í™œì„±í™”
    enable_prometheus=True,   # ëª¨ë‹ˆí„°ë§ í™œì„±í™”
    enable_cors=True,         # CORS ì„¤ì •
    public_paths=["/health", "/docs"]  # ì¸ì¦ ì œì™¸ ê²½ë¡œ
)

# ê³ ê¸‰ ì„¤ì •
app = create_fastapi_app(
    title="Advanced Service",
    description="ìƒì„¸í•œ ì„œë¹„ìŠ¤ ì„¤ëª…",
    version="2.0.0",

    # ë³´ì•ˆ ì„¤ì •
    enable_auth=True,
    enable_security_headers=True,

    # ëª¨ë‹ˆí„°ë§ ì„¤ì •
    enable_prometheus=True,
    enable_health_check=True,

    # CORS ì„¤ì •
    enable_cors=True,
    cors_origins=["https://app.mysingle.io"],
    cors_methods=["GET", "POST", "PUT", "DELETE"],

    # ê³µê°œ ê²½ë¡œ (ì¸ì¦ ë¶ˆí•„ìš”)
    public_paths=[
        "/health",
        "/metrics",
        "/docs",
        "/openapi.json"
    ]
)

# ì•± íŒ©í† ë¦¬ëŠ” ë‹¤ìŒì„ ìë™ ì„¤ì •í•©ë‹ˆë‹¤:
# - Authentication ë¯¸ë“¤ì›¨ì–´ (JWT í† í° ê²€ì¦)
# - Tenant isolation ë¯¸ë“¤ì›¨ì–´ (ë©€í‹°í…Œë„ŒíŠ¸ ê²©ë¦¬)
# - Prometheus metrics ë¯¸ë“¤ì›¨ì–´ (ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§)
# - CORS ë¯¸ë“¤ì›¨ì–´ (í¬ë¡œìŠ¤ì˜¤ë¦¬ì§„ ìš”ì²­)
# - Security headers ë¯¸ë“¤ì›¨ì–´ (ë³´ì•ˆ í—¤ë”)
# - Exception handlers (í†µí•© ì—ëŸ¬ ì²˜ë¦¬)
# - Health check endpoint (/health)
```

### ğŸ” Auth ëª¨ë“ˆ - í†µí•© IAM í´ë¼ì´ì–¸íŠ¸ (`UnifiedIAMClient`)

MySingle IAM ì„œë¹„ìŠ¤ì™€ì˜ ëª¨ë“  ìƒí˜¸ì‘ìš©ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

```python
from mysingle import UnifiedIAMClient, get_iam_client, close_global_iam_client

# í´ë¼ì´ì–¸íŠ¸ ìƒì„± ë°©ë²•ë“¤
# 1. ì§ì ‘ ìƒì„±
iam = UnifiedIAMClient(
    base_url="http://iam-service:8002",
    timeout=30.0,
    max_retries=3
)

# 2. ê¸€ë¡œë²Œ ì‹±ê¸€í†¤ ì‚¬ìš© (ê¶Œì¥)
iam = await get_iam_client()

# ì¸ì¦ ê´€ë ¨
login_response = await iam.login(UserLogin(email="user@example.com", password="password"))
user_info = await iam.verify_token(token)
refresh_response = await iam.refresh_token(refresh_token)
await iam.logout(token)

# ê¶Œí•œ í™•ì¸
permission_result = await iam.check_permission(
    user_id="user123",
    resource="ledger:journals",
    action="create",
    tenant_id="tenant456"
)

# ë°°ì¹˜ ê¶Œí•œ í™•ì¸
permissions = [
    {"resource": "ledger:journals", "action": "read"},
    {"resource": "ledger:accounts", "action": "write"}
]
results = await iam.batch_check_permissions("user123", permissions, "tenant456")

# ì‚¬ìš©ì ê´€ë¦¬
user = await iam.get_user("user123", auth_token)
current_user = await iam.get_current_user(auth_token)
updated_user = await iam.update_user("user123", UserUpdate(name="New Name"), auth_token)

# ì„¸ì…˜ ê´€ë¦¬
sessions = await iam.get_user_sessions(auth_token=auth_token)
current_session = await iam.get_current_session(auth_token)
await iam.deactivate_session("session123", auth_token)
await iam.deactivate_all_sessions(auth_token)

# ë¦¬ì†ŒìŠ¤ ì •ë¦¬
await iam.close()

# ê¸€ë¡œë²Œ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬
await close_global_iam_client()
```

### ï¿½ Auth ëª¨ë“ˆ - RBAC ì‹œìŠ¤í…œ (`mysingle.auth`)

í•¨ìˆ˜ ë ˆë²¨ì—ì„œ ê¶Œí•œ í™•ì¸ê³¼ ê°ì‚¬ ë¡œê¹…ì„ ì œê³µí•©ë‹ˆë‹¤.

```python
from mysingle.auth import require_permission, audit_log

# ê¶Œí•œ í™•ì¸ ë°ì½”ë ˆì´í„° (FastAPI ì™¸ë¶€ í•¨ìˆ˜ì—ì„œ)
@require_permission("ledger:journals", "create")
async def create_journal_logic(request: Request, data: JournalCreate):
    # JWT í† í°ì—ì„œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì/í…Œë„ŒíŠ¸ ì¶”ì¶œ ë° ê¶Œí•œ í™•ì¸
    # ì§€ëŠ¥ì  ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
    return await journal_service.create(data)

# ê°ì‚¬ ë¡œê¹… ë°ì½”ë ˆì´í„°
@audit_log("create", "journals")
async def create_journal(request: Request, data: JournalCreate):
    # ëª¨ë“  ì‘ì—…ì„ ìë™ìœ¼ë¡œ ê°ì‚¬ ì¶”ì ì— ê¸°ë¡
    return await journal_service.create(data)

# ë‘ ë°ì½”ë ˆì´í„° í•¨ê»˜ ì‚¬ìš© (ê¶Œì¥)
@require_permission("ledger:journals", "create")
@audit_log("create", "journals")
async def secure_create_journal(request: Request, data: JournalCreate):
    # ê¶Œí•œ í™•ì¸ + ê°ì‚¬ ë¡œê¹…ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
    return await journal_service.create(data)
```

### ğŸ›¡ï¸ ê°€ë“œë ˆì¼ ì‹œìŠ¤í…œ (`mysingle.guardrails`)

FastAPI ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•œ í¬ê´„ì ì¸ ë³´ì•ˆ ê°€ë“œë ˆì¼ ì‹œìŠ¤í…œì„ ì œê³µí•©ë‹ˆë‹¤.

#### ì£¼ìš” ì»´í¬ë„ŒíŠ¸

- **ğŸ” ê¶Œí•œ í™•ì¸**: JWT í† í° ê²€ì¦ + RBAC ê¶Œí•œ í™•ì¸ + ë©€í‹°ë ˆì´ì–´ ìºì‹±
- **ğŸ†• í”Œë«í¼ ì‚¬ìš©ì ì§€ì›**: JWT ê¸°ë°˜ í”Œë«í¼/í…Œë„ŒíŠ¸ ì‚¬ìš©ì êµ¬ë¶„ (2025.09.23 ì¶”ê°€)**
- **ğŸš¦ Rate Limiting**: ì‚¬ìš©ì/í…Œë„ŒíŠ¸ë³„ ìš”ì²­ ë¹ˆë„ ì œí•œ ë° ëª¨ë‹ˆí„°ë§
- **ğŸ›¡ï¸ PII ë³´í˜¸**: ê°œì¸ì •ë³´ ìë™ ê°ì§€ ë° ë§ˆìŠ¤í‚¹ (ì´ë©”ì¼, ì „í™”ë²ˆí˜¸, ì£¼ë¯¼ë²ˆí˜¸ ë“±)
- **ğŸ“‹ ê°ì‚¬ ë¡œê¹…**: ëª¨ë“  ë³´ì•ˆ ì´ë²¤íŠ¸ ì¶”ì  ë° ê·œì • ì¤€ìˆ˜

#### ê¸°ë³¸ ì‚¬ìš©ë²•

```python
from mysingle.guardrails import (
    # ğŸ†• JWT ê¸°ë°˜ EndpointAccessType ì‹œìŠ¤í…œ (2025.09.23 ì™„ì „ êµ¬í˜„)
    EndpointAccessType,         # ì ‘ê·¼ ì œì–´ íƒ€ì… (TENANT_ONLY, PLATFORM_ADMIN, HYBRID)
    get_access_context,         # í†µí•©ëœ ì ‘ê·¼ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
    check_platform_permission,  # í”Œë«í¼ ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
    check_permission,           # ì§ì ‘ ê¶Œí•œ í™•ì¸
    create_permission_dependency, # ê¶Œí•œ ì˜ì¡´ì„± ìƒì„±

    # ê¸°íƒ€ ê°€ë“œë ˆì¼ ê¸°ëŠ¥
    RateLimiter,               # Rate Limiting
    mask_pii_quick,            # ë¹ ë¥¸ PII ë§ˆìŠ¤í‚¹
    PIIMasker,                 # ê³ ê¸‰ PII ë³´í˜¸
    AuditLogger                # ê°ì‚¬ ë¡œê¹…
)

# ğŸ†• EndpointAccessType ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ê¶Œì¥ ë°©ì‹)
@router.get("/journals")
async def list_journals(
    # í…Œë„ŒíŠ¸ ì „ìš© ì ‘ê·¼ - ê°€ì¥ ì¼ë°˜ì ì¸ íŒ¨í„´
    context = Depends(get_access_context(EndpointAccessType.TENANT_ONLY))
):
    """í…Œë„ŒíŠ¸ì˜ ë¶„ê°œ ëª©ë¡ ì¡°íšŒ"""
    return await journal_service.list_by_tenant(context.tenant_id)

@router.get("/admin/tenants")
async def list_all_tenants(
    # í”Œë«í¼ ê´€ë¦¬ì ì „ìš© ì ‘ê·¼
    context = Depends(get_access_context(EndpointAccessType.PLATFORM_ADMIN))
):
    """ëª¨ë“  í…Œë„ŒíŠ¸ ì¡°íšŒ - í”Œë«í¼ ê´€ë¦¬ìë§Œ ê°€ëŠ¥"""
    return await tenant_service.list_all()

@router.get("/reports/analytics")
async def get_analytics(
    tenant_id: str = None,
    # í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ - í…Œë„ŒíŠ¸ ì‚¬ìš©ìëŠ” ìì‹ ë§Œ, í”Œë«í¼ ê´€ë¦¬ìëŠ” ëª¨ë“  í…Œë„ŒíŠ¸
    context = Depends(get_access_context(EndpointAccessType.HYBRID))
):
    """ë¶„ì„ ë³´ê³ ì„œ ì¡°íšŒ"""
    if context.is_platform_user:
        # í”Œë«í¼ ê´€ë¦¬ì: ëª¨ë“  í…Œë„ŒíŠ¸ ë˜ëŠ” íŠ¹ì • í…Œë„ŒíŠ¸
        target_tenant = tenant_id or "all"
    else:
        # í…Œë„ŒíŠ¸ ì‚¬ìš©ì: ìì‹ ì˜ í…Œë„ŒíŠ¸ë§Œ
        target_tenant = context.tenant_id

    return await analytics_service.get_report(target_tenant)

# ğŸ­ CRUD Factoryì™€ EndpointAccessType í†µí•©
from mysingle import create_crud_router

# í…Œë„ŒíŠ¸ ì „ìš© CRUD
user_router = create_crud_router(
    service=user_service,
    access_type=EndpointAccessType.TENANT_ONLY  # í…Œë„ŒíŠ¸ ê²©ë¦¬ ë³´ì¥
)

# í”Œë«í¼ ê´€ë¦¬ì ì „ìš© CRUD
admin_router = create_crud_router(
    service=admin_service,
    access_type=EndpointAccessType.PLATFORM_ADMIN  # í”Œë«í¼ ê¶Œí•œ í•„ìš”
)

# ê°œë³„ ê¶Œí•œ í™•ì¸ ì˜ˆì‹œ
has_permission = await check_permission(
    user_id="user123",
    resource="journals",
    action="read",
    tenant_id="tenant456"
)

# í”Œë«í¼ ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
can_access_tenant = await check_platform_permission(
    user_id="platform_admin",
    tenant_id="tenant456"
)
```

#### ğŸ“– ìƒì„¸ ê°€ì´ë“œ

ë³´ì•ˆ ì‹œìŠ¤í…œì˜ ëª¨ë“  ê¸°ëŠ¥ê³¼ ê³ ê¸‰ ì‚¬ìš©ë²•ì€ **[ë³´ì•ˆ ê°€ì´ë“œ](docs/SECURITY_GUIDE.md)**ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

- ğŸ” [ì¸ì¦/ì¸ê°€ íŒ¨í„´](docs/SECURITY_GUIDE.md#-ì¸ê°€-authorization---rbac)
- ğŸ›¡ï¸ [í…Œë„ŒíŠ¸ ê²©ë¦¬](docs/SECURITY_GUIDE.md#-í…Œë„ŒíŠ¸-ê²©ë¦¬-multi-tenancy)
- ğŸ“Š [ì„±ëŠ¥ ìµœì í™”](docs/SECURITY_GUIDE.md#-ì„±ëŠ¥-ëª¨ë‹ˆí„°ë§)
- ğŸ­ [CRUD Factory í†µí•©](src/mysingle/guardrails/README.md#-crud-factory-í†µí•©)
- ï¿½ [ê°œë³„ í•¨ìˆ˜ ì‚¬ìš©](src/mysingle/guardrails/README.md#-ê°œë³„-í•¨ìˆ˜-ì‚¬ìš©)
- ï¿½ [ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](src/mysingle/guardrails/README.md#-í—¤ë”-ê¸°ë°˜ì—ì„œ-jwt-ê¸°ë°˜ìœ¼ë¡œ-ë§ˆì´ê·¸ë ˆì´ì…˜)
- ğŸ›¡ï¸ [ë³´ì•ˆ ê¸°ëŠ¥](src/mysingle/guardrails/README.md#ï¸-ë³´ì•ˆ-ê¸°ëŠ¥)

### ğŸ“„ ë² ì´ìŠ¤ ëª¨ë¸ ì‹œìŠ¤í…œ

#### BaseDoc (MongoDB ë„íë¨¼íŠ¸)

```python
from mysingle import BaseDoc

class UserDocument(BaseDoc):
    username: str
    email: str
    full_name: Optional[str] = None

    class Settings:
        name = "users"  # MongoDB ì»¬ë ‰ì…˜ëª…
        indexes = [
            ("email", 1),              # ë‹¨ì¼ ì¸ë±ìŠ¤
            ("tenant_id", "email"),    # ë³µí•© ì¸ë±ìŠ¤
            ("created_at", -1)         # ë‚´ë¦¼ì°¨ìˆœ ì¸ë±ìŠ¤
        ]

# BaseDocì´ ìë™ ì œê³µí•˜ëŠ” í•„ë“œë“¤:
# - tenant_id: Optional[str] = None      # ë©€í‹°í…Œë„ŒíŠ¸ ê²©ë¦¬
# - created_at: datetime                 # ìƒì„± ì‹œê°„ (UTC)
# - updated_at: Optional[datetime]       # ìˆ˜ì • ì‹œê°„
# - idempotency_key: Optional[str]       # ì¤‘ë³µ ìš”ì²­ ë°©ì§€
```

#### BaseResponseSchema (API ì‘ë‹µ)

```python
from mysingle import BaseResponseSchema

class UserResponse(BaseResponseSchema):
    username: str
    email: str
    full_name: Optional[str] = None

# BaseResponseSchemaê°€ ìë™ ì œê³µí•˜ëŠ” í•„ë“œë“¤:
# - id: PydanticObjectId               # MongoDB ObjectId
# - tenant_id: Optional[str]           # í…Œë„ŒíŠ¸ ID
# - created_at: Optional[datetime]     # ìƒì„± ì‹œê°„
# - updated_at: Optional[datetime]     # ìˆ˜ì • ì‹œê°„

# JSON ì‘ë‹µ ì˜ˆì‹œ:
# {
#   "id": "507f1f77bcf86cd799439011",
#   "username": "john_doe",
#   "email": "john@example.com",
#   "tenant_id": "tenant123",
#   "created_at": "2024-01-15T10:30:00Z"
# }
```

#### BaseCRUDService (ì„œë¹„ìŠ¤ ë ˆì´ì–´) & CRUD Factory

**ğŸ†• í”Œë«í¼ ì‚¬ìš©ì ì§€ì› (2025.09.23 ì¶”ê°€)**

```python
from mysingle import BaseCRUDService, create_crud_router

# ê¸°ì¡´ ë°©ì‹: ê°•ì œ í…Œë„ŒíŠ¸ ê²©ë¦¬
user_router = create_crud_router(
    model=UserDocument,
    create_schema=UserCreate,
    update_schema=UserUpdate,
    response_schema=UserResponse,
    resource_name="users",
    require_tenant_isolation=True,  # ê¸°ë³¸ê°’ (ê¸°ì¡´ ë™ì‘)
    tags=["Users"]
)

# ğŸ†• ìƒˆë¡œìš´ ë°©ì‹: í”Œë«í¼ ì‚¬ìš©ì ì§€ì›
platform_router = create_crud_router(
    model=PlatformDocument,
    create_schema=PlatformCreate,
    update_schema=PlatformUpdate,
    response_schema=PlatformResponse,
    resource_name="platform-resources",
    require_tenant_isolation=False,  # í”Œë«í¼ ì‚¬ìš©ì í—ˆìš©
    tags=["Platform"]
)

# CRUD Factory ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ:
# - JWT í† í°ì—ì„œ is_platform_user í”Œë˜ê·¸ í™•ì¸
# - í”Œë«í¼ ì‚¬ìš©ì: tenant_id="platform"ìœ¼ë¡œ ì²˜ë¦¬
# - í…Œë„ŒíŠ¸ ì‚¬ìš©ì: ê¸°ì¡´ tenant_id ì‚¬ìš©
# - ìœ ì—°í•œ ê¶Œí•œ ì²´ê³„ ì§€ì› (platform:* vs tenant:*)
```

**ê¸°ë³¸ CRUD ì‘ì—…**

```python
# CRUD ì„œë¹„ìŠ¤ ì§ì ‘ ì‚¬ìš©
crud_service = BaseCRUDService(
    model=UserDocument,
    resource_name="users"
)

# ê¸°ë³¸ CRUD ì‘ì—…
user = await crud_service.create(
    data={"username": "john", "email": "john@example.com"},
    tenant_id="tenant123"
)

users = await crud_service.find_many(
    filters={"active": True},
    tenant_id="tenant123",
    page=1,
    size=20
)

# ğŸ†• í”Œë«í¼ ì‚¬ìš©ì ì§€ì› CRUD
platform_user = await crud_service.create(
    data={"username": "admin", "email": "admin@platform.com"},
    tenant_id="platform",  # í”Œë«í¼ ì‚¬ìš©ì
    is_platform=True
)

app.include_router(user_router, prefix="/api/v1/users")
app.include_router(platform_router, prefix="/api/v1/platform")
```

### âš ï¸ ì˜ˆì™¸ ì²˜ë¦¬ ì‹œìŠ¤í…œ

ì˜ˆì™¸ëŠ” ë³„ë„ ëª¨ë“ˆì—ì„œ importí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

```python
from mysingle.exceptions import (
    # ì¼ë°˜ API ì˜ˆì™¸
    APIError,
    ValidationError,
    NotFoundError,
    ConflictError,
    InternalServerError,

    # RBAC ê´€ë ¨ ì˜ˆì™¸
    PermissionDeniedError,
    RBACError,
    RBACTimeoutError,
    RBACServiceUnavailableError,

    # ì˜ˆì™¸ í•¸ë“¤ëŸ¬
    register_exception_handlers,
    http_exception_handler,
    api_error_handler,
    general_exception_handler
)

# FastAPI ì•±ì— ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ë“±ë¡
app = FastAPI()
register_exception_handlers(app)

# ìˆ˜ë™ ì˜ˆì™¸ ì²˜ë¦¬
try:
    permission_result = await iam.check_permission(user_id, resource, action)
    if not permission_result.allowed:
        raise PermissionDeniedError("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
except RBACTimeoutError:
    raise HTTPException(status_code=503, detail="ê¶Œí•œ í™•ì¸ ì„œë¹„ìŠ¤ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼")
except RBACServiceUnavailableError:
    raise HTTPException(status_code=503, detail="ê¶Œí•œ í™•ì¸ ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€")

# ì»¤ìŠ¤í…€ ì˜ˆì™¸ ë°œìƒ
raise APIError(
    status_code=400,
    error="INVALID_REQUEST",
    message="ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤",
    details={"field": "email", "issue": "invalid format"}
)
```

### ğŸ”§ ì„¤ì • ê´€ë¦¬ (`CommonSettings`)

```python
from mysingle import CommonSettings, settings

# ê¸€ë¡œë²Œ ì„¤ì • ê°ì²´ ì‚¬ìš©
print(f"Service: {settings.SERVICE_NAME}")
print(f"Environment: {settings.ENVIRONMENT}")
print(f"MongoDB URL: {settings.MONGODB_URL}")

# ì»¤ìŠ¤í…€ ì„¤ì • í´ë˜ìŠ¤
class MyServiceSettings(CommonSettings):
    custom_feature_enabled: bool = True
    api_rate_limit: int = 1000

my_settings = MyServiceSettings()
```

### ğŸ“Š ë¡œê¹… ì‹œìŠ¤í…œ

```python
from mysingle import setup_logging, get_logger

# ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™”
setup_logging(
    service_name="my-service",
    log_level="INFO",
    enable_json=True,      # êµ¬ì¡°í™”ëœ JSON ë¡œê·¸
    enable_correlation=True # ìš”ì²­ ì¶”ì  ID
)

# ë¡œê±° ì‚¬ìš©
logger = get_logger(__name__)

logger.info("ì„œë¹„ìŠ¤ ì‹œì‘ë¨", extra={"version": "1.0.0"})
logger.error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨", extra={"error": str(e)})

# ìë™ ë¡œê·¸ ì»¨í…ìŠ¤íŠ¸ (ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´)
# - request_id: ìš”ì²­ë³„ ê³ ìœ  ID
# - tenant_id: í…Œë„ŒíŠ¸ ID
# - user_id: ì‚¬ìš©ì ID
# - endpoint: API ì—”ë“œí¬ì¸íŠ¸
# - method: HTTP ë©”ì„œë“œ
```

### ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìœ í‹¸ë¦¬í‹°

```python
from mysingle import init_mongo, get_database_name, get_redis_url

# MongoDB ì´ˆê¸°í™”
await init_mongo(
    connection_string="mongodb://localhost:27017",
    database_name="my_service_db"
)

# í…Œë„ŒíŠ¸ë³„ ë°ì´í„°ë² ì´ìŠ¤ëª… ìƒì„±
db_name = get_database_name("my_service", tenant_id="tenant123")
# ê²°ê³¼: "my_service_tenant123"

# Redis URL ìƒì„±
redis_url = get_redis_url()
# í™˜ê²½ë³€ìˆ˜ì—ì„œ REDIS_URL ë˜ëŠ” ê¸°ë³¸ê°’ ë°˜í™˜
```

## ğŸ—ï¸ ì™„ì „í•œ ì„œë¹„ìŠ¤ ì˜ˆì œ

```python
from fastapi import FastAPI, Depends, HTTPException
from typing import Dict, Any, Optional
from mysingle import (
    create_fastapi_app, BaseDoc, BaseResponseSchema,
    UnifiedIAMClient, setup_logging, init_mongo, create_crud_router
)
from mysingle.rbac import require_permission, audit_log
from mysingle.guardrails import (
    get_tenant_id, rate_limit,
    # ğŸ†• í”Œë«í¼ ì‚¬ìš©ì ì§€ì› (2025.09.23 ì¶”ê°€)
    get_tenant_context_from_token,
    is_platform_user_from_token,
    get_optional_tenant_id_from_token
)
from mysingle.exceptions import PermissionDeniedError

# 1. ë¡œê¹… ì„¤ì •
setup_logging(service_name="example-service")

# 2. FastAPI ì•± ìƒì„± (ëª¨ë“  ë¯¸ë“¤ì›¨ì–´ í¬í•¨)
app = create_fastapi_app(
    title="Example Service with Platform Support",
    version="2.0.0",
    enable_auth=True,
    enable_prometheus=True,
    public_paths=["/health", "/docs"]
)

# 3. ë°ì´í„° ëª¨ë¸
class ItemDocument(BaseDoc):
    name: str
    description: str
    price: float

    class Settings:
        name = "items"
        indexes = [("tenant_id", "name")]

class ItemResponse(BaseResponseSchema):
    name: str
    description: str
    price: float

# 4. ğŸ†• í”Œë«í¼ ì‚¬ìš©ì ì§€ì› API ì—”ë“œí¬ì¸íŠ¸
@app.post("/items/flexible", response_model=ItemResponse)
async def create_item_flexible(
    data: dict,
    # í†µí•© ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ (ê¶Œì¥ ë°©ì‹)
    context: Dict[str, Any] = Depends(get_tenant_context_from_token),
    _auth: None = Depends(require_permission("items", "create")),
):
    """í”Œë«í¼ ì‚¬ìš©ìì™€ í…Œë„ŒíŠ¸ ì‚¬ìš©ì ëª¨ë‘ ì§€ì›í•˜ëŠ” ìœ ì—°í•œ ì—”ë“œí¬ì¸íŠ¸"""
    tenant_id = context.get("tenant_id")
    is_platform = context.get("is_platform_user", False)
    user_id = context.get("user_id")

    # Effective Tenant ID ê²°ì •
    effective_tenant_id = "platform" if is_platform else tenant_id

    if not effective_tenant_id:
        raise HTTPException(400, "Invalid authentication context")

    item = ItemDocument(**data, tenant_id=effective_tenant_id)
    await item.save()
    return ItemResponse.model_validate(item, from_attributes=True)

# 5. í”Œë«í¼ ì „ìš© ê´€ë¦¬ ì—”ë“œí¬ì¸íŠ¸
@app.get("/admin/all-items")
async def get_all_items_admin(
    is_platform: bool = Depends(is_platform_user_from_token)
):
    """í”Œë«í¼ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê´€ë¦¬ ì—”ë“œí¬ì¸íŠ¸"""
    if not is_platform:
        raise HTTPException(403, "Platform access required")

    # ëª¨ë“  í…Œë„ŒíŠ¸ì˜ ì•„ì´í…œ ì¡°íšŒ
    all_items = await ItemDocument.find({}).to_list()
    return [ItemResponse.model_validate(item, from_attributes=True) for item in all_items]

# 6. ê¸°ì¡´ ë°©ì‹ (ê°•ì œ í…Œë„ŒíŠ¸ ê²©ë¦¬)
@app.post("/items", response_model=ItemResponse)
async def create_item_legacy(
    data: dict,
    # ê¸°ì¡´ ê°€ë“œë ˆì¼ë“¤
    tenant_id: str = Depends(get_tenant_id),
    _auth: None = Depends(require_permission("items", "create")),
    _rate: None = Depends(rate_limit(max_calls=100, window_seconds=3600))
):
    """ê¸°ì¡´ ë°©ì‹: ê°•ì œ í…Œë„ŒíŠ¸ ê²©ë¦¬"""
    item = ItemDocument(**data, tenant_id=tenant_id)
    await item.save()
    return ItemResponse.model_validate(item, from_attributes=True)

# 7. ğŸ†• CRUD Factory í™œìš© (í”Œë«í¼ ì§€ì›)
flexible_router = create_crud_router(
    model=ItemDocument,
    create_schema=dict,  # ê°„ë‹¨í•œ ì˜ˆì‹œ
    response_schema=ItemResponse,
    resource_name="items",
    require_tenant_isolation=False,  # í”Œë«í¼ ì‚¬ìš©ì í—ˆìš©
    tags=["Flexible Items"]
)

legacy_router = create_crud_router(
    model=ItemDocument,
    create_schema=dict,
    response_schema=ItemResponse,
    resource_name="legacy-items",
    require_tenant_isolation=True,  # ê¸°ì¡´ ë°©ì‹ (ê¸°ë³¸ê°’)
    tags=["Legacy Items"]
)

# ë¼ìš°í„° ë“±ë¡
app.include_router(flexible_router, prefix="/api/v2/items")
app.include_router(legacy_router, prefix="/api/v1/items")

# 8. í•¨ìˆ˜ ë ˆë²¨ ê¶Œí•œ í™•ì¸ + ê°ì‚¬ ë¡œê¹…
@require_permission("items", "delete")
@audit_log("delete", "item")
async def delete_item_logic(request, item_id: str):
    # ìë™ ê¶Œí•œ í™•ì¸ + ê°ì‚¬ ë¡œê¹…
    item = await ItemDocument.get(item_id)
    if not item:
        raise HTTPException(404, "Item not found")
    await item.delete()
    return {"message": "Item deleted"}

# 9. ì•± ì‹œì‘ ì‹œ ì´ˆê¸°í™”
@app.on_event("startup")
async def startup():
    await init_mongo()

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

## ğŸ§ª ê°œë°œ ë° í…ŒìŠ¤íŠ¸

### ê°œë°œ í™˜ê²½ ì„¤ì •

```bash
# ì˜ì¡´ì„± ì„¤ì¹˜
uv sync --dev

# ê°œë°œìš© íŒ¨í‚¤ì§€ ì„¤ì¹˜
uv add --dev pytest pytest-asyncio pytest-cov

# Pre-commit í›… ì„¤ì •
uv run pre-commit install
```

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸
uv run pytest

# ì»¤ë²„ë¦¬ì§€ í¬í•¨
uv run pytest --cov=src/mysingle --cov-report=html

# íŠ¹ì • í…ŒìŠ¤íŠ¸
uv run pytest tests/test_rbac.py -v
```

### ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

```bash
# ë¦°íŒ… ë° í¬ë§·íŒ…
uv run ruff check .
uv run ruff format .

# íƒ€ì… ì²´í¬
uv run mypy src/mysingle

# ë³´ì•ˆ ìŠ¤ìº”
uv run bandit -r src/mysingle
```

## ğŸ“š ë¼ì´ì„¼ìŠ¤

MIT License - ìì„¸í•œ ë‚´ìš©ì€ [LICENSE](LICENSE) íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## ğŸ“ ì§€ì›

- ğŸ“§ Email: support@mysingle.io
- ğŸ“– Documentation: [docs.mysingle.io](https://docs.mysingle.io)
- ğŸ› Issues: [GitHub Issues](https://github.com/Br0therDan/mysingle-pack/issues)
make dev-install     # Install dev dependencies
make setup-hooks     # Setup git hooks

# Quality checks
make test           # Run tests
make lint           # Run linting
make format         # Format code
make type-check     # Run type checking
make quality-check  # Run all quality checks

# Version management
make version-current  # Show current version
make version-patch   # Bump patch version
make version-minor   # Bump minor version
make version-major   # Bump major version

# Publishing
make publish-dry-run # Test build process
make publish-test    # Publish to Test PyPI
make publish         # Full publish to PyPI
```

### Enhanced Build System

This package includes a sophisticated build and deployment system:

```bash
# Automatic version detection and publishing
./scripts/build_publish_enhanced.sh

# Manual version type specification
./scripts/build_publish_enhanced.sh -t patch   # Bug fixes
./scripts/build_publish_enhanced.sh -t minor   # New features
./scripts/build_publish_enhanced.sh -t major   # Breaking changes

# Development options
./scripts/build_publish_enhanced.sh -d         # Dry run
./scripts/build_publish_enhanced.sh -s         # Skip tests
./scripts/build_publish_enhanced.sh -f         # Force publish
```

For detailed information, see [BUILD_GUIDE.md](BUILD_GUIDE.md).

## ğŸ“š Module Documentation

### Unified IAM Client (`mysingle.iam`)

```python
from mysingle import UnifiedIAMClient

# Initialize unified IAM client
iam_client = UnifiedIAMClient()

# Authentication
user_info = await iam_client.verify_token(token)
auth_response = await iam_client.login(username, password)

# Authorization
has_permission = await iam_client.check_permission(
    user_id="user123",
    resource="ledger:accounts",
    action="read",
    tenant_id="tenant456"
)

# User management
users = await iam_client.get_users(tenant_id="tenant456")
user = await iam_client.get_user("user123")
```

### RBAC System (`mysingle.rbac`)

```python
from mysingle.rbac import require_permission, audit_log
from mysingle.exceptions import PermissionDeniedError, RBACTimeoutError

# Function-level permission checking (for non-FastAPI functions)
@require_permission("ledger:journals", "create")
async def create_journal_logic(request: Request, data: JournalCreate):
    # Automatically checks user permissions with caching
    return await journal_service.create(data)

# Audit logging for compliance
@audit_log("create", "journals")
async def create_journal(request: Request, data: JournalCreate):
    # Automatically logs all operations for audit trail
    return await journal_service.create(data)

# Exception handling
try:
    await check_permission(user_id, resource, action)
except PermissionDeniedError:
    raise HTTPException(status_code=403, detail="ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
except RBACTimeoutError:
    raise HTTPException(status_code=503, detail="ê¶Œí•œ í™•ì¸ ì„œë¹„ìŠ¤ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼")
```

### FastAPI Integration (`mysingle.guardrails`)

```python
from mysingle.guardrails import require_permission, get_tenant_id, get_current_user

# FastAPI Dependencies (Recommended for FastAPI endpoints)
@router.post("/journals")
async def create_journal(
    data: JournalCreate,
    tenant_id: str = Depends(get_tenant_id),
    current_user: UserInfo = Depends(get_current_user),
    _auth: None = require_permission("ledger:journals", "create")
):
    """FastAPI ì—”ë“œí¬ì¸íŠ¸ì—ì„œì˜ ê¶Œí•œ í™•ì¸ (ê¶Œì¥ ë°©ì‹)"""
    return await journal_service.create(data, tenant_id, current_user.id)
```

### Base Models (`mysingle.base`)

```python
from mysingle import BaseDoc, BaseResponseSchema

# MongoDB document with tenant isolation
class Account(BaseDoc):
    code: str
    name: str
    account_type: str

    class Settings:
        name = "accounts"
        indexes = [("code", 1), ("tenant_id", 1)]

# API response schema
class AccountResponse(BaseResponseSchema):
    code: str
    name: str
    account_type: str
    # tenant_id, created_at, updated_at automatically included
```

### Authentication Middleware (`mysingle.middleware`)

```python
from fastapi import FastAPI
from mysingle.middleware import AuthMiddleware

app = FastAPI()

# Add authentication middleware with tenant isolation
app.add_middleware(
    AuthMiddleware,
    public_paths=["/health", "/docs"],
    tenant_isolation=True
)
```

### Guardrails (`mysingle.guardrails`)

```python
from mysingle.guardrails import get_tenant_id, mask_pii, check_permission

# Tenant isolation
tenant_id = get_tenant_id(request)

# Privacy protection
safe_data = mask_pii(sensitive_data)

# Permission validation
is_authorized = check_permission(user_id, resource, action)
```

## ğŸ”§ Configuration

### Environment Variables

```bash
# MySingle IAM Service
IAM_SERVICE_URL=http://localhost:8002
IAM_INTERNAL_URL=http://iam-service:8002  # Docker internal

# Database
MONGODB_URL=mongodb://localhost:27017
DATABASE_NAME=mysingle

# JWT Configuration
JWT_SECRET_KEY=your-secret-key-here
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# Multi-tenant Configuration
TENANT_ISOLATION_ENABLED=true
DEFAULT_TENANT_ID=default

# Security
SECURITY_AUDIT_ENABLED=true
RATE_LIMITING_ENABLED=true
```

### Configuration Class

```python
from mysingle.config import settings

# Access configuration values
print(settings.iam_service_url)
print(settings.mongodb_url)
print(settings.jwt_secret_key)
print(settings.tenant_isolation_enabled)
```

## ğŸ—ï¸ Architecture Integration

### MySingle Platform Integration

This package is designed to work seamlessly with the MySingle platform microservices:

- **IAM Service** (`localhost:8002`): Authentication and user management
- **RBAC Service** (`localhost:8010`): Centralized permission management
- **Tenant Service** (`localhost:8001`): Multi-tenant subscription management
- **Ledger Service** (`localhost:8006`): Financial/GL operations

### Multi-Tenant SaaS Architecture

```python
# Automatic tenant isolation in all operations
from mysingle import BaseDoc

class Invoice(BaseDoc):
    number: str
    amount: float
    # tenant_id automatically handled

    class Settings:
        name = "invoices"
        indexes = [("number", 1), ("tenant_id", 1)]

# FastAPI endpoint with automatic tenant isolation
@require_permission("finance:invoices", "create")
async def create_invoice(invoice_data: InvoiceCreate, request: Request):
    # tenant_id extracted automatically from request
    # permissions checked against tenant context
    pass
```

## ğŸ§ª Testing

```bash
# Run all tests
make test

# Run with coverage
uv run pytest --cov=src/mysingle --cov-report=html

# Run specific test file
uv run pytest tests/test_auth.py

# Run with verbose output
uv run pytest -v
```

## ğŸš€ Deployment

### GitHub Actions CI/CD

This package includes automated CI/CD with GitHub Actions:

- **Quality Checks**: Automated testing, linting, and type checking on PRs
- **Test PyPI**: Automatic deployment to Test PyPI from `develop` branch
- **Production PyPI**: Automatic deployment to PyPI when tags are pushed
- **GitHub Releases**: Automatic release creation with changelog

### Manual Deployment

```bash
# Test deployment
./scripts/build_publish_enhanced.sh -t patch

# Production deployment (creates git tag)
git tag v1.0.0
git push origin v1.0.0
```

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### ğŸ†• JWT ê¸°ë°˜ EndpointAccessType ì‹œìŠ¤í…œìœ¼ë¡œ ì „í™˜ (v2.1.0)

#### Before: í—¤ë” ê¸°ë°˜ ì ‘ê·¼ ì œì–´ âŒ

```python
# êµ¬ì‹ ë°©ë²• - ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•ŠìŒ
from fastapi import Header, Depends
from mysingle.guardrails import get_tenant_id

@router.post("/journals")
async def create_journal(
    data: JournalCreate,
    x_tenant_id: str = Header(),  # âŒ í—¤ë” ê¸°ë°˜
    tenant_id: str = Depends(get_tenant_id)  # âŒ êµ¬ì‹ ì˜ì¡´ì„±
):
    pass
```

#### After: JWT ê¸°ë°˜ EndpointAccessType âœ…

```python
# ìƒˆë¡œìš´ ë°©ë²• - JWT í† í° ê¸°ë°˜ EndpointAccessType
from mysingle.guardrails import get_access_context, EndpointAccessType
from fastapi import Depends

@router.post("/journals")
async def create_journal(
    data: JournalCreate,
    # âœ… ìƒˆë¡œìš´ EndpointAccessType ê¸°ë°˜ ì ‘ê·¼ ì œì–´
    context = Depends(get_access_context(EndpointAccessType.TENANT_ONLY))
):
    # context.user_id: ì‚¬ìš©ì ID
    # context.tenant_id: í…Œë„ŒíŠ¸ ID (JWTì—ì„œ ì¶”ì¶œ)
    # context.is_platform_user: í”Œë«í¼ ì‚¬ìš©ì ì—¬ë¶€
    pass
```

#### CRUD Factory ë§ˆì´ê·¸ë ˆì´ì…˜

```python
# Before âŒ
user_router = create_crud_router(
    service=user_service
    # ë³„ë„ì˜ ê¶Œí•œ ì„¤ì • ì—†ìŒ
)

# After âœ…
user_router = create_crud_router(
    service=user_service,
    access_type=EndpointAccessType.TENANT_ONLY  # ëª…ì‹œì  ì ‘ê·¼ ì œì–´
)
```

#### í”Œë«í¼ ê´€ë¦¬ì ì§€ì›

```python
# Before âŒ - í”Œë«í¼ ì‚¬ìš©ì ì§€ì› ì—†ìŒ
@router.get("/admin/data")
async def get_admin_data(
    tenant_id: str = Depends(get_tenant_id)  # í•­ìƒ í…Œë„ŒíŠ¸ í•„ìš”
):
    pass

# After âœ… - í”Œë«í¼ ì‚¬ìš©ì ì§€ì›
@router.get("/admin/data")
async def get_admin_data(
    context = Depends(get_access_context(EndpointAccessType.PLATFORM_ADMIN))
):
    # í”Œë«í¼ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
    # context.is_platform_user == True ë³´ì¥
    pass
```

### ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜

#### Legacy IAM í´ë¼ì´ì–¸íŠ¸

```python
# Before (legacy)
from mysingle.auth import AuthClient
from mysingle.rbac import RBACClient

auth_client = AuthClient(auth_url)
rbac_client = RBACClient(rbac_url)

# After (unified)
from mysingle import UnifiedIAMClient

iam_client = UnifiedIAMClient()  # Auto-configured
```

#### ê¶Œí•œ í™•ì¸ ë°ì½”ë ˆì´í„°

```python
# Before âŒ - í—¤ë” ê¸°ë°˜
from mysingle.rbac import require_permission

@require_permission("journals", "create")
async def create_journal_logic(x_tenant_id: str = Header()):
    pass

# After âœ… - JWT ê¸°ë°˜ (ìë™ ì—…ë°ì´íŠ¸ë¨)
from mysingle.rbac import require_permission

@require_permission("journals", "create")
async def create_journal_logic(request: Request):
    # JWT í† í°ì—ì„œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì/í…Œë„ŒíŠ¸ ì •ë³´ ì¶”ì¶œ
    pass
```

### Breaking Changes (v2.1.0)

- **ì œê±°ë¨**: `get_tenant_id(x_tenant_id: Header)` í—¤ë” ê¸°ë°˜ í•¨ìˆ˜
- **ì œê±°ë¨**: `OAuth2PasswordBearer` ìŠ¤í‚¤ë§ˆ
- **ì¶”ê°€ë¨**: `EndpointAccessType` enumê³¼ `get_access_context` í•¨ìˆ˜
- **ë³€ê²½ë¨**: ëª¨ë“  JWT ì²˜ë¦¬ê°€ í† í° ìš°ì„  ë°©ì‹ìœ¼ë¡œ ì „í™˜
- **ê°•í™”ë¨**: í”Œë«í¼ ì‚¬ìš©ì ì§€ì›ì´ í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ í†µí•©

### ë‹¨ê³„ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ˆì°¨

#### 1ë‹¨ê³„: ì˜ì¡´ì„± ì—…ë°ì´íŠ¸

```bash
# ìµœì‹  MySingle íŒ¨í‚¤ì§€ë¡œ ì—…ë°ì´íŠ¸
pip install --upgrade mysingle
# ë˜ëŠ”
uv add mysingle@latest
```

#### 2ë‹¨ê³„: Import ë¬¸ ë³€ê²½

```python
# Before
from mysingle.guardrails import get_tenant_id, require_permission

# After
from mysingle.guardrails import get_access_context, EndpointAccessType
from mysingle.guardrails import check_permission, create_permission_dependency
```

#### 3ë‹¨ê³„: ì—”ë“œí¬ì¸íŠ¸ë³„ EndpointAccessType ì„¤ì •

```python
# í…Œë„ŒíŠ¸ ì „ìš© (90% ì¼€ì´ìŠ¤)
context = Depends(get_access_context(EndpointAccessType.TENANT_ONLY))

# í”Œë«í¼ ê´€ë¦¬ì ì „ìš©
context = Depends(get_access_context(EndpointAccessType.PLATFORM_ADMIN))

# í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼
context = Depends(get_access_context(EndpointAccessType.HYBRID))
```

#### 4ë‹¨ê³„: CRUD Factory ì—…ë°ì´íŠ¸

```python
# ëª¨ë“  CRUD ë¼ìš°í„°ì— access_type ì¶”ê°€
router = create_crud_router(
    service=service,
    access_type=EndpointAccessType.TENANT_ONLY  # ì ì ˆí•œ íƒ€ì… ì„ íƒ
)
```

#### 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì—…ë°ì´íŠ¸

```python
# JWT í† í° ê¸°ë°˜ í…ŒìŠ¤íŠ¸ë¡œ ë³€ê²½
# ìì„¸í•œ ë‚´ìš©ì€ tests/ ë””ë ‰í† ë¦¬ ì°¸ì¡°
```

## ğŸ“Š Project Structure

```
mysingle/
â”œâ”€â”€ src/mysingle/           # Main package
â”‚   â”œâ”€â”€ __init__.py        # Main exports (BaseDoc, UnifiedIAMClient, etc.)
â”‚   â”œâ”€â”€ app_factory.py     # FastAPI application factory
â”‚   â”œâ”€â”€ config.py          # Configuration management
â”‚   â”œâ”€â”€ exceptions.py      # Custom exceptions
â”‚   â”œâ”€â”€ logging.py         # Logging utilities
â”‚   â”œâ”€â”€ auth/              # Authentication utilities
â”‚   â”‚   â””â”€â”€ auth_utils.py  # Auth context management
â”‚   â”œâ”€â”€ base/              # Base classes and models
â”‚   â”‚   â”œâ”€â”€ model.py       # BaseDoc for MongoDB
â”‚   â”‚   â””â”€â”€ schema.py      # BaseResponseSchema for APIs
â”‚   â”œâ”€â”€ iam/               # Unified IAM client
â”‚   â”‚   â”œâ”€â”€ client.py      # UnifiedIAMClient implementation
â”‚   â”‚   â””â”€â”€ schemas.py     # IAM data schemas
â”‚   â”œâ”€â”€ rbac/              # RBAC decorators and utilities
â”‚   â”‚   â”œâ”€â”€ decorators.py  # Permission decorators
â”‚   â”‚   â””â”€â”€ __init__.py    # RBAC exports
â”‚   â”œâ”€â”€ middleware/        # FastAPI middleware
â”‚   â”‚   â””â”€â”€ auth_middleware.py # Authentication middleware
â”‚   â”œâ”€â”€ guardrails/        # Security and privacy guardrails
â”‚   â”‚   â”œâ”€â”€ tenant_isolation.py
â”‚   â”‚   â”œâ”€â”€ privacy.py
â”‚   â”‚   â””â”€â”€ rate_limiting/
â”‚   â””â”€â”€ crud_factory.py    # CRUD operation factory
â”œâ”€â”€ tests/                 # Comprehensive test suite
â”‚   â”œâ”€â”€ test_auth_middleware.py
â”‚   â”œâ”€â”€ test_guardrails.py
â”‚   â”œâ”€â”€ test_security.py
â”‚   â””â”€â”€ test_import.py
â”œâ”€â”€ scripts/               # Build and development scripts
â””â”€â”€ pyproject.toml         # Modern Python project configuration
```

## ğŸ¤ Contributing

1. **Fork the repository**
2. **Create a feature branch**: `git checkout -b feature/amazing-feature`
3. **Make your changes and add tests**
4. **Run quality checks**: `make quality-check`
5. **Commit your changes**: `git commit -m 'feat: add amazing feature'`
6. **Push to the branch**: `git push origin feature/amazing-feature`
7. **Open a Pull Request**

### Commit Message Convention

We use conventional commits:

- `feat:` New features
- `fix:` Bug fixes
- `docs:` Documentation changes
- `style:` Code style changes
- `refactor:` Code refactoring
- `test:` Test-related changes
- `chore:` Maintenance tasks

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ†˜ Support

- **Documentation**: [BUILD_GUIDE.md](BUILD_GUIDE.md)
- **Issues**: [GitHub Issues](https://github.com/your-org/mysingle/issues)
- **Discussions**: [GitHub Discussions](https://github.com/your-org/mysingle/discussions)

## ğŸ—ºï¸ Roadmap

### Completed (v2.0.0)
- [x] Unified IAM client integration
- [x] RBAC decorator system
- [x] Multi-tenant base models
- [x] Authentication middleware
- [x] Comprehensive test suite

### Upcoming (v2.1.0)
- [ ] Enhanced audit logging with structured events
- [ ] Advanced rate limiting with tenant-specific limits
- [ ] Performance monitoring and metrics
- [ ] Extended guardrails for data privacy compliance
- [ ] Plugin system for custom extensions

### Future (v3.0.0)
- [ ] GraphQL API integration
- [ ] Advanced caching strategies
- [ ] Real-time event streaming
- [ ] AI-powered security monitoring
- [ ] Comprehensive documentation site

---

**Made with â¤ï¸ by the MySingle team**

*MySingle: Enterprise SaaS platform built for scale, security, and multi-tenancy*
