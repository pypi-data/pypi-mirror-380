# Cross-platform build configuration
# Compatible with older cargo-make versions

#-----------------------------------------------------------------------------
# Code generation tasks
#-----------------------------------------------------------------------------
[tasks.cbindgen]
install_crate = "cbindgen"

#-----------------------------------------------------------------------------
# Directory setup tasks
#-----------------------------------------------------------------------------
[tasks.build-debug]
script = '''
python build.py --debug
'''
dependencies = ["cbindgen"]

[tasks.build-release]
script = '''
python build.py --release
'''
dependencies = ["cbindgen"]

[tasks.build-local]
script = '''
cargo build
'''
dependencies = ["cbindgen"]

#-----------------------------------------------------------------------------
# Go CLI build tasks
#-----------------------------------------------------------------------------
[tasks.build-go-cli]
script = "cd ../../baml-cli && go build"
dependencies = ["build-local"]

#-----------------------------------------------------------------------------
# Integration test tasks
#-----------------------------------------------------------------------------
[tasks.integ-tests-generate]
script = "cd ../../integ-tests && BAML_LIBRARY_PATH=$(pwd)/../engine/target/debug/libbaml_cffi.dylib ../baml-cli/baml-cli generate"
dependencies = ["build-go-cli"]

[tasks.integ-tests-build]
script = "cd ../../integ-tests/go && go build"
dependencies = ["integ-tests-generate"]

[tasks.integ-tests-run-spec]
script = "cd ../../integ-tests/go && BAML_LIBRARY_PATH=$(pwd)/../../engine/target/debug/libbaml_cffi.dylib go test -v -run ${@} ./..."
dependencies = ["integ-tests-build"]

#-----------------------------------------------------------------------------
# Main tasks
#-----------------------------------------------------------------------------

# CI-specific task - build everything
[tasks.ci-build]
dependencies = ["build-release", "integ-tests-generate"]
