import{_ as J,bo as Q,Q as S,bp as G,bq as j,br as Y,an as H,x as T,z as g,e as u,y as C,F as K,r as Z,az as X,B as L,bs as $,aq as ee,ap as U,o as n,t as m,M as te,bt as oe,bu as le,bv as se,bw as ie,bx as ae,by as re,a6 as ne,w as l,j as W,bz as de,bA as ue,ad as ce,bB as fe,bC as pe,bD as he,ae as x,bE as me,bF as ge,q,bG as be,aj as h,I as N,J as we,bH as ye,C as V,g as s,V as F,h as D,W as ve,l as v,bI as O,bJ as _,D as P,bK as ke,b2 as Le,af as E,A as Ie,E as xe,bL as Ve}from"./index-jbzX_AXb.js";import{V as De,b as Se}from"./ViewToolbar-nG008anM.js";import{g as Te}from"./graphql-o3z6-itG.js";import{i as Fe,u as _e,a as k}from"./initialOptions-Ceh0265h.js";import{d as je}from"./debounce-DL1CYJdn.js";import{V as Ce}from"./VAlert-ChPOwrZJ.js";const Ne={name:"LogComponent",props:{placeholder:{type:String,required:!1},timestamps:{type:Boolean,required:!1,default:!0},logs:{type:Array,required:!0},wordWrap:{type:Boolean,required:!1,default:!1},autoScroll:{type:Boolean,required:!1,default:!1}},emits:["update:autoScroll"],setup(o,{emit:e}){const r=S("logText"),t=S("scrollWrapper"),b=S("autoScrollEnd"),a=$(o,"autoScroll",e),{arrivedState:c,directions:f}=G(t);j(()=>c.bottom&&!c.top,()=>{a.value=!0}),j(()=>o.logs.length&&f.top,()=>{a.value=!1});function p(){b.value?.scrollIntoView({behavior:"smooth"})}async function w(){a.value=!1,await ee(),t.value?.scroll({top:0,left:0,behavior:"smooth"})}const i=new ResizeObserver(p);return Y(r,()=>{U(a,I=>{I?(p(),i.observe(r.value)):(t.value.scrollBy(0,0),i.disconnect())},{immediate:!0})}),H(()=>{i.disconnect()}),{scrollToTop:w}},computed:{computedLogs(){return this.logs.length>0?this.timestamps?this.logs:this.updateLogs():this.placeholder?[this.placeholder]:[]}},methods:{updateLogs(){return this.logs.map(o=>this.stripTimestamp(o))},stripTimestamp(o){const e=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-][\d:]+)?\s(.*\s*)/;return o.match(e)?.[1]??o}},icons:{mdiMouseMoveUp:Q}},Be={ref:"scrollWrapper",class:"h-100 overflow-auto px-4 pb-2"},We={ref:"autoScrollEnd"};function qe(o,e,r,t,b,a){return n(),T("div",Be,[g("pre",{ref:"logText",class:X(r.wordWrap?"text-pre-wrap text-break":"text-pre"),"data-cy":"log-text"},[(n(!0),T(K,null,Z(a.computedLogs,(c,f)=>(n(),T("span",{key:f},m(c),1))),128))],2),r.logs.length?(n(),u(L,{key:0,position:"fixed",location:"bottom right",class:"ma-5",onClick:t.scrollToTop,icon:o.$options.icons.mdiMouseMoveUp,"data-cy":"log-scroll-top"},null,8,["onClick","icon"])):C("",!0),g("div",We,null,512)],512)}const Oe=J(Ne,[["render",qe]]),Pe=N`
subscription LogData ($id: ID!, $file: String!) {
  logs (id: $id, file: $file) {
    lines
    connected
    path
    error
  }
}
`,Ee=N`
query LogFiles($id: ID!) {
  logFiles(id: $id) {
    files
  }
}
`,Re=N`
query Jobs($id: ID!, $workflowId: ID!) {
  jobs (live: false, ids: [$id], workflows: [$workflowId]) {
    id
    state
    platform
    jobId
    jobRunnerName
    submittedTime
    startedTime
    finishedTime
  }
}
`;class R{constructor(){this.lines=[],this.host=null,this.path=null,this.connected=null,this.error=null}}class Je extends we{constructor(e){super(),this.results=e}onAdded(e,r,t){this.results.connected===!1&&(this.results.lines=[]),e.lines&&this.results.lines.push(...e.lines),e.connected!=null&&(this.results.connected=e.connected),e.error!=null&&(this.results.error=e.error),e.path!=null&&([this.results.host,this.results.path]=e.path.split(":",2))}}const Ue={name:"Log",mixins:[Te,ne],components:{CopyBtn:re,LogComponent:Oe,ViewToolbar:De,JobDetails:ae},emits:[_e],props:{initialOptions:Fe},setup(o,{emit:e}){const r=ye(),t=k("relativeID",{props:o,emit:e}),b=me(t),a=ge(t.value,{onChanged:je(d=>{t.value=d},500)});function c(d){return!d||(x.validate(d,!0)??!0)}const f=q(()=>{if(t.value)try{const d=new x(t.value,!0);if(d.task)return d.job?d:d.clone({job:"NN"})}catch{}return null}),p=k("file",{props:o,emit:e}),w=k("timestamps",{props:o,emit:e},!0),i=be(),I=k("wordWrap",{props:o,emit:e},i.value);U(I,d=>{i.value=d});const y=h(new R);function M(){y.value=new R}const z=q(()=>y.value.path?.substring(0,y.value.path.length-p.value.length-1));j(()=>r.state.offline,()=>{y.value.connected=!1});const A=k("autoScroll",{props:o,emit:e},!0),B="40";return{query:h(null),logFiles:h([]),results:y,parentPath:z,relativeID:t,previousRelativeID:b,inputID:a,validateInputID:c,relativeTokens:f,Tokens:x,file:p,fileLabel:h("Select File"),fileDisabled:h(!1),jobLog:h(t.value==null?0:1),timestamps:w,wordWrap:I,autoScroll:A,reset:M,toolbarBtnSize:B,toolbarBtnProps:Se(B),jobNode:h(null)}},mounted(){this.$watch(()=>({id:this.id??void 0,file:this.file??void 0}),async({id:o},e)=>{this.updateQuery(),o!==e?.id&&await this.setNewFile(!e)},{immediate:!0})},computed:{workflowTokens(){return new x(this.workflowId)},id(){return this.jobLog?this.relativeTokens?.clone(this.workflowTokens)?.id:this.workflowId},controlGroups(){return[{title:"Log",controls:[{title:"Timestamps",icon:fe,action:"toggle",value:this.timestamps,key:"timestamps"},{title:"Word wrap",icon:pe,action:"toggle",value:this.wordWrap,key:"wordWrap"},{title:"Auto scroll",icon:he,action:"toggle",value:this.autoScroll,key:"autoScroll"}]}]}},methods:{setOption(o,e){this[o]=e},updateQuery(){if(this.reset(),!this.file||!this.id){this.query=null;return}this.query=new ce(Pe,{id:this.id,file:this.file},`log-query-${this._uid}`,[new Je(this.results)],!1,!1)},async fetchJobData(){let o;this.jobNode=null;try{this.relativeTokens&&(o=await this.$workflowService.query2(Re,{id:this.relativeTokens.id,workflowId:this.workflowTokens.workflow}))}catch(e){return console.error(e),!1}return this.jobNode=o?.data?.jobs?.[0]??!1,this.jobNode},getDefaultWorkflowLog(){return this.logFiles.find(o=>o.startsWith("scheduler/"))},async updateLogFileList(){if(!this.id){this.handleNoLogFiles();return}this.fileLabel="Updating available files...",this.fileDisabled=!0;let o;try{o=await this.$workflowService.apolloClient.query({query:Ee,variables:{id:this.id}})}catch(r){this.handleLogFileListingErr(r),this.handleNoLogFiles();return}if(!this.id)return;const e=o.data.logFiles?.files??[];e.length?(this.fileLabel="Select File",this.fileDisabled=!1,this.logFiles=e):(o.errors?.length&&this.handleLogFileListingErr(o.errors[0].message),this.handleNoLogFiles())},async setNewFile(o){const e=[this.updateLogFileList()];this.jobLog&&!o&&e.push(this.fetchJobData().then(r=>{this.file=ue(r?.state)})),await Promise.all(e),this.jobLog||(this.file=this.getDefaultWorkflowLog())},handleNoLogFiles(){this.fileLabel=this.id?`No log files for ${this.id}`:"Enter a task/job ID",this.fileDisabled=!0,this.logFiles=[]},handleLogFileListingErr(o){this.$store.dispatch("setAlert",new de(o,"error"))}},watch:{jobLog(o,e){this.file=null,this.relativeID=o?this.previousRelativeID:null}},icons:{mdiFolderRefresh:ie,mdiPowerPlug:se,mdiPowerPlugOff:le,mdiFileAlertOutline:oe,mdiInformationOutline:te}},Me={"data-cy":"log-path",class:"ml-2 mr-1 d-flex text-medium-emphasis text-pre overflow-x-hidden"},ze={class:"flex-shrink-1 text-truncate"},Ae={class:"text-pre-wrap text-break"};function Qe(o,e,r,t,b,a){const c=V("ViewToolbar"),f=V("JobDetails"),p=V("CopyBtn"),w=V("log-component");return n(),u(W,{class:"c-log h-100 pa-0 d-flex flex-column",fluid:""},{default:l(()=>[s(W,{fluid:""},{default:l(()=>[s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[s(D,{class:"pt-0"},{default:l(()=>[s(ve,{modelValue:t.jobLog,"onUpdate:modelValue":e[0]||(e[0]=i=>t.jobLog=i),divided:"",mandatory:"",variant:"outlined",color:"primary",density:"comfortable"},{default:l(()=>[s(L,{"data-cy":"workflow-toggle"},{default:l(()=>[...e[7]||(e[7]=[v("Workflow",-1)])]),_:1}),s(L,{"data-cy":"job-toggle"},{default:l(()=>[...e[8]||(e[8]=[v("Job",-1)])]),_:1})]),_:1},8,["modelValue"]),s(c,{groups:a.controlGroups,onSetOption:a.setOption,size:t.toolbarBtnSize},null,8,["groups","onSetOption","size"])]),_:1})]),_:1}),s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[s(D,{cols:"8"},{default:l(()=>[t.jobLog?(n(),u(O,{key:0,"data-cy":"job-id-input",class:"flex-grow-1 flex-column",modelValue:t.inputID,"onUpdate:modelValue":e[2]||(e[2]=i=>t.inputID=i),rules:[t.validateInputID],placeholder:"cycle/task/job",clearable:""},{"prepend-inner":l(()=>[s(L,_({disabled:!t.relativeTokens||t.jobNode===!1},t.toolbarBtnProps,{size:"medium",variant:"plain",onClick:e[1]||(e[1]=()=>t.jobNode??a.fetchJobData()),"data-cy":"job-info-btn"}),{default:l(()=>[s(P,{icon:o.$options.icons.mdiInformationOutline},null,8,["icon"]),s(ke,{activator:"parent","close-on-content-click":!1},{default:l(()=>[s(Le,{class:"pa-2"},{default:l(()=>[t.jobNode?(n(),u(f,{key:1,node:t.jobNode,density:"compact",hover:""},{header:l(()=>[v(m(new t.Tokens(t.jobNode.id).relativeID),1)]),_:1},8,["node"])):(n(),u(E,{key:0,type:"text@6"}))]),_:1})]),_:1})]),_:1},16,["disabled"])]),_:1},8,["modelValue","rules"])):(n(),u(O,{key:1,"data-cy":"workflow-id-input",modelValue:o.workflowId,"onUpdate:modelValue":e[3]||(e[3]=i=>o.workflowId=i),disabled:""},null,8,["modelValue"]))]),_:1}),s(D,{cols:"4",class:"d-flex align-start col-gap-2"},{default:l(()=>[s(Ie,{"data-cy":"file-input",label:t.fileLabel,disabled:t.fileDisabled,items:t.logFiles,modelValue:t.file,"onUpdate:modelValue":e[4]||(e[4]=i=>t.file=i),"menu-props":{"data-cy":"file-input-menu"}},null,8,["label","disabled","items","modelValue"]),s(L,_({onClick:e[5]||(e[5]=()=>this.updateLogFileList())},t.toolbarBtnProps,{"data-cy":"refresh-files"}),{default:l(()=>[s(P,{icon:o.$options.icons.mdiFolderRefresh},null,8,["icon"]),s(xe,null,{default:l(()=>[...e[9]||(e[9]=[v("Refresh file list",-1)])]),_:1})]),_:1},16)]),_:1})]),_:1}),s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[t.results.path?(n(),u(D,{key:0,class:"d-flex align-center"},{default:l(()=>[s(Ve,_({"data-cy":"connected-icon",variant:"outlined",class:"flex-shrink-0"},t.results.connected?{color:"success",prependIcon:o.$options.icons.mdiPowerPlug}:{color:"error",prependIcon:o.$options.icons.mdiPowerPlugOff,onClick:a.updateQuery}),{default:l(()=>[v(m(t.results.connected?"Connected":"Reconnect"),1)]),_:1},16),g("div",Me,[g("span",null,m(t.results.host)+":",1),g("span",ze,m(t.parentPath),1),g("span",null,"/"+m(t.file),1)]),s(p,{text:t.results.path,tooltip:"Copy path"},null,8,["text"])]),_:1})):C("",!0)]),_:1}),t.results.error?(n(),u(Ce,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2",icon:o.$options.icons.mdiFileAlertOutline},{default:l(()=>[g("span",Ae,m(t.results.error),1)]),_:1},8,["icon"])):C("",!0)]),_:1}),a.id&&t.file&&t.results.connected==null?(n(),u(E,{key:0,type:"text@5",class:"align-content-start"})):(n(),u(w,{key:1,"data-cy":"log-viewer",logs:t.results.lines,timestamps:t.timestamps,"word-wrap":t.wordWrap,autoScroll:t.autoScroll,"onUpdate:autoScroll":e[6]||(e[6]=i=>t.autoScroll=i)},null,8,["logs","timestamps","word-wrap","autoScroll"]))]),_:1})}const $e=J(Ue,[["render",Qe]]);export{$e as default};
