name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update formula for'
        required: true
        type: string

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Wait for PyPI to have the package available (with retries)
          echo "Waiting for package to be available on PyPI..."
          MAX_ATTEMPTS=20
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            # Try to download the tarball from PyPI
            if wget -q "https://files.pythonhosted.org/packages/source/c/corclient/corclient-${VERSION}.tar.gz"; then
              echo "Package found on PyPI!"
              break
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "ERROR: Package not found on PyPI after $MAX_ATTEMPTS attempts"
              exit 1
            fi

            echo "Package not yet available, waiting 30 seconds..."
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done

          # Calculate SHA256
          SHA256=$(sha256sum "corclient-${VERSION}.tar.gz" | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Update Formula
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          SHA256="${{ steps.release.outputs.sha256 }}"

          cat > HomebrewFormula/corclient.rb << EOF
          class Corclient < Formula
            include Language::Python::Virtualenv

            desc "Internal CLI tool for microservices management and infrastructure administration"
            homepage "https://github.com/ProjectCORTeam/corcli"
            url "https://files.pythonhosted.org/packages/source/c/corclient/corclient-${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "python@3.11"

            resource "typer" do
              url "https://files.pythonhosted.org/packages/source/t/typer/typer-0.12.5.tar.gz"
              sha256 "f592f089bedcc8ec1b974125d64851029c3b1af145f04aca64d69410f0c9b722"
            end

            resource "rich" do
              url "https://files.pythonhosted.org/packages/source/r/rich/rich-13.7.1.tar.gz"
              sha256 "9be308cb1fe2f1f57d67ce99e95af38a1e2bc71ad9813b0e247cf7ffbcc3a432"
            end

            resource "click" do
              url "https://files.pythonhosted.org/packages/source/c/click/click-8.1.7.tar.gz"
              sha256 "ca9853ad459e787e2192211578cc907e7594e294c7ccc834310722b41b9ca6de"
            end

            resource "flask" do
              url "https://files.pythonhosted.org/packages/source/f/flask/flask-3.0.3.tar.gz"
              sha256 "ceb27b0af3823ea2737928a4d99d125a06175b8512c445cbd9a9ce200ef76842"
            end

            resource "requests" do
              url "https://files.pythonhosted.org/packages/source/r/requests/requests-2.31.0.tar.gz"
              sha256 "942c5a758f98d5e85e407a9981bdc7c9f82e2e1b9f8e6c2f4f4f4f4f4f4f4f4f"
            end

            def install
              virtualenv_install_with_resources
            end

            test do
              assert_match "CoreCLI", shell_output("#{bin}/cor --help")
            end
          end
          EOF

      - name: Commit and push formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add HomebrewFormula/corclient.rb
          git commit -m "chore: update Homebrew formula to ${{ steps.release.outputs.version }}" || echo "No changes to commit"
          git push
