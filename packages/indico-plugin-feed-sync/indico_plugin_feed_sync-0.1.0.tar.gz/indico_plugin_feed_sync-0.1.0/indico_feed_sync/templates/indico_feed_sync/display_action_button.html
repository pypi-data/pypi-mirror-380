<script>
(() => {
  const refreshUrl = {{ refresh_url | tojson | safe }};
  const csrfToken = {{ session.csrf_token | tojson | safe }};
  const confirmMessage = {{ _('This will re-import this event from its feed. Continue?') | tojson | safe }};
  const buttonTitle = {{ _('Force resync via feed') | tojson | safe }};
  const buttonLabel = {{ _('Force resync') | tojson | safe }};

  function createForm() {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = refreshUrl;
    form.style.display = 'none';
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrf_token';
    csrf.value = csrfToken;
    form.appendChild(csrf);
    document.body.appendChild(form);
    return form;
  }

  function attachButton() {
    const container = document.querySelector('.page-header .button-bar')
      || document.querySelector('.page-header .toolbar');
    if (!container) {
      return false;
    }
    const editLink = container.querySelector('a.icon-edit[href*="/manage/"]');
    if (!editLink) {
      return false;
    }
    if (container.querySelector('.feed-sync-display-force-button')) {
      return true;
    }

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'i-button text-color subtle icon-redo feed-sync-display-force-button';
    button.title = buttonTitle;
    button.setAttribute('aria-label', buttonLabel);
    button.style.marginLeft = '0.4em';

    button.addEventListener('click', () => {
      if (!window.confirm(confirmMessage)) {
        return;
      }
      const form = createForm();
      form.submit();
    });

    editLink.insertAdjacentElement('afterend', button);
    return true;
  }

  function scheduleAttach(retries = 20) {
    if (attachButton()) {
      return;
    }
    if (retries <= 0) {
      return;
    }
    setTimeout(() => scheduleAttach(retries - 1), 200);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => scheduleAttach());
  } else {
    scheduleAttach();
  }
})();
</script>
