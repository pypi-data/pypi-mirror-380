<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Writing a Plugin Model &#8212; SasView 6.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css?v=2bf1fcf8" />
    
    <script src="../../../../_static/documentation_options.js?v=c7384f69"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Scripting Interface" href="scripting.html" />
    <link rel="prev" title="Fitting SESANS Data from the Command Line" href="sesans/sesans_fitting.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="scripting.html" title="Scripting Interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sesans/sesans_fitting.html" title="Fitting SESANS Data from the Command Line"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">SasView 6.1.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../user.html" >SasView User Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../analysis.html" >Fitting &amp; Other Analyses</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="fitting.html" accesskey="U">Fitting Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Writing a Plugin Model</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="writing-a-plugin-model">
<span id="writing-a-plugin"></span><h1>Writing a Plugin Model<a class="headerlink" href="#writing-a-plugin-model" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>In addition to the models provided with the sasmodels package, you are free to
create your own models. This document describes how to create plugin models
from first principles.</p>
<p>If you are using SasView and simply want to combine existing models into a new
plugin then use the “Add/Multiply Models” menu option instead.</p>
<p>Models can be of three types:</p>
<ul class="simple">
<li><p>A pure python model : Example -
<a class="reference external" href="https://github.com/SasView/sasmodels/blob/master/sasmodels/models/broad_peak.py">broadpeak.py</a></p></li>
<li><p>A python model with embedded C : Example -
<a class="reference external" href="https://github.com/SasView/sasmodels/blob/master/sasmodels/models/sphere.py">sphere.py</a></p></li>
<li><p>A python wrapper with separate C code : Example -
<a class="reference external" href="https://github.com/SasView/sasmodels/blob/master/sasmodels/models/cylinder.py">cylinder.py</a>,
<a class="reference external" href="https://github.com/SasView/sasmodels/blob/master/sasmodels/models/cylinder.c">cylinder.c</a></p></li>
</ul>
<p>When using SasView, plugin models should be saved to the SasView
<em>plugin_models</em> folder <em>C:\Users\{username}\.sasview\plugin_models</em>
(on Windows) or <em>/Users/{username}/.sasview\plugin_models</em> (on Mac).
The next time SasView is started it will compile the plugin and add
it to the list of <em>Plugin Models</em> in a FitPage.  Scripts can load
the models from anywhere.</p>
<p>The built-in modules are available in the <em>models</em> subdirectory
of the sasmodels package.  For SasView on Windows, these will
be found in <em>C:\Program Files (x86)\SasView\sasmodels-data\models</em>.
On Mac OSX, these will be within the application bundle as
<em>/Applications/SasView.app/Contents/Resources/sasmodels-data/models</em>.</p>
<p>Other models are available for download from the
<a class="reference external" href="http://marketplace.sasview.org/">Model Marketplace</a>. You can contribute your
own models to the Marketplace as well.</p>
</section>
<section id="create-new-model-files">
<h2>Create New Model Files<a class="headerlink" href="#create-new-model-files" title="Link to this heading">¶</a></h2>
<p>Copy the appropriate files to your plugin models directory (we recommend
using the examples above as templates) as mymodel.py (and mymodel.c, etc)
as required, where “mymodel” is the name for the model you are creating.</p>
<p><em>Please follow these naming rules:</em></p>
<ul class="simple">
<li><p>No capitalization and thus no CamelCase</p></li>
<li><p>If necessary use underscore to separate words (i.e. barbell not BarBell or
broad_peak not BroadPeak)</p></li>
<li><p>Do not include “model” in the name (i.e. barbell not BarBellModel)</p></li>
</ul>
</section>
<section id="edit-new-model-files">
<h2>Edit New Model Files<a class="headerlink" href="#edit-new-model-files" title="Link to this heading">¶</a></h2>
<section id="model-contents">
<h3>Model Contents<a class="headerlink" href="#model-contents" title="Link to this heading">¶</a></h3>
<p>The model interface definition is in the .py file.  This file contains:</p>
<ul>
<li><dl>
<dt>a <strong>model name</strong>:</dt><dd><ul class="simple">
<li><p>this is the <strong>name</strong> string in the <em>.py</em> file</p></li>
<li><p>titles should be:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>all in <em>lower</em> case</p></li>
<li><p>without spaces (use underscores to separate words instead)</p></li>
<li><p>without any capitalization or CamelCase</p></li>
<li><p>without incorporating the word “model”</p></li>
<li><p>examples: <em>barbell</em> <strong>not</strong> <em>BarBell</em>; <em>broad_peak</em> <strong>not</strong> <em>BroadPeak</em>;
<em>barbell</em> <strong>not</strong> <em>BarBellModel</em></p></li>
</ul>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>model title</strong>:</dt><dd><ul class="simple">
<li><p>this is the <strong>title</strong> string in the <em>.py</em> file</p></li>
<li><p>this is a one or two line description of the model, which will appear
at the start of the model documentation and as a tooltip in the SasView GUI</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>short description</strong>:</dt><dd><ul class="simple">
<li><p>this is the <strong>description</strong> string in the <em>.py</em> file</p></li>
<li><p>this is a medium length description which appears when you click
<em>Description</em> on the model FitPage</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>parameter table</strong>:</dt><dd><ul class="simple">
<li><p>this will be auto-generated from the <em>parameters</em> in the <em>.py</em> file</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>long description</strong>:</dt><dd><ul class="simple">
<li><p>this is ReStructuredText enclosed between the r””” and “”” delimiters
at the top of the <em>.py</em> file</p></li>
<li><p>what you write here is abstracted into the SasView help documentation</p></li>
<li><p>this is what other users will refer to when they want to know what
your model does; so please be helpful!</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>definition</strong> of the model:</dt><dd><ul class="simple">
<li><p>as part of the <strong>long description</strong></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>formula</strong> defining the function the model calculates:</dt><dd><ul class="simple">
<li><p>as part of the <strong>long description</strong></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>an <strong>explanation of the parameters</strong>:</dt><dd><ul class="simple">
<li><p>as part of the <strong>long description</strong></p></li>
<li><p>explaining how the symbols in the formula map to the model parameters</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>a <strong>plot</strong> of the function, with a <strong>figure caption</strong>:</dt><dd><ul class="simple">
<li><p>this is automatically generated from your default parameters</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>at least one <strong>reference</strong>:</dt><dd><ul class="simple">
<li><p>as part of the <strong>long description</strong></p></li>
<li><p>specifying where the reader can obtain more information about the model</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>the <strong>name of the author</strong></dt><dd><ul class="simple">
<li><p>as part of the <strong>long description</strong></p></li>
<li><p>the <em>.py</em> file should also contain a comment identifying <em>who</em>
converted/created the model file</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Models that do not conform to these requirements will <em>never</em> be incorporated
into the built-in library.</p>
</section>
<section id="composite-models">
<h3>Composite Models<a class="headerlink" href="#composite-models" title="Link to this heading">¶</a></h3>
<p>The simplest way to define a new model is to combine existing models.  For
example, <em>cyl_sphere.py</em> could contain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sasmodels.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_model_info</span>
<span class="n">model_info</span> <span class="o">=</span> <span class="n">load_model_info</span><span class="p">(</span><span class="s1">&#39;cylinder+sphere@hardsphere&#39;</span><span class="p">)</span>
<span class="n">model_info</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>This defines a mixture of <a class="reference internal" href="../../../models/cylinder.html#cylinder"><span class="std std-ref">cylinder</span></a> and <a class="reference internal" href="../../../models/sphere.html#sphere"><span class="std std-ref">sphere</span></a> shapes, with
the spheres clustered closely enough to require an interaction effective
with the <a class="reference internal" href="../../../models/hardsphere.html#hardsphere"><span class="std std-ref">hardsphere</span></a> structure factor.</p>
<p>The magic code at the end extracts the base filename, <em>cyl_sphere</em> from the
model file path and assigns it to the model name.</p>
</section>
<section id="reparameterized-models">
<span id="id1"></span><h3>Reparameterized Models<a class="headerlink" href="#reparameterized-models" title="Link to this heading">¶</a></h3>
<p>You can modify an existing model to use new parameters.  For example,
to create an ellipsoid constrained by volume:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sasmodels.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">reparameterize</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># name, units, default, [min, max], type, description</span>
    <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Ang^3&quot;</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;ellipsoid volume&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;polar:equatorial radius&quot;</span><span class="p">],</span>
<span class="p">]</span>
<span class="n">translation</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Re = cbrt(volume/eccentricity/M_4PI_3)</span>
<span class="s2">    radius_polar = eccentricity*Re</span>
<span class="s2">    radius_equatorial = Re  # python style comments allowed</span>
<span class="s2">    &quot;&quot;&quot;</span>
<span class="n">model_info</span> <span class="o">=</span> <span class="n">reparameterize</span><span class="p">(</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <em>volume</em> and <em>eccentricity</em> are new parameters which replace the
<em>radius_polar</em> and <em>radius_equatorial</em> parameters in the <a class="reference internal" href="../../../models/ellipsoid.html#ellipsoid"><span class="std std-ref">ellipsoid</span></a>
model.  The parameter properties are described below.  Since <em>volume</em> and
<em>eccentricity</em> are “volume” parameters they may be polydisperse.</p>
<p><em>translation</em> is a set of equations to compute the underlying ellipsoid
parameters from the new parameters. <em>Re</em> is an intermediate value
introduced to make the equations easier to write.  Helper functions can
be included in a C file as <em>source=[‘filename.c’, …]</em> in the same directory
as the model file.</p>
<p>The new parameters replace <em>radius_polar</em> and <em>radius_equatorial</em> in the
parameter table.  To have more control over parameter placement, use an
<em>insert_after={…}</em> argmument to <code class="xref py py-func docutils literal notranslate"><span class="pre">core.reparameterize()</span></code>.
For each insert location provide a list of new parameter names to insert
at that location.  For example, <em>{‘’: ‘eccentricity,volume’}</em> inserts
them both at the beginning (before any parameter), whereas
<em>{‘radius_polar’: ‘eccentricty’, ‘radius_equatorial’: ‘volume’}</em> will
place them after <em>radius_polar</em> and <em>radius_equatorial</em> in the final
parameter table, before deleting <em>radius_polar</em> and <em>radius_equatorial</em>.</p>
</section>
<section id="model-documentation">
<h3>Model Documentation<a class="headerlink" href="#model-documentation" title="Link to this heading">¶</a></h3>
<p>The <em>.py</em> file starts with an r (for raw) and three sets of quotes
to start the doc string and ends with a second set of three quotes.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definition</span>
<span class="sd">----------</span>

<span class="sd">The 1D scattering intensity of the sphere is calculated in the following</span>
<span class="sd">way (Guinier, 1955)</span>

<span class="sd">.. math::</span>

<span class="sd">    I(q) = \frac{\text{scale}}{V} \cdot \left[</span>
<span class="sd">        3V(\Delta\rho) \cdot \frac{\sin(qr) - qr\cos(qr))}{(qr)^3}</span>
<span class="sd">        \right]^2 + \text{background}</span>

<span class="sd">where *scale* is a volume fraction, :math:`V` is the volume of the scatterer,</span>
<span class="sd">:math:`r` is the radius of the sphere and *background* is the background level.</span>
<span class="sd">*sld* and *sld_solvent* are the scattering length densities (SLDs) of the</span>
<span class="sd">scatterer and the solvent respectively, whose difference is :math:`\Delta\rho`.</span>

<span class="sd">You can included figures in your documentation, as in the following</span>
<span class="sd">figure for the cylinder model.</span>

<span class="sd">.. figure:: img/cylinder_angle_definition.jpg</span>

<span class="sd">    Definition of the angles for oriented cylinders.</span>

<span class="sd">References</span>
<span class="sd">----------</span>

<span class="sd">#. A Guinier, G Fournet, *Small-Angle Scattering of X-Rays*,</span>
<span class="sd">   John Wiley and Sons, New York, (1955)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This is where the FULL documentation for the model goes (to be picked up by
the automatic documentation system).  Although it feels odd, you
should start the documentation immediately with the <strong>definition</strong>—the model
name, a brief description and the parameter table are automatically inserted
above the definition, and the a plot of the model is automatically inserted
before the <strong>reference</strong>.</p>
<p>Figures can be included using the <em>figure</em> command, with the name
of the <em>.png</em> file containing the figure and a caption to appear below the
figure.  Figure numbers will be added automatically.</p>
<p>See this <a class="reference external" href="http://matplotlib.org/sampledoc/cheatsheet.html">Sphinx cheat sheet</a>
for a quick guide to the documentation layout commands, or the
<a class="reference external" href="http://www.sphinx-doc.org/en/stable/">Sphinx Documentation</a> for
complete details.</p>
<p>The model should include a <strong>formula</strong> written using LaTeX markup.
The example above uses the <em>math</em> command to make a displayed equation.  You
can also use <em>$formula$</em> for an inline formula. This is handy for defining
the relationship between the model parameters and formula variables, such
as the phrase “$r$ is the radius” used above.  The live demo MathJax
page <a class="reference external" href="http://www.mathjax.org/">http://www.mathjax.org/</a> is handy for checking that the equations
will look like you intend.</p>
<p>Math layout uses the <a class="reference external" href="http://www.ams.org/publications/authors/tex/amslatex">amsmath</a>
package for aligning equations (see amsldoc.pdf on that page for complete
documentation). You will automatically be in an aligned environment, with
blank lines separating the lines of the equation.  Place an ampersand before
the operator on which to align.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">math</span><span class="p">::</span>

  <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&amp;=</span> <span class="mi">1</span> \\
  <span class="n">y</span> <span class="o">&amp;=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
<p>produces</p>
<div class="math notranslate nohighlight">
\[\begin{split}x + y &amp;= 1 \\
y &amp;= x - 1\end{split}\]</div>
<p>If you need more control, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">math</span><span class="p">::</span>
    <span class="p">:</span><span class="n">nowrap</span><span class="p">:</span>
</pre></div>
</div>
</section>
<section id="model-definition">
<h3>Model Definition<a class="headerlink" href="#model-definition" title="Link to this heading">¶</a></h3>
<p>Following the documentation string, there are a series of definitions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sphere&quot;</span>  <span class="c1"># optional: defaults to the filename without .py</span>

<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Spheres with uniform scattering length density&quot;</span>

<span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">P(q)=(scale/V)*[3V(sld-sld_solvent)*(sin(qr)-qr cos(qr))</span>
<span class="s2">                /(qr)^3]^2 + background</span>
<span class="s2">    r: radius of sphere</span>
<span class="s2">    V: The volume of the scatter</span>
<span class="s2">    sld: the SLD of the sphere</span>
<span class="s2">    sld_solvent: the SLD of the solvent</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">category</span> <span class="o">=</span> <span class="s2">&quot;shape:sphere&quot;</span>

<span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1"># optional: defaults to True</span>

<span class="n">opencl</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># optional: defaults to False</span>

<span class="n">structure_factor</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># optional: defaults to False</span>
</pre></div>
</div>
<p><strong>name = “mymodel”</strong> defines the name of the model that is shown to the user.
If it is not provided it will use the name of the model file. The name must
be a valid variable name, starting with a letter and contains only letters,
numbers or underscore.  Spaces, dashes, and other symbols are not permitted.</p>
<p><strong>title = “short description”</strong> is short description of the model which
is included after the model name in the automatically generated documentation.
The title can also be used for a tooltip.</p>
<p><strong>description = “””doc string”””</strong> is a longer description of the model. It
shows up when you press the “Description” button of the SasView FitPage.
It should give a brief description of the equation and the parameters
without the need to read the entire model documentation. The triple quotes
allow you to write the description over multiple lines. Keep the lines
short since the GUI will wrap each one separately if they are too long.
<strong>Make sure the parameter names in the description match the model definition!</strong></p>
<p><strong>category = “shape:sphere”</strong> defines where the model will appear in the
model documentation.  In this example, the model will appear alphabetically
in the list of spheroid models in the <em>Shape</em> category.</p>
<p><strong>single = True</strong> indicates that the model can be run using single
precision floating point values.  Set it to False if the numerical
calculation for the model is unstable, which is the case for about 20 of
the built in models.  It is worthwhile modifying the calculation to support
single precision, allowing models to run up to 10 times faster.  The
section <a class="reference internal" href="#test-your-new-model">Test_Your_New_Model</a>  describes how to compare model values for
single vs. double precision so you can decide if you need to set
single to False.</p>
<p><strong>opencl = False</strong> indicates that the model should not be run using OpenCL.
This may be because the model definition includes code that cannot be
compiled for the GPU (for example, goto statements).  It can also be used
for large models which can’t run on most GPUs.  This flag has not been
used on any of the built in models; models which were failing were
streamlined so this flag was not necessary.</p>
<p><strong>structure_factor = True</strong> indicates that the model can be used as a
structure factor to account for interactions between particles.  See
<a class="reference internal" href="#form-factors">Form_Factors</a> for more details.</p>
<p><strong>model_info = …</strong> lets you define a model directly, for example, by
loading and modifying existing models.  This is done implicitly by
<code class="xref py py-func docutils literal notranslate"><span class="pre">core.load_model_info()</span></code>, which can create a mixture model
from a pair of existing models.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sasmodels.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_model_info</span>
<span class="n">model_info</span> <span class="o">=</span> <span class="n">load_model_info</span><span class="p">(</span><span class="s1">&#39;sphere+cylinder&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>See <code class="xref py py-class docutils literal notranslate"><span class="pre">modelinfo.ModelInfo</span></code> for details about the model
attributes that are defined.</p>
</section>
<section id="model-parameters">
<h3>Model Parameters<a class="headerlink" href="#model-parameters" title="Link to this heading">¶</a></h3>
<p>Next comes the parameter table.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># pylint: disable=bad-whitespace, line-too-long</span>
<span class="c1">#   [&quot;name&quot;,        &quot;units&quot;, default, [min, max], &quot;type&quot;,    &quot;description&quot;],</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;sld&quot;</span><span class="p">,</span>         <span class="s2">&quot;1e-6/Ang^2&quot;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;sld&quot;</span><span class="p">,</span>    <span class="s2">&quot;Layer scattering length density&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;sld_solvent&quot;</span><span class="p">,</span> <span class="s2">&quot;1e-6/Ang^2&quot;</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;sld&quot;</span><span class="p">,</span>    <span class="s2">&quot;Solvent scattering length density&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span>      <span class="s2">&quot;Ang&quot;</span><span class="p">,</span>        <span class="mi">50</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span>    <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Sphere radius&quot;</span><span class="p">],</span>
<span class="p">]</span>
<span class="c1"># pylint: enable=bad-whitespace, line-too-long</span>
</pre></div>
</div>
<p><strong>parameters = [[“name”, “units”, default, [min,max], “type”, “tooltip”],…]</strong>
defines the parameters that form the model.</p>
<p><strong>Note: The order of the parameters in the definition will be the order of the
parameters in the user interface and the order of the parameters in Fq(), Iq(),
Iqac(), Iqabc(), radius_effective(), form_volume() and shell_volume().
And</strong> <em>scale</em> <strong>and</strong> <em>background</em> <strong>parameters are implicit to all models,
so they do not need to be included in the parameter table.</strong></p>
<ul>
<li><p><strong>“name”</strong> is the name of the parameter shown on the FitPage.</p>
<ul>
<li><p>the name must be a valid variable name, starting with a letter and
containing only letters, numbers and underscore.</p></li>
<li><p>parameter names should follow the mathematical convention; e.g.,
<em>radius_core</em> not <em>core_radius</em>, or <em>sld_solvent</em> not <em>solvent_sld</em>.</p></li>
<li><p>model parameter names should be consistent between different models,
so <em>sld_solvent</em>, for example, should have exactly the same name
in every model.</p></li>
<li><p>to see all the parameter names currently in use, type the following in the
python shell/editor under the Tools menu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sasmodels.list_pars</span>
<span class="n">sasmodels</span><span class="o">.</span><span class="n">list_pars</span><span class="o">.</span><span class="n">list_pars</span><span class="p">()</span>
</pre></div>
</div>
<p><em>re-use</em> as many as possible!!!</p>
</li>
<li><p>use “name[n]” for multiplicity parameters, where <em>n</em> is the name of
the parameter defining the number of shells/layers/segments, etc.</p></li>
</ul>
</li>
<li><p><strong>“units”</strong> are displayed along with the parameter name</p>
<ul>
<li><p>every parameter should have units; use “None” if there are no units.</p></li>
<li><p><strong>sld’s should be given in units of 1e-6/Ang^2, and not simply
1/Ang^2 to be consistent with the builtin models.  Adjust your formulas
appropriately.</strong></p></li>
<li><p>fancy units markup is available for some units, including:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ang</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">Ang</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">Ang</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1e-6</span><span class="o">/</span><span class="n">Ang</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">cm</span><span class="p">,</span> <span class="n">Ang</span><span class="o">/</span><span class="n">cm</span><span class="p">,</span> <span class="n">g</span><span class="o">/</span><span class="n">cm</span><span class="o">^</span><span class="mi">3</span><span class="p">,</span> <span class="n">mg</span><span class="o">/</span><span class="n">m</span><span class="o">^</span><span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>the list of units is defined in the variable <em>RST_UNITS</em> within
<a class="reference external" href="https://github.com/SasView/sasmodels/tree/master/sasmodels/generate.py">sasmodels/generate.py</a></p>
<ul class="simple">
<li><p>new units can be added using the macros defined in <em>doc/rst_prolog</em>
in the sasmodels source.</p></li>
<li><p>units should be properly formatted using sub-/super-scripts
and using negative exponents instead of the / operator, though
the unit name should use the / operator for consistency.</p></li>
<li><p>please post a message to the SasView developers mailing list with your changes.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>default</strong> is the initial value for the parameter.</p>
<ul class="simple">
<li><p><strong>the parameter default values are used to auto-generate a plot of
the model function in the documentation.</strong></p></li>
</ul>
</li>
<li><p><strong>[min, max]</strong> are the lower and upper limits on the parameter.</p>
<ul class="simple">
<li><p>lower and upper limits can be any number, or <em>-inf</em> or <em>inf</em>.</p></li>
<li><p>the limits will show up as the default limits for the fit making it easy,
for example, to force the radius to always be greater than zero.</p></li>
<li><p>these are hard limits defining the valid range of parameter values;
polydisperity distributions will be truncated at the limits.</p></li>
</ul>
</li>
<li><p><strong>“type”</strong> can be one of: “”, “sld”, “volume”, or “orientation”.</p>
<ul class="simple">
<li><p>“sld” parameters can have magnetic moments when fitting magnetic models;
depending on the spin polarization of the beam and the <span class="math notranslate nohighlight">\(q\)</span> value being
examined, the effective sld for that material will be used to compute the
scattered intensity.</p></li>
<li><p>“volume” parameters are passed to Fq(), Iq(), Iqac(), Iqabc(), form_volume()
and shell_volume(), and have polydispersity loops generated automatically.</p></li>
<li><p>“orientation” parameters are not passed, but instead are combined with
orientation dispersity to translate <em>qx</em> and <em>qy</em> to <em>qa</em>, <em>qb</em> and <em>qc</em>.
These parameters should appear at the end of the table with the specific
names <em>theta</em>, <em>phi</em> and for asymmetric shapes <em>psi</em>, in that order.</p></li>
</ul>
</li>
</ul>
<p>Some models will have integer parameters, such as number of pearls in the
pearl necklace model, or number of shells in the multi-layer vesicle model.
The optimizers in BUMPS treat all parameters as floating point numbers which
can take arbitrary values, even for integer parameters, so your model should
round the incoming parameter value to the nearest integer inside your model
you should round to the nearest integer.  In C code, you can do this using:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">double</span>
<span class="nf">Iq</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fp_n</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">fp_n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>in python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">Iq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Derivative based optimizers such as Levenberg-Marquardt will not work
for integer parameters since the partial derivative is always zero, but
the remaining optimizers (DREAM, differential evolution, Nelder-Mead simplex)
will still function.</p>
</section>
<section id="model-computation">
<h3>Model Computation<a class="headerlink" href="#model-computation" title="Link to this heading">¶</a></h3>
<p>Models can be defined as pure python models, or they can be a mixture of
python and C models.  C models are run on the GPU if it is available,
otherwise they are compiled and run on the CPU.</p>
<p>Models are defined by the scattering kernel, which takes a set of parameter
values defining the shape, orientation and material, and returns the
expected scattering. Polydispersity and angular dispersion are defined
by the computational infrastructure.  Any parameters defined as “volume”
parameters are polydisperse, with polydispersity defined in proportion
to their value.  “orientation” parameters use angular dispersion defined
in degrees, and are not relative to the current angle.</p>
<p>Based on a weighting function <span class="math notranslate nohighlight">\(G(x)\)</span> and a number of points <span class="math notranslate nohighlight">\(n\)</span>, the
computed value is</p>
<div class="math notranslate nohighlight">
\[\hat I(q)
= \frac{\int G(x) I(q, x)\,dx}{\int G(x) V(x)\,dx}
\approx \frac{\sum_{i=1}^n G(x_i) I(q,x_i)}{\sum_{i=1}^n G(x_i) V(x_i)}\]</div>
<p>That is, the individual models do not need to include polydispersity
calculations, but instead rely on numerical integration to compute the
appropriately smeared pattern.</p>
<p>Each .py file also contains a function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random</span><span class="p">():</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This function provides a model-specific random parameter set which shows model
features in the USANS to SANS range.  For example, core-shell sphere sets the
outer radius of the sphere logarithmically in <cite>[20, 20,000]</cite>, which sets the Q
value for the transition from flat to falling.  It then uses a beta distribution
to set the percentage of the shape which is shell, giving a preference for very
thin or very thick shells (but never 0% or 100%).  Using <cite>-sets=10</cite> in sascomp
should show a reasonable variety of curves over the default sascomp q range.
The parameter set is returned as a dictionary of <cite>{parameter: value, …}</cite>.
Any model parameters not included in the dictionary will default according to
the code in the <cite>_randomize_one()</cite> function from sasmodels/compare.py.</p>
</section>
<section id="python-models">
<h3>Python Models<a class="headerlink" href="#python-models" title="Link to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pure python models do not yet support direct computation of <span class="math notranslate nohighlight">\(&lt;F(Q)^2&gt;\)</span> or
<span class="math notranslate nohighlight">\(&lt;F(Q)&gt;^2\)</span>. Neither do they support orientational distributions or magnetism
(use C models if these are required).</p>
</div>
<p>For pure python models, define the <em>Iq</em> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Iq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">I</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">Iq</span><span class="o">.</span><span class="n">vectorized</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The parameters <em>par1, par2, …</em> are the list of non-orientation parameters
to the model in the order that they appear in the parameter table.
<strong>Note that the auto-generated model file uses</strong> <em>x</em> <strong>rather than</strong> <em>q</em>.</p>
<p>The <em>.py</em> file should import trigonometric and exponential functions from
numpy rather than from math.  This lets us evaluate the model for the whole
range of <span class="math notranslate nohighlight">\(q\)</span> values at once rather than looping over each <span class="math notranslate nohighlight">\(q\)</span> separately in
python.  With <span class="math notranslate nohighlight">\(q\)</span> as a vector, you cannot use if statements, but must instead
do tricks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">q</span><span class="o">&gt;</span><span class="mi">0</span>
<span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
<p>which sets <span class="math notranslate nohighlight">\(a\)</span> to <span class="math notranslate nohighlight">\(q \cdot x\)</span> if <span class="math notranslate nohighlight">\(q\)</span> is positive or <span class="math notranslate nohighlight">\(q \cdot y\)</span> if <span class="math notranslate nohighlight">\(q\)</span>
is zero or negative. If you have not converted your function to use <span class="math notranslate nohighlight">\(q\)</span>
vectors, you can set the following and it will only receive one <span class="math notranslate nohighlight">\(q\)</span>
value at a time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Iq</span><span class="o">.</span><span class="n">vectorized</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Return np.nan if the parameters are not valid (e.g., cap_radius &lt; radius in
barbell).  If I(q; pars) is NaN for any <span class="math notranslate nohighlight">\(q\)</span>, then those parameters will be
ignored, and not included in the calculation of the weighted polydispersity.</p>
<p>Models should define <em>form_volume(par1, par2, …)</em> where the parameter
list includes the <em>volume</em> parameters in order.  This is used for a weighted
volume normalization so that scattering is on an absolute scale.  For
solid shapes, the <em>I(q)</em> function should use <em>form_volume</em> squared
as its scale factor.  If <em>form_volume</em> is not defined, then the default
<em>form_volume = 1.0</em> will be used.</p>
<p>Hollow shapes, where the volume fraction of particle corresponds to the
material in the shell rather than the volume enclosed by the shape, must
also define a <em>shell_volume(par1, par2, …)</em> function.  The parameters
are the same as for <em>form_volume</em>.  Here the <em>I(q)</em> function should use
<em>shell_volume</em> squared instead of <em>form_volume</em> squared so that the scale
parameter corresponds to the volume fraction of material in the sample.
The structure factor calculation needs the volume fraction of the filled
shapes for its calculation, so the volume fraction parameter in the model
is automatically scaled by <em>form_volume/shell_volume</em> prior to calling the
structure factor.</p>
<p><a class="reference internal" href="special.html#special-functions"><span class="std std-ref">Special Functions</span></a> for scattering such as <span class="math notranslate nohighlight">\(3j_1(x)/x\)</span>
are available for both C and python.</p>
</section>
<section id="embedded-c-models">
<h3>Embedded C Models<a class="headerlink" href="#embedded-c-models" title="Link to this heading">¶</a></h3>
<p>Like pure python models, inline C models need to define an <em>Iq</em> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Iq</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    return I(q, par1, par2, ...);</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This expands into the equivalent C code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">Iq</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">Iq</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><em>form_volume</em> defines the volume of the shape. As in python models, it
includes only the volume parameters.</p>
<p><em>shell_volume</em> defines the volume of the shell for hollow shapes. As in
python models, it includes only the volume parameters.</p>
<p><strong>source=[‘fn.c’, …]</strong> includes the listed C source files in the
program before <em>Iq</em> and <em>form_volume</em> are defined. These can include
files from the <a class="reference internal" href="special.html#special-functions"><span class="std std-ref">Special Functions</span></a> library.</p>
<p><em>c_code</em> includes arbitrary C code into your kernel, which can be
handy for defining helper functions for <em>Iq</em> and <em>form_volume</em>. Note that
you can put the full function definition for <em>Iq</em> and <em>form_volume</em>
(include function declaration) into <em>c_code</em> as well, or put them into an
external C file and add that file to the list of sources.</p>
<p>Models are defined using double precision declarations for the
parameters and return values.  When a model is run using single
precision or long double precision, each variable is converted
to the target type, depending on the precision requested.</p>
<p><strong>Floating point constants must include the decimal point.</strong>  This allows us
to convert values such as 1.0 (double precision) to 1.0f (single precision)
so that expressions that use these values are not promoted to double precision
expressions.  Some graphics card drivers are confused when functions
that expect floating point values are passed integers, such as 4*atan(1); it
is safest to not use integers in floating point expressions.  Even better,
use the builtin constant M_PI rather than 4*atan(1); it is faster and smaller!</p>
<p>The C model operates on a single <span class="math notranslate nohighlight">\(q\)</span> value at a time.  The code will be
run in parallel across different <span class="math notranslate nohighlight">\(q\)</span> values, either on the graphics card
or the processor.</p>
<p>Rather than returning NAN from Iq, you must provide a conditional expression
which evaluates to True if the parameters are valid and False if they
are not.  This is provided in the python model file as <em>valid = “expr”</em>,
where <em>expr</em> is a C expression.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valid</span> <span class="o">=</span> <span class="s2">&quot;bell_radius &gt;= radius &amp;&amp; radius &gt;= 0&quot;</span>
</pre></div>
</div>
</section>
<section id="structure-factors">
<h3>Structure Factors<a class="headerlink" href="#structure-factors" title="Link to this heading">¶</a></h3>
<p>Structure factor calculations may need the underlying <span class="math notranslate nohighlight">\(&lt;F(q)&gt;\)</span> and <span class="math notranslate nohighlight">\(&lt;F^2(q)&gt;\)</span>
rather than <span class="math notranslate nohighlight">\(I(q)\)</span>.  This is used to compute <span class="math notranslate nohighlight">\(\beta = &lt;F(q)&gt;^2/&lt;F^2(q)&gt;\)</span> in
the decoupling approximation to the structure factor.</p>
<p>Instead of defining the <em>Iq</em> function, models can define <em>Fq</em> as
something like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">Fq</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">F1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">F2</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">Fq</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">F1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">F2</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Polar integration loop over all orientations.</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="o">*</span><span class="n">F1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">total_F1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">contrast</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">volume</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">F2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">total_F2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">square</span><span class="p">(</span><span class="n">contrast</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">volume</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">par1</span><span class="p">,</span><span class="w"> </span><span class="n">par2</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the volume fraction scale factor is built into the model (as occurs for
the vesicle model, for example), then scale <em>F1</em> by <span class="math notranslate nohighlight">\(\surd V_f\)</span> so that
<span class="math notranslate nohighlight">\(\beta\)</span> is computed correctly.</p>
<p>Structure factor calculations are not yet supported for oriented shapes.</p>
<p>Note: only available as a separate C file listed in <em>source</em>, or within
a <em>c_code</em> block within the python model definition file.</p>
</section>
<section id="oriented-shapes">
<h3>Oriented Shapes<a class="headerlink" href="#oriented-shapes" title="Link to this heading">¶</a></h3>
<p>If the scattering is dependent on the orientation of the shape, then you
will need to include <em>orientation</em> parameters <em>theta</em>, <em>phi</em> and <em>psi</em>
at the end of the parameter table.  As described in the section
<a class="reference internal" href="orientation/orientation.html#orientation"><span class="std std-ref">Oriented Particles</span></a>, the individual <span class="math notranslate nohighlight">\((q_x, q_y)\)</span> points on the detector will
be rotated into <span class="math notranslate nohighlight">\((q_a, q_b, q_c)\)</span> points relative to the sample in its
canonical orientation with <span class="math notranslate nohighlight">\(a\)</span>-<span class="math notranslate nohighlight">\(b\)</span>-<span class="math notranslate nohighlight">\(c\)</span> aligned with <span class="math notranslate nohighlight">\(x\)</span>-<span class="math notranslate nohighlight">\(y\)</span>-<span class="math notranslate nohighlight">\(z\)</span> in the
laboratory frame and beam travelling along <span class="math notranslate nohighlight">\(-z\)</span>.</p>
<p>The oriented C model (oriented pure Python models are not supported)
is called using <em>Iqabc(qa, qb, qc, par1, par2, …)</em> where
<em>par1</em>, etc. are the parameters to the model.  If the shape is rotationally
symmetric about <em>c</em> then <em>psi</em> is not needed, and the model is called
as <em>Iqac(qab, qc, par1, par2, …)</em>.  In either case, the orientation
parameters are not included in the function call.</p>
<p>For 1D oriented shapes, an integral over all angles is usually needed for
the <em>Iq</em> function. Given symmetry and the substitution <span class="math notranslate nohighlight">\(u = \cos(\alpha)\)</span>,
<span class="math notranslate nohighlight">\(du = -\sin(\alpha)\,d\alpha\)</span> this becomes</p>
<div class="math notranslate nohighlight">
\[\begin{split}I(q) &amp;= \frac{1}{4\pi} \int_{-\pi/2}^{pi/2} \int_{-pi}^{pi}
        F(q_a, q_b, q_c)^2 \sin(\alpha)\,d\beta\,d\alpha \\
    &amp;= \frac{8}{4\pi} \int_{0}^{pi/2} \int_{0}^{\pi/2}
        F^2 \sin(\alpha)\,d\beta\,d\alpha \\
    &amp;= \frac{8}{4\pi} \int_1^0 \int_{0}^{\pi/2} - F^2 \,d\beta\,du \\
    &amp;= \frac{8}{4\pi} \int_0^1 \int_{0}^{\pi/2} F^2 \,d\beta\,du\end{split}\]</div>
<p>for</p>
<div class="math notranslate nohighlight">
\[\begin{split}q_a &amp;= q \sin(\alpha)\sin(\beta) = q \sqrt{1-u^2} \sin(\beta) \\
q_b &amp;= q \sin(\alpha)\cos(\beta) = q \sqrt{1-u^2} \cos(\beta) \\
q_c &amp;= q \cos(\alpha) = q u\end{split}\]</div>
<p>Using the <span class="math notranslate nohighlight">\(z, w\)</span> values for Gauss-Legendre integration in “lib/gauss76.c”, the
numerical integration is then:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">outer_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GAUSS_N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">cos_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">GAUSS_Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">sin_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cos_alpha</span><span class="o">*</span><span class="n">cos_alpha</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos_alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">inner_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GAUSS_N</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI_4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">GAUSS_Z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">M_PI_4</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">sin_beta</span><span class="p">,</span><span class="w"> </span><span class="n">cos_beta</span><span class="p">;</span>
<span class="w">        </span><span class="n">SINCOS</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span><span class="n">sin_beta</span><span class="p">,</span><span class="w"> </span><span class="n">cos_beta</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin_alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin_beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin_alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos_beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fq</span><span class="p">(</span><span class="n">qa</span><span class="p">,</span><span class="w"> </span><span class="n">qb</span><span class="p">,</span><span class="w"> </span><span class="n">qc</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">        </span><span class="n">inner_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">GAUSS_W</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">form</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">outer_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">GAUSS_W</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inner_sum</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">outer_sum</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span><span class="w"> </span><span class="c1">// = 8/(4 pi) * outer_sum * (pi/2) / 4</span>
</pre></div>
</div>
<p>The <em>z</em> values for the Gauss-Legendre integration extends from -1 to 1, so
the double sum of <em>w[i]w[j]</em> explains the factor of 4.  Correcting for the
average <em>dz[i]dz[j]</em> gives <span class="math notranslate nohighlight">\((1-0) \cdot (\pi/2-0) = \pi/2\)</span>.  The <span class="math notranslate nohighlight">\(8/(4 \pi)\)</span>
factor comes from the integral over the quadrant.  With less symmetry (eg.,
in the bcc and fcc paracrystal models), then an integral over the entire
sphere may be necessary.</p>
<p>For simpler models which are rotationally symmetric a single integral
suffices:</p>
<div class="math notranslate nohighlight">
\[\begin{split}I(q) &amp;= \frac{1}{\pi}\int_{-\pi/2}^{\pi/2}
        F(q_{ab}, q_c)^2 \sin(\alpha)\,d\alpha/\pi \\
    &amp;= \frac{2}{\pi} \int_0^1 F^2\,du\end{split}\]</div>
<p>for</p>
<div class="math notranslate nohighlight">
\[\begin{split}q_{ab} &amp;= q \sin(\alpha) = q \sqrt{1 - u^2} \\
q_c &amp;= q \cos(\alpha) = q u\end{split}\]</div>
<p>with integration loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">double</span> <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GAUSS_N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">double</span> <span class="n">cos_alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">GAUSS_Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">double</span> <span class="n">sin_alpha</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cos_alpha</span><span class="o">*</span><span class="n">cos_alpha</span><span class="p">);</span>
    <span class="n">const</span> <span class="n">double</span> <span class="n">qab</span> <span class="o">=</span> <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">double</span> <span class="n">qc</span> <span class="o">=</span> <span class="n">cos_alpha</span> <span class="o">*</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">double</span> <span class="n">form</span> <span class="o">=</span> <span class="n">Fq</span><span class="p">(</span><span class="n">qab</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="o">...</span><span class="p">);</span>
    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">GAUSS_W</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">form</span> <span class="o">*</span> <span class="n">form</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">sum</span> <span class="o">*=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="o">//</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">pi</span> <span class="o">*</span> <span class="nb">sum</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</section>
<section id="magnetism">
<h3>Magnetism<a class="headerlink" href="#magnetism" title="Link to this heading">¶</a></h3>
<p>Magnetism is supported automatically for all shapes by modifying the
effective SLD of particle according to the Halpern-Johnson vector
describing the interaction between neutron spin and magnetic field.  All
parameters marked as type <em>sld</em> in the parameter table are treated as
possibly magnetic particles with magnitude <em>M0</em> and direction
<em>mtheta</em> and <em>mphi</em>.  Polarization parameters are also provided
automatically for magnetic models to set the spin state of the measurement.</p>
<p>For more complicated systems where magnetism is not uniform throughout
the individual particles, you will need to write your own models.
You should not mark the nuclear sld as type <em>sld</em>, but instead leave
them unmarked and provide your own magnetism and polarization parameters.
For 2D measurements you will need <span class="math notranslate nohighlight">\((q_x, q_y)\)</span> values for the measurement
to compute the proper magnetism and orientation, which you can implement
using <em>Iqxy(qx, qy, par1, par2, …)</em>.</p>
<p><strong>Note: Magnetism is not supported in pure Python models.</strong></p>
</section>
<section id="problems-with-c-models">
<h3>Problems with C models<a class="headerlink" href="#problems-with-c-models" title="Link to this heading">¶</a></h3>
<p>The graphics processor (GPU) in your computer is a specialized computer tuned
for certain kinds of problems.  This leads to strange restrictions that you
need to be aware of.  Your code may work fine on some platforms or for some
models, but then return bad values on other platforms.  Some examples of
particular problems:</p>
<blockquote>
<div><p><strong>(1) Code is too complex, or uses too much memory.</strong> GPU devices only
have a limited amount of memory available for each processor. If you run
programs which take too much memory, then rather than running multiple
values in parallel as it usually does, the GPU may only run a single
version of the code at a time, making it slower than running on the CPU.
It may fail to run on some platforms, or worse, cause the screen to go
blank or the system to reboot.</p>
<p><strong>(2) Code takes too long.</strong> Because GPU devices are used for the computer
display, the OpenCL drivers are very careful about the amount of time they
will allow any code to run. For example, on OS X, the model will stop
running after 5 seconds regardless of whether the computation is complete.
You may end up with only some of your 2D array defined, with the rest
containing random data. Or it may cause the screen to go blank or the
system to reboot.</p>
<p><strong>(3) Memory is not aligned</strong>. The GPU hardware is specialized to operate
on multiple values simultaneously. To keep the GPU simple the values in
memory must be aligned with the different GPU compute engines. Not
following these rules can lead to unexpected values being loaded into
memory, and wrong answers computed. The conclusion from a very long and
strange debugging session was that any arrays that you declare in your
model should be a multiple of four. For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">Iq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vector</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">  </span><span class="c1">// Only going to use seven slots, but declare 8</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>The first step when your model is behaving strangely is to set
<strong>single=False</strong>. This automatically restricts the model to only run on the
CPU, or on high-end GPU cards. There can still be problems even on high-end
cards, so you can force the model off the GPU by setting <strong>opencl=False</strong>.
This runs the model as a normal C program without any GPU restrictions so
you know that strange results are probably from your code rather than the
environment. Once the code is debugged, you can compare your output to the
output on the GPU.</p>
<p>Although it can be difficult to get your model to work on the GPU, the reward
can be a model that runs 1000x faster on a good card.  Even your laptop may
show a 50x improvement or more over the equivalent pure python model.</p>
</section>
<section id="form-factors">
<span id="id2"></span><h3>Form Factors<a class="headerlink" href="#form-factors" title="Link to this heading">¶</a></h3>
<p>Away from the dilute limit you can estimate scattering including
particle-particle interactions using <span class="math notranslate nohighlight">\(I(q) = P(q)*S(q)\)</span> where <span class="math notranslate nohighlight">\(P(q)\)</span>
is the form factor and <span class="math notranslate nohighlight">\(S(q)\)</span> is the structure factor.  The simplest
structure factor is the <em>hardsphere</em> interaction, which
uses the effective radius of the form factor as an input to the structure
factor model.  The effective radius is the weighted average over all
values of the shape in polydisperse systems.</p>
<p>There can be many notions of effective radius, depending on the shape.  For
a sphere it is clearly just the radius, but for an ellipsoid of revolution
we provide average curvature, equivalent sphere radius, minimum radius and
maximum radius.  These options are listed as <em>radius_effective_modes</em> in
the python model defintion, and must be computed by the <em>radius_effective</em>
function which takes the <em>radius_effective_mode</em> parameter as an integer,
along with the various model parameters.  Unlike normal C/Python arrays,
the first mode is 1, the second is 2, etc.  Mode 0 indicates that the
effective radius from the shape is to be ignored in favour of the the
effective radius parameter in the structure factor model.</p>
<p>Consider the core-shell sphere, which defines the following effective radius
modes in the python model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radius_effective_modes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;outer radius&quot;</span><span class="p">,</span>
    <span class="s2">&quot;core radius&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>and the following function in the C-file for the model:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">double</span>
<span class="nf">radius_effective</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">thickness</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">thickness</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">double</span>
<span class="nf">form_volume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">thickness</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">M_4PI_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cube</span><span class="p">(</span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">thickness</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Given polydispersity over <em>(r1, r2, …, rm)</em> in radius and <em>(t1, t2, …, tn)</em>
in thickness, <em>radius_effective</em> is called over a mesh grid covering all
possible combinations of radius and thickness, with a single <em>(ri, tj)</em> pair
in each call. The weights each of these results according to the
polydispersity distributions and calls the structure factor with the average
effective radius.  Similarly, for <em>form_volume</em>.</p>
<p>Hollow models have an additional volume ratio which is needed to scale the
structure factor.  The structure factor uses the volume fraction of the filled
particles as part of its density estimate, but the scale factor for the
scattering intensity (as non-solvent volume fraction / volume) is determined
by the shell volume only.  Therefore the <em>shell_volume</em> function is
needed to compute the form:shell volume ratio, which then scales the
<em>volfraction</em> parameter prior to calling the structure factor calculator.
In the case of a hollow sphere, this would be:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">double</span>
<span class="nf">shell_volume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">thickness</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">whole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_4PI_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cube</span><span class="p">(</span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">thickness</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_4PI_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cube</span><span class="p">(</span><span class="n">radius</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">whole</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If <em>shell_volume</em> is not present, then <em>form_volume</em> and <em>shell_volume</em> are
assumed to be equal, and the shape is considered solid.</p>
</section>
<section id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading">¶</a></h3>
<p>THESE ARE VERY IMPORTANT. Include at least one test for each model and
PLEASE make sure that the answer value is correct (i.e. not a random number).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[{},</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.726362</span><span class="p">],</span>
    <span class="p">[{</span><span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">&quot;sld&quot;</span><span class="p">:</span> <span class="mf">6.</span><span class="p">,</span> <span class="s2">&quot;sld_solvent&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
      <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">120.</span><span class="p">,</span> <span class="s2">&quot;radius_pd&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;radius_pd_n&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">},</span>
     <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.228843</span><span class="p">],</span>
    <span class="p">[{</span><span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">120.</span><span class="p">,</span> <span class="s2">&quot;radius_pd&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;radius_pd_n&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">},</span>
     <span class="mf">0.1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">120.</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>  <span class="c1"># q, F, F^2, R_eff, V, form:shell</span>
    <span class="p">[{</span><span class="s2">&quot;@S&quot;</span><span class="p">:</span> <span class="s2">&quot;hardsphere&quot;</span><span class="p">},</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">[{</span><span class="s2">&quot;@S&quot;</span><span class="p">:</span> <span class="s2">&quot;hardsphere&quot;</span><span class="p">},</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;S_eff(Q)&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">}],</span>
<span class="p">]</span>
</pre></div>
</div>
<p><strong>tests=[[{parameters}, q, Iq], …]</strong> is a list of lists.
Each list is one test and contains, in order:</p>
<ul class="simple">
<li><p>a dictionary of parameter values. This can be <em>{}</em> using the default
parameters, or filled with some parameters that will be different from the
default, such as <em>{“radius”:10.0, “sld”:4}</em>. Unlisted parameters will
be given the default values.</p></li>
<li><p>the input <span class="math notranslate nohighlight">\(q\)</span> value or tuple of <span class="math notranslate nohighlight">\((q_x, q_y)\)</span> values.</p></li>
<li><p>the output <span class="math notranslate nohighlight">\(I(q)\)</span> or <span class="math notranslate nohighlight">\(I(q_x,q_y)\)</span> expected of the model for the parameters
and input value given.</p></li>
<li><p>input and output values can themselves be lists if you have several
<span class="math notranslate nohighlight">\(q\)</span> values to test for the same model parameters.</p></li>
<li><p>for testing effective radius, volume and form:shell volume ratio, use the
extended form of the tests results, with <em>None, None, R_eff, V, V_r</em>
instead of <em>Iq</em>.  This calls the kernel <em>Fq</em> function instead of <em>Iq</em>.</p></li>
<li><p>for testing F and F^2 (used for beta approximation) do the same as the
effective radius test, but include values for the first two elements,
<span class="math notranslate nohighlight">\(&lt;F(q)&gt;\)</span> and <span class="math notranslate nohighlight">\(&lt;F^2(q)&gt;\)</span>.</p></li>
<li><p>for testing interaction between form factor and structure factor, specify
the structure factor name in the parameters as <em>{“&#64;S”: “name”, …}</em> with
the remaining list of parameters defined by the <em>P&#64;S</em> interaction model.</p></li>
<li><p>for examining the intermediate results computed by the model, use the
extended form with <em>{“key”: value}</em> pairs, one for each intermediate value
returned from the model.  Starting with an empty <em>{}</em> will produce a
complete list of computed intermediates.</p></li>
</ul>
</section>
</section>
<section id="test-your-new-model">
<span id="id3"></span><h2>Test Your New Model<a class="headerlink" href="#test-your-new-model" title="Link to this heading">¶</a></h2>
<section id="minimal-testing">
<h3>Minimal Testing<a class="headerlink" href="#minimal-testing" title="Link to this heading">¶</a></h3>
<p>In SasView 5.x, plugin models are loaded ‘on-the-fly’. So to test a plugin
go to a FitPage (or create a new one with <em>Fitting</em> &gt; <em>New Fit Page</em>),
select <em>Category</em> &gt; <em>Plugin Models</em>, and then select your model from the
<em>Model Name</em> dropdown. Then click the <em>Calculate</em> button. If the model
compiles succesfully, two things will happen: the <em>Calculate</em> button will
change to <em>Show Plot</em>, and in the <em>Log Explorer</em> window something like
this will appear, possibly followed by a report of the unit test in your
plugin model:</p>
<blockquote>
<div><p>11:06:37 - INFO: make python model peak_voigt</p>
</div></blockquote>
<p>If compilation of your plugin model fails, then Python traceback information
will appear in the Log Explorer:</p>
<blockquote>
<div><p>11:32:47 - INFO: make python model dummy_voigt</p>
<p>11:32:47 - ERROR: Traceback (most recent call last):</p>
</div></blockquote>
<p>If you look closely at traceback it should tell you why compilation is failing.
A very common reason is simply that a variable name has been misspelt. Look for
a line that begins <em>NameError</em>.</p>
</section>
<section id="recommended-testing">
<h3>Recommended Testing<a class="headerlink" href="#recommended-testing" title="Link to this heading">¶</a></h3>
<p><strong>NB: For now, this more detailed testing is only possible if you have a
SasView build environment available!</strong></p>
<p>If the model compiles and runs, you can next run the unit tests that
you have added using the <strong>test =</strong> values.</p>
<p>From SasView, switch to the <em>Shell</em> tab and type the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sasmodels.model_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_one</span>
<span class="n">run_one</span><span class="p">(</span><span class="s2">&quot;~/.sasview/plugin_models/model.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This should print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_model_python</span> <span class="p">(</span><span class="n">sasmodels</span><span class="o">.</span><span class="n">model_test</span><span class="o">.</span><span class="n">ModelTestCase</span><span class="p">)</span> <span class="o">...</span> <span class="n">ok</span>
</pre></div>
</div>
<p>To check whether single precision is good enough, type the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sasmodels.compare</span><span class="w"> </span><span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">compare</span>
<span class="n">compare</span><span class="p">(</span><span class="s2">&quot;~/.sasview/plugin_models/model.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will pop up a plot showing the difference between single precision
and double precision on a range of <span class="math notranslate nohighlight">\(q\)</span> values.</p>
<p>These commands can also be run directly in the python interpreter:</p>
<blockquote>
<div><p>$ python -m sasmodels.model_test -v ~/.sasview/plugin_models/model.py
$ python -m sasmodels.compare ~/.sasview/plugin_models/model.py</p>
</div></blockquote>
<p>The options to compare are quite extensive; type the following for help:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span><span class="p">()</span>
</pre></div>
</div>
<p>Options will need to be passed as separate strings.
For example to run your model with a random set of parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span><span class="p">(</span><span class="s2">&quot;-random&quot;</span><span class="p">,</span> <span class="s2">&quot;-pars&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.sasview/plugin_models/model.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For the random models,</p>
<ul class="simple">
<li><p><em>sld</em> will be in the range (-0.5,10.5),</p></li>
<li><p>angles (<em>theta, phi, psi</em>) will be in the range (-180,180),</p></li>
<li><p>angular dispersion will be in the range (0,45),</p></li>
<li><p>polydispersity will be in the range (0,1)</p></li>
<li><p>other values will be in the range (0, 2<em>v</em>), where <em>v</em> is the default
parameter value.</p></li>
</ul>
<p>Dispersion parameters <em>n</em>, <em>sigma</em> and <em>type</em> will be set to random
values if “-poly” is included on the command line.  be unchanged from
demo so that run times are more predictable (polydispersity calculated
across multiple parameters can be very slow).</p>
<p>If your model has 2D orientation calculation, then you should also
test with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span><span class="p">(</span><span class="s2">&quot;-2d&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.sasview/plugin_models/model.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="check-the-docs">
<h2>Check The Docs<a class="headerlink" href="#check-the-docs" title="Link to this heading">¶</a></h2>
<p>You can get a rough idea of how the documentation will look using the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span><span class="p">(</span><span class="s2">&quot;-help&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.sasview/plugin_models/model.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This does not use the same styling as the rest of the docs, but it will
allow you to check that your ReStructuredText and LaTeX formatting.
Here are some tools to help with the inevitable syntax errors:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://matplotlib.org/sampledoc/cheatsheet.html">Sphinx cheat sheet</a></p></li>
<li><p><a class="reference external" href="http://www.sphinx-doc.org/en/stable/">Sphinx Documentation</a></p></li>
<li><p><a class="reference external" href="http://www.mathjax.org/">MathJax</a></p></li>
<li><p><a class="reference external" href="http://www.ams.org/publications/authors/tex/amslatex">amsmath</a></p></li>
</ul>
<p>There is also a neat online WYSIWYG ReStructuredText editor at
<a class="reference external" href="http://rst.ninjs.org">http://rst.ninjs.org</a>.</p>
</section>
<section id="clean-lint-developer-version-only">
<h2>Clean Lint - (Developer Version Only)<a class="headerlink" href="#clean-lint-developer-version-only" title="Link to this heading">¶</a></h2>
<p><strong>NB: For now we are not providing pylint with the installer version
of SasView; so unless you have a SasView build environment available,
you can ignore this section!</strong></p>
<p>Run the lint check with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pylint</span> <span class="o">--</span><span class="n">rcfile</span><span class="o">=</span><span class="n">extra</span><span class="o">/</span><span class="n">pylint</span><span class="o">.</span><span class="n">rc</span> <span class="o">~/.</span><span class="n">sasview</span><span class="o">/</span><span class="n">plugin_models</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>We are not aiming for zero lint just yet, only keeping it to a minimum.
For now, don’t worry too much about <em>invalid-name</em>. If you really want a
variable name <em>Rg</em> for example because <span class="math notranslate nohighlight">\(R_g\)</span> is the right name for the model
parameter then ignore the lint errors.  Also, ignore <em>missing-docstring</em>
for standard model functions <em>Iq</em>, <em>Iqac</em>, etc.</p>
<p>We will have delinting sessions at the SasView Code Camps, where we can
decide on standards for model files, parameter names, etc.</p>
<p>For now, you can tell pylint to ignore things.  For example, to align your
parameters in blocks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># pylint: disable=bad-whitespace,line-too-long</span>
<span class="c1">#   [&quot;name&quot;,                  &quot;units&quot;, default, [lower, upper], &quot;type&quot;, &quot;description&quot;],</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;contrast_factor&quot;</span><span class="p">,</span>       <span class="s2">&quot;barns&quot;</span><span class="p">,</span>    <span class="mf">10.0</span><span class="p">,</span>  <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Contrast factor of the polymer&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;bjerrum_length&quot;</span><span class="p">,</span>        <span class="s2">&quot;Ang&quot;</span><span class="p">,</span>       <span class="mf">7.1</span><span class="p">,</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span>    <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Bjerrum length&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;virial_param&quot;</span><span class="p">,</span>          <span class="s2">&quot;1/Ang^2&quot;</span><span class="p">,</span>  <span class="mf">12.0</span><span class="p">,</span>  <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Virial parameter&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;monomer_length&quot;</span><span class="p">,</span>        <span class="s2">&quot;Ang&quot;</span><span class="p">,</span>      <span class="mf">10.0</span><span class="p">,</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span>    <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Monomer length&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;salt_concentration&quot;</span><span class="p">,</span>    <span class="s2">&quot;mol/L&quot;</span><span class="p">,</span>     <span class="mf">0.0</span><span class="p">,</span>  <span class="p">[</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Concentration of monovalent salt&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;ionization_degree&quot;</span><span class="p">,</span>     <span class="s2">&quot;&quot;</span><span class="p">,</span>          <span class="mf">0.05</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span>    <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Degree of ionization&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;polymer_concentration&quot;</span><span class="p">,</span> <span class="s2">&quot;mol/L&quot;</span><span class="p">,</span>     <span class="mf">0.7</span><span class="p">,</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf</span><span class="p">],</span>    <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Polymer molar concentration&quot;</span><span class="p">],</span>
    <span class="p">]</span>
<span class="c1"># pylint: enable=bad-whitespace,line-too-long</span>
</pre></div>
</div>
<p>Don’t put in too many pylint statements, though, since they make the code ugly.</p>
</section>
<section id="share-your-model">
<h2>Share Your Model!<a class="headerlink" href="#share-your-model" title="Link to this heading">¶</a></h2>
<p>Once compare and the unit test(s) pass properly and everything is done,
consider adding your model to the
<a class="reference external" href="http://marketplace.sasview.org/">Model Marketplace</a> so that others may use it!</p>
<p><em>Document History</em></p>
<div class="line-block">
<div class="line">2016-10-25 Steve King</div>
<div class="line">2017-05-07 Paul Kienzle - Moved from sasview to sasmodels docs</div>
<div class="line">2019-03-28 Paul Kienzle - Update docs for radius_effective and shell_volume</div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Writing a Plugin Model</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#create-new-model-files">Create New Model Files</a></li>
<li><a class="reference internal" href="#edit-new-model-files">Edit New Model Files</a><ul>
<li><a class="reference internal" href="#model-contents">Model Contents</a></li>
<li><a class="reference internal" href="#composite-models">Composite Models</a></li>
<li><a class="reference internal" href="#reparameterized-models">Reparameterized Models</a></li>
<li><a class="reference internal" href="#model-documentation">Model Documentation</a></li>
<li><a class="reference internal" href="#model-definition">Model Definition</a></li>
<li><a class="reference internal" href="#model-parameters">Model Parameters</a></li>
<li><a class="reference internal" href="#model-computation">Model Computation</a></li>
<li><a class="reference internal" href="#python-models">Python Models</a></li>
<li><a class="reference internal" href="#embedded-c-models">Embedded C Models</a></li>
<li><a class="reference internal" href="#structure-factors">Structure Factors</a></li>
<li><a class="reference internal" href="#oriented-shapes">Oriented Shapes</a></li>
<li><a class="reference internal" href="#magnetism">Magnetism</a></li>
<li><a class="reference internal" href="#problems-with-c-models">Problems with C models</a></li>
<li><a class="reference internal" href="#form-factors">Form Factors</a></li>
<li><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-your-new-model">Test Your New Model</a><ul>
<li><a class="reference internal" href="#minimal-testing">Minimal Testing</a></li>
<li><a class="reference internal" href="#recommended-testing">Recommended Testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#check-the-docs">Check The Docs</a></li>
<li><a class="reference internal" href="#clean-lint-developer-version-only">Clean Lint - (Developer Version Only)</a></li>
<li><a class="reference internal" href="#share-your-model">Share Your Model!</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="sesans/sesans_fitting.html"
                          title="previous chapter">Fitting SESANS Data from the Command Line</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="scripting.html"
                          title="next chapter">Scripting Interface</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/user/qtgui/Perspectives/Fitting/plugin.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="scripting.html" title="Scripting Interface"
             >next</a> |</li>
        <li class="right" >
          <a href="sesans/sesans_fitting.html" title="Fitting SESANS Data from the Command Line"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">SasView 6.1.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../user.html" >SasView User Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../analysis.html" >Fitting &amp; Other Analyses</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="fitting.html" >Fitting Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Writing a Plugin Model</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, The SasView Project.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>