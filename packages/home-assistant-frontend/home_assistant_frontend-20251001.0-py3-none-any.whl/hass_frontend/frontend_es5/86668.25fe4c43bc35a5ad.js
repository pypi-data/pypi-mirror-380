"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["86668"],{45863:function(t,e,s){s.a(t,async function(t,a){try{s.r(e),s.d(e,{HuiEnergyDevicesDetailGraphCard:function(){return E}});s(79827),s(35748),s(99342),s(9724),s(35058),s(65315),s(837),s(84136),s(22416),s(37089),s(48169),s(12977),s(67579),s(18223),s(30500),s(95013);var o=s(69868),i=s(76174),n=s(30765),r=s(84922),d=s(11991),c=s(75907),h=s(65940),_=s(94327),p=s(42029),u=(s(70490),s(68717)),l=s(43716),m=s(63002),f=s(40328),g=s(8510),v=s(36886),y=s(20051),b=s(8868),k=t([u,l,m,b,v]);[u,l,m,b,v]=k.then?(await k)():k;let S,$,C,D=t=>t;const w="kWh";class E extends((0,f.E)(r.WF)){hassSubscribe(){var t;return[(0,l.tb)(this.hass,{key:null===(t=this._config)||void 0===t?void 0:t.collection_key}).subscribe(t=>{this._data=t})]}getCardSize(){return 3}setConfig(t){this._config=t}shouldUpdate(t){return(0,g.xP)(this,t)||t.size>1||!t.has("hass")}willUpdate(t){(t.has("_config")||t.has("_data"))&&this._processStatistics()}render(){return this.hass&&this._config?(0,r.qy)(S||(S=D` <ha-card> ${0} <div class="content ${0}"> <ha-chart-base .hass="${0}" .data="${0}" .options="${0}" @dataset-hidden="${0}" @dataset-unhidden="${0}"></ha-chart-base> </div> </ha-card> `),this._config.title?(0,r.qy)($||($=D`<h1 class="card-header">${0}</h1>`),this._config.title):"",(0,c.H)({"has-header":!!this._config.title}),this.hass,this._chartData,this._createOptions(this._start,this._end,this.hass.locale,this.hass.config,w,this._compareStart,this._compareEnd),this._datasetHidden,this._datasetUnhidden):r.s6}_datasetHidden(t){this._hiddenStats=[...this._hiddenStats,this._getStatIdFromId(t.detail.id)]}_datasetUnhidden(t){this._hiddenStats=this._hiddenStats.filter(e=>e!==this._getStatIdFromId(t.detail.id))}_processStatistics(){if(!this._data)return;const t=this._data;this._start=t.start,this._end=t.end||(0,i.o)(),this._compareStart=t.startCompare,this._compareEnd=t.endCompare;const e=t.stats,s=t.statsCompare,a=getComputedStyle(this),o=t.prefs.device_consumption,n={};o.forEach(t=>{t.included_in_stat&&(n[t.included_in_stat]=n[t.included_in_stat]||[],n[t.included_in_stat].push(t.stat_consumption))});const r={};t.prefs.device_consumption.forEach(t=>{const s=t.stat_consumption in e&&(0,m.$j)(e[t.stat_consumption])||0;r[t.stat_consumption]=s});const d={};t.prefs.device_consumption.forEach(t=>{d[t.stat_consumption]=(n[t.stat_consumption]||[]).reduce((t,e)=>t-r[e],r[t.stat_consumption])});const c=t.prefs.device_consumption.map(t=>t.stat_consumption);c.sort((t,e)=>d[e]-d[t]);const h=[],{summedData:_,compareSummedData:p}=(0,l.gv)(t),u="from_grid"in _||"solar"in _||"from_battery"in _,{consumption:f,compareConsumption:g}=u?(0,l.DR)(_,p):{consumption:void 0,compareConsumption:void 0};if(s){const e=this._processDataSet(a,s,t.statsMetadata,t.prefs.device_consumption,c,n,!0);if(h.push(...e),u){const t=this._processUntracked(a,e,g,!0);h.push(t)}}h.push({id:"compare-placeholder",type:"bar",stack:t.statsCompare?"devicesCompare":"devices",data:[]});const y=this._processDataSet(a,e,t.statsMetadata,t.prefs.device_consumption,c,n);if(h.push(...y),this._legendData=y.map(t=>{var e;return{id:t.id,secondaryIds:[`compare-${t.id}`],name:t.name,itemStyle:{color:t.color,borderColor:null===(e=t.itemStyle)||void 0===e?void 0:e.borderColor}}}),u){var b;const t=this._processUntracked(a,y,f,!1);h.push(t),this._legendData.push({id:t.id,secondaryIds:[`compare-${t.id}`],name:t.name,itemStyle:{color:t.color,borderColor:null===(b=t.itemStyle)||void 0===b?void 0:b.borderColor}})}(0,v.RR)(h),this._chartData=h}_processUntracked(t,e,s,a){const o={};e.forEach(t=>{t.data.forEach(t=>{o[t[a?2:0]]=(o[t[a?2:0]]||0)+t[1]})});const i=(0,v.ok)(this._start,this._compareStart),n=[];Object.keys(s.used_total).sort((t,e)=>Number(t)-Number(e)).forEach(t=>{const e=Number(t),r=[e,s.used_total[t]-(o[t]||0)];a&&(r[2]=r[0],r[0]=i(new Date(e)).getTime()),n.push(r)});const r=Date.now();return{type:"bar",cursor:"default",id:a?`compare-untracked-${r}`:`untracked-${r}`,name:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),itemStyle:{borderColor:(0,p.g)(t,this.hass.themes.darkMode,!1,a,"--history-unknown-color")},barMaxWidth:50,color:(0,p.g)(t,this.hass.themes.darkMode,!0,a,"--history-unknown-color"),data:n,stack:a?"devicesCompare":"devices"}}_processDataSet(t,e,s,a,o,i,n=!1){const r=[],d=(0,v.ok)(this._start,this._compareStart);return a.forEach((a,c)=>{var h;const p=o.indexOf(a.stat_consumption);if(null!==(h=this._config)&&void 0!==h&&h.max_devices&&p>=this._config.max_devices)return void console.warn(`Max devices exceeded for ${a.name} (${p} >= ${this._config.max_devices})`);const u=(0,_.fI)(c,t);let l=null;const f=[];if(a.stat_consumption in e){const t=e[a.stat_consumption];for(const s of t){if(null===s.change||void 0===s.change||0===s.change)continue;if(l===s.start)continue;let t=0;(i[a.stat_consumption]||[]).forEach(a=>{var o;const i=e[a];t+=(null==i||null===(o=i.find(t=>t.start===s.start))||void 0===o?void 0:o.change)||0});const o=[s.start,s.change-t];n&&(o[2]=o[0],o[0]=d(new Date(s.start)).getTime()),f.push(o),l=s.start}}const g=(a.name||(0,m.$O)(this.hass,a.stat_consumption,s[a.stat_consumption]))+(a.stat_consumption in i?` (${this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked")})`:"");r.push({type:"bar",cursor:"default",id:n?`compare-${a.stat_consumption}-${p}`:`${a.stat_consumption}-${p}`,name:g,itemStyle:{borderColor:n?u+"7F":u},barMaxWidth:50,color:n?u+"32":u+"7F",data:f,stack:n?"devicesCompare":"devices"})}),o.map(t=>r.find(e=>this._getStatIdFromId(e.id)===t)).filter(Boolean)}_getStatIdFromId(t){return t.replace(/^compare-/,"").replace(/-\d+$/,"")}constructor(...t){super(...t),this._chartData=[],this._start=(0,n.R)(),this._end=(0,i.o)(),this._hiddenStats=[],this.hassSubscribeRequiredHostProps=["_config"],this._formatTotal=t=>this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_consumed",{num:(0,b.ZV)(t,this.hass.locale),unit:w}),this._createOptions=(0,h.A)((t,e,s,a,o,i,n)=>{const r=(0,v.od)(t,e,s,a,o,i,n,this._formatTotal),d=this._legendData?this._legendData.filter(t=>t.id&&this._hiddenStats.includes(this._getStatIdFromId(t.id))).reduce((t,e)=>(t[e.id]=!1,t),{}):{};return Object.assign(Object.assign({},r),{},{legend:{show:!0,type:"custom",data:this._legendData,selected:d},grid:{top:15,bottom:0,left:1,right:1,containLabel:!0}})})}}E.styles=(0,r.AH)(C||(C=D`.card-header{padding-bottom:0}.content{padding:16px}.has-header{padding-top:0}`)),(0,o.__decorate)([(0,d.MZ)({attribute:!1})],E.prototype,"hass",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_config",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_chartData",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_data",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_legendData",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_start",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_end",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_compareStart",void 0),(0,o.__decorate)([(0,d.wk)()],E.prototype,"_compareEnd",void 0),(0,o.__decorate)([(0,d.wk)(),(0,y.I)({key:"energy-devices-hidden-stats",state:!0,subscribe:!1})],E.prototype,"_hiddenStats",void 0),E=(0,o.__decorate)([(0,d.EM)("hui-energy-devices-detail-graph-card")],E),a()}catch(S){a(S)}})}}]);
//# sourceMappingURL=86668.25fe4c43bc35a5ad.js.map