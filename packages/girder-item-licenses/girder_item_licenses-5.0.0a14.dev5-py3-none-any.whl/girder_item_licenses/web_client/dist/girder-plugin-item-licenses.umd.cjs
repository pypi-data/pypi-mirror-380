(function(b){typeof define=="function"&&define.amd?define(b):b()})(function(){"use strict";function b(u){var e=""+u,s=O.exec(e);if(!s)return u;var i,t,c,n="";for(i=s.index,t=0;i<e.length;i++){switch(e.charCodeAt(i)){case 34:c="&quot;";break;case 38:c="&amp;";break;case 60:c="&lt;";break;case 62:c="&gt;";break;default:continue}t!==i&&(n+=e.substring(t,i)),t=i+1,n+=c}return t!==i?n+e.substring(t,i):n}var O=/["&<>]/;function W(u,e,s,i){if(!(u instanceof Error))throw u;if(!(typeof window>"u"&&e||i))throw u.message+=" on line "+s,u;var t,c,n,g;try{i=i||require("fs").readFileSync(e,{encoding:"utf8"}),t=3,c=i.split(`
`),n=Math.max(s-t,0),g=Math.min(c.length,s+t)}catch(r){return u.message+=" - could not read from "+e+" ("+r.message+")",void W(u,null,s)}t=c.slice(n,g).map(function(r,o){var F=o+n+1;return(F==s?"  > ":"    ")+F+"| "+r}).join(`
`),u.path=e;try{u.message=(e||"Pug")+":"+s+`
`+t+`

`+u.message}catch{}throw u}function J(u){var e="",s,i,t;try{var c=u||{};(function(n){t=1,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<div class="g-config-breadcrumb-container"></div>',t=2,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<p class="g-item-licenses-description">',t=3,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+"Configure the available licenses for items.</p>",t=4,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<form id="g-item-licenses-settings-form" role="form">',t=5,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<div class="form-group">',t=6,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<label class="control-label" for="g-item-licenses">',t=6,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+"Licenses</label>",t=7,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<textarea class="form-control" id="g-item-licenses">',t=7,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+b((s=n)==null?"":s)+"</textarea></div>",t=8,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<p class="g-validation-failed-message" id="g-item-licenses-error-message"></p>',t=9,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<input class="btn btn-sm btn-primary" type="submit" value="Save"/>',t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/configView.pug",e=e+'<input class="btn btn-sm btn-default" id="g-item-licenses-defaults" type="button" value="Reset to defaults"/></form>'}).call(this,"licenses"in c?c.licenses:typeof licenses<"u"?licenses:void 0)}catch(n){W(n,i,t)}return e}const ne="",T=girder.views.widgets.PluginConfigBreadcrumbWidget,R=girder.views.View,G=girder.events,{restRequest:v}=girder.rest;var D=R.extend({events:{"submit #g-item-licenses-settings-form":function(u){u.preventDefault(),this.$("#g-item-licenses-error-message").empty(),this._saveSettings([{key:"item_licenses.licenses",value:this.$("#g-item-licenses").val().trim()}])},"click #g-item-licenses-defaults":function(u){u.preventDefault(),v({method:"GET",url:"item/licenses",data:{default:!0}}).done(e=>{this.licenses=e,this.render()})}},initialize:function(){v({method:"GET",url:"system/setting",data:{list:JSON.stringify(["item_licenses.licenses"])}}).done(u=>{this.licenses=u["item_licenses.licenses"],this.render()})},render:function(){return this.$el.html(J({licenses:JSON.stringify(this.licenses,null,4)})),this.breadcrumb=new T({pluginName:"Item licenses",el:this.$(".g-config-breadcrumb-container"),parentView:this}).render(),this},_saveSettings:function(u){v({method:"PUT",url:"system/setting",data:{list:JSON.stringify(u)},error:null}).done(()=>{G.trigger("g:alert",{icon:"ok",text:"Settings saved.",type:"success",timeout:3e3})}).fail(e=>{this.$("#g-item-licenses-error-message").text(e.responseJSON.message)})}});const z=girder.router,A=girder.events,{exposePluginConfig:B}=girder.utilities.PluginUtils;B("item_licenses","plugins/item_licenses/config"),z.route("plugins/item_licenses/config","itemLicensesConfig",function(){A.trigger("g:navigateTo",D)});function m(u,e,s,i){if(e===!1||e==null||!e&&(u==="class"||u==="style"))return"";if(e===!0)return" "+(i?u:u+'="'+u+'"');var t=typeof e;return t!=="object"&&t!=="function"||typeof e.toJSON!="function"||(e=e.toJSON()),typeof e=="string"||(e=JSON.stringify(e),s||e.indexOf('"')===-1)?(s&&(e=p(e))," "+u+'="'+e+'"'):" "+u+"='"+e.replace(/'/g,"&#39;")+"'"}function p(u){var e=""+u,s=H.exec(e);if(!s)return u;var i,t,c,n="";for(i=s.index,t=0;i<e.length;i++){switch(e.charCodeAt(i)){case 34:c="&quot;";break;case 38:c="&amp;";break;case 60:c="&lt;";break;case 62:c="&gt;";break;default:continue}t!==i&&(n+=e.substring(t,i)),t=i+1,n+=c}return t!==i?n+e.substring(t,i):n}var H=/["&<>]/;function V(u,e,s,i){if(!(u instanceof Error))throw u;if(!(typeof window>"u"&&e||i))throw u.message+=" on line "+s,u;var t,c,n,g;try{i=i||require("fs").readFileSync(e,{encoding:"utf8"}),t=3,c=i.split(`
`),n=Math.max(s-t,0),g=Math.min(c.length,s+t)}catch(r){return u.message+=" - could not read from "+e+" ("+r.message+")",void V(u,null,s)}t=c.slice(n,g).map(function(r,o){var F=o+n+1;return(F==s?"  > ":"    ")+F+"| "+r}).join(`
`),u.path=e;try{u.message=(e||"Pug")+":"+s+`
`+t+`

`+u.message}catch{}throw u}function K(u){var e="",s,i,t;try{var c=u||{};(function(n,g){t=1,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+'<div class="g-select-license form-group">',t=2,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+'<label for="g-license">',t=2,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"License</label>",t=3,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+'<select class="form-control input-sm" id="g-license">',t=4,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+'<option value="">',t=4,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"Unspecified</option>",t=5,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",g&&(t=6,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",(function(){var r=g;if(typeof r.length=="number")for(var o=0,F=r.length;o<F;o++){var _=r[o];t=7,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<optgroup"+m("label",_.category,!0,!1)+">",t=8,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",(function(){var f=_.licenses;if(typeof f.length=="number")for(var h=0,$=f.length;h<$;h++){var l=f[h];t=9,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug";var a=null;l.name===n&&(a="selected"),t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<option"+(m("value",l.name,!0,!1)+m("selected",a,!0,!1))+">",t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+p((s=l.name)==null?"":s)+"</option>"}else{var $=0;for(var h in f){$++;var l=f[h];t=9,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug";var a=null;l.name===n&&(a="selected"),t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<option"+(m("value",l.name,!0,!1)+m("selected",a,!0,!1))+">",t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+p((s=l.name)==null?"":s)+"</option>"}}}).call(this),e=e+"</optgroup>"}else{var F=0;for(var o in r){F++;var _=r[o];t=7,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<optgroup"+m("label",_.category,!0,!1)+">",t=8,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",(function(){var l=_.licenses;if(typeof l.length=="number")for(var a=0,L=l.length;a<L;a++){var d=l[a];t=9,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug";var w=null;d.name===n&&(w="selected"),t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<option"+(m("value",d.name,!0,!1)+m("selected",w,!0,!1))+">",t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+p((s=d.name)==null?"":s)+"</option>"}else{var L=0;for(var a in l){L++;var d=l[a];t=9,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug";var w=null;d.name===n&&(w="selected"),t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+"<option"+(m("value",d.name,!0,!1)+m("selected",w,!0,!1))+">",t=10,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/selectLicenseWidget.pug",e=e+p((s=d.name)==null?"":s)+"</option>"}}}).call(this),e=e+"</optgroup>"}}}).call(this)),e=e+"</select></div>"}).call(this,"currentLicense"in c?c.currentLicense:typeof currentLicense<"u"?currentLicense:void 0,"licenses"in c?c.licenses:typeof licenses<"u"?licenses:void 0)}catch(n){V(n,i,t)}return e}var x=girder.views.View.extend({initialize:function(u){this.licenses=u.licenses,this.currentLicense=u.currentLicense},render:function(){return this.$el.html(K({licenses:this.licenses,currentLicense:this.currentLicense})),this}});const Q=girder.$,X=girder._,E=girder.views.widgets.EditItemWidget,{wrap:j}=girder.utilities.PluginUtils;j(E,"render",function(u){if(u.call(this),X.has(this.parentView,"licenses")){var e=null;this.item&&this.item.has("license")&&(e=this.item.get("license"));var s=new x({licenses:this.parentView.licenses,currentLicense:e,parentView:this}).render();Q(".modal-body > .form-group").last().after(s.el),delete this.parentView.licenses}return this}),j(E,"updateItem",function(u){var e=arguments[1];return e.license=this.$("#g-license").val(),u.call(this,e),this}),j(E,"createItem",function(u){var e=arguments[1];return e.license=this.$("#g-license").val(),u.call(this,e),this});const k=girder.views.widgets.HierarchyWidget,{restRequest:S}=girder.rest,{wrap:I}=girder.utilities.PluginUtils;I(k,"uploadDialog",function(u){return S({method:"GET",url:"item/licenses"}).done(e=>{this.licenses=e,u.call(this)}),this}),I(k,"createItemDialog",function(u){return S({method:"GET",url:"item/licenses"}).done(e=>{this.licenses=e,u.call(this)}),this});function Y(u){var e=""+u,s=Z.exec(e);if(!s)return u;var i,t,c,n="";for(i=s.index,t=0;i<e.length;i++){switch(e.charCodeAt(i)){case 34:c="&quot;";break;case 38:c="&amp;";break;case 60:c="&lt;";break;case 62:c="&gt;";break;default:continue}t!==i&&(n+=e.substring(t,i)),t=i+1,n+=c}return t!==i?n+e.substring(t,i):n}var Z=/["&<>]/;function P(u,e,s,i){if(!(u instanceof Error))throw u;if(!(typeof window>"u"&&e||i))throw u.message+=" on line "+s,u;var t,c,n,g;try{i=i||require("fs").readFileSync(e,{encoding:"utf8"}),t=3,c=i.split(`
`),n=Math.max(s-t,0),g=Math.min(c.length,s+t)}catch(r){return u.message+=" - could not read from "+e+" ("+r.message+")",void P(u,null,s)}t=c.slice(n,g).map(function(r,o){var F=o+n+1;return(F==s?"  > ":"    ")+F+"| "+r}).join(`
`),u.path=e;try{u.message=(e||"Pug")+":"+s+`
`+t+`

`+u.message}catch{}throw u}function ee(u){var e="",s,i,t;try{var c=u||{};(function(n){t=1,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",e=e+'<div class="g-item-license g-info-list-entry">',t=2,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",e=e+'<i class="icon-shield"></i>',t=3,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",e=e+"License:&nbsp;",t=4,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",n.has("license")&&n.get("license").length?(t=5,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",e=e+Y((s=n.get("license"))==null?"":s)):(t=7,i="/home/circleci/project/girder/plugins/item_licenses/girder_item_licenses/web_client/templates/itemLicenseWidget.pug",e=e+"Unspecified"),e=e+"</div>"}).call(this,"item"in c?c.item:typeof item<"u"?item:void 0)}catch(n){P(n,i,t)}return e}var ie=girder.views.View.extend({initialize:function(u){this.item=u.item},render:function(){return this.$el.html(ee({item:this.item})),this}});const te=girder.$,q=girder.views.body.ItemView,{restRequest:ue}=girder.rest,{wrap:U}=girder.utilities.PluginUtils;U(q,"render",function(u){return this.once("g:rendered",function(){var e=new ie({item:this.model,parentView:this}).render();te(".g-item-info").append(e.el)},this),u.call(this),this}),U(q,"editItem",function(u){return ue({method:"GET",url:"item/licenses"}).done(e=>{this.licenses=e,u.call(this)}),this});const C=girder.$,y=girder._,se=girder.models.ItemModel,N=girder.views.widgets.UploadWidget,{wrap:M}=girder.utilities.PluginUtils;M(N,"render",function(u){return u.call(this),y.has(this.parentView,"licenses")&&(this.selectLicenseWidget=new x({licenses:this.parentView.licenses,parentView:this}).render(),this.modal?C(".modal-body").append(this.selectLicenseWidget.el):C(".g-nonmodal-upload-buttons-container").before(this.selectLicenseWidget.el),delete this.parentView.licenses),this}),M(N,"uploadNextFile",function(u){if(u.call(this),y.has(this,"selectLicenseWidget")){var e=this.currentFile;e&&e.on("g:upload.complete",function(){var s=C("#g-license").val();if(!y.isEmpty(s)){var i=new se({_id:e.get("itemId"),license:s});i.save()}},this)}})});
