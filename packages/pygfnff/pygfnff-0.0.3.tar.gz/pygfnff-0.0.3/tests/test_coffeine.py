import numpy as np
import numpy.typing as npt

from pygfnff._pygfnff import gfnff


def coffeine() -> tuple[npt.ArrayLike, npt.ArrayLike]:
    Z = [6, 7, 6, 7, 6, 6, 6, 8, 7, 6, 8, 7, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    R = [
        [2.02799738646442, 0.09231312124713, -0.14310895950963],
        [4.75011007621000, 0.02373496014051, -0.14324124033844],
        [6.33434307654413, 2.07098865582721, -0.14235306905930],
        [8.72860718071825, 1.38002919517619, -0.14265542523943],
        [8.65318821103610, -1.19324866489847, -0.14231527453678],
        [6.23857175648671, -2.08353643730276, -0.14218299370797],
        [5.63266886875962, -4.69950321056008, -0.13940509630299],
        [3.44931709749015, -5.48092386085491, -0.14318454855466],
        [7.77508917214346, -6.24427872938674, -0.13107140408805],
        [10.30229550927022, -5.39739796609292, -0.13672168520430],
        [12.07410272485492, -6.91573621641911, -0.13666499342053],
        [10.70038521493902, -2.79078533715849, -0.14148379504141],
        [13.24597858727017, -1.76969072232377, -0.14218299370797],
        [7.40891694074004, -8.95905928176407, -0.11636933482904],
        [1.38702118184179, 2.05575746325296, -0.14178615122154],
        [1.34622199478497, -0.86356704498496, 1.55590600570783],
        [1.34624089204623, -0.86133716815647, -1.84340893849267],
        [5.65596919189118, 4.00172183859480, -0.14131371969009],
        [14.67430918222276, -3.26230980007732, -0.14344911021228],
        [13.50897177220290, -0.60815166181684, 1.54898960808727],
        [13.50780014200488, -0.60614855212345, -1.83214617078268],
        [5.41408424778406, -9.49239668625902, -0.11022772492007],
        [8.31919801555568, -9.74947502841788, 1.56539243085954],
        [8.31511620712388, -9.76854236502758, -1.79108242206824],
    ]
    return Z, R


def test_coffeine_sp() -> None:
    from time import perf_counter_ns

    Z, R = coffeine()
    e_ref = -4.672792533926004
    f_ref = [
        [0.005301570264175, 0.000273970046453, 0.000002235966967],
        [0.008166037109104, -0.008220839180901, -0.000025577434354],
        [-0.003078325363552, -0.009432996299921, 0.000033248959973],
        [0.009919832601386, 0.008086633755534, -0.000022035642360],
        [-0.015632596323341, -0.026672391134961, 0.000004837606473],
        [0.014525642097464, -0.001976846297509, 0.000067168700586],
        [0.006146643879669, 0.009561075520487, -0.000017505347402],
        [-0.008820848986042, -0.001068632415840, -0.000078000868871],
        [-0.000983352664777, 0.014873585269955, 0.000032976017459],
        [-0.006683041231125, 0.007422826993429, -0.000019221295612],
        [0.012839290909399, -0.012743003179261, -0.000039643202527],
        [-0.023422681331404, 0.021005865685095, -0.000002459581560],
        [-0.001884040385407, -0.003906626891817, -0.000013746286938],
        [-0.003754972778577, 0.003730224340046, -0.000073759269033],
        [0.000742833683906, 0.003621866120529, 0.000003807413478],
        [0.001069304816898, -0.000350576122870, 0.003705269737750],
        [0.001070927784981, -0.000349786548726, -0.003711459088386],
        [-0.002984451042725, 0.000421241696501, 0.000013800909435],
        [0.004499278381845, 0.000660466765138, 0.000002343067289],
        [0.000371386732209, 0.001498980424092, 0.003776579480469],
        [0.000381320666177, 0.001507608943116, -0.003766961246878],
        [-0.001010476530386, -0.004606702150652, 0.000057155057056],
        [0.001617340754014, -0.001636910544025, 0.003219103002614],
        [0.001603376956109, -0.001699034793892, -0.003148156655631],
    ]

    t0 = perf_counter_ns()
    e, f = gfnff(numbers=Z, positions=R)
    t1 = perf_counter_ns()

    np.testing.assert_approx_equal(e, e_ref)
    np.testing.assert_array_almost_equal(f, f_ref)
    print(f"SPE for coffeine: {(t1 - t0) / 1e6:.2f}ms")
