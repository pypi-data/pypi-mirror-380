import pytest

from codemie_sdk.models.integration import CredentialTypes
from codemie_test_harness.tests.enums.integrations import DataBaseDialect
from codemie_test_harness.tests.utils.credentials_manager import CredentialsManager
from codemie_test_harness.tests.utils.env_resolver import EnvironmentResolver

valid_integrations = [
    pytest.param(
        CredentialTypes.AWS,
        CredentialsManager.aws_credentials(),
        marks=[
            pytest.mark.aws,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AWS,
    ),
    pytest.param(
        CredentialTypes.AZURE,
        CredentialsManager.azure_credentials(),
        marks=[
            pytest.mark.azure,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AZURE,
    ),
    pytest.param(
        CredentialTypes.GCP,
        CredentialsManager.gcp_credentials(),
        marks=[
            pytest.mark.gcp,
            pytest.mark.cloud,
            pytest.mark.skipif(
                EnvironmentResolver.is_azure(),
                reason="Still have an issue with encoding long strings",
            ),
        ],
        id=CredentialTypes.GCP,
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.sonar_credentials(),
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_server",
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.sonar_cloud_credentials(),
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_cloud",
    ),
    pytest.param(
        CredentialTypes.GIT,
        CredentialsManager.gitlab_credentials(),
        marks=pytest.mark.gitlab,
        id=f"{CredentialTypes.GIT}_gitlab",
    ),
    pytest.param(
        CredentialTypes.GIT,
        CredentialsManager.github_credentials(),
        marks=pytest.mark.github,
        id=f"{CredentialTypes.GIT}_github",
    ),
    pytest.param(
        CredentialTypes.CONFLUENCE,
        CredentialsManager.confluence_credentials(),
        marks=[
            pytest.mark.confluence,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.CONFLUENCE}_server",
    ),
    pytest.param(
        CredentialTypes.CONFLUENCE,
        CredentialsManager.confluence_cloud_credentials(),
        marks=[
            pytest.mark.confluence,
            pytest.mark.confluence_cloud,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.CONFLUENCE}_cloud",
    ),
    pytest.param(
        CredentialTypes.JIRA,
        CredentialsManager.jira_credentials(),
        marks=[
            pytest.mark.jira,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.JIRA}_server",
    ),
    pytest.param(
        CredentialTypes.JIRA,
        CredentialsManager.jira_cloud_credentials(),
        marks=[
            pytest.mark.jira,
            pytest.mark.jira_cloud,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.JIRA}_cloud",
    ),
    pytest.param(
        CredentialTypes.SQL,
        CredentialsManager.sql_credentials(DataBaseDialect.POSTGRES),
        marks=pytest.mark.sql,
        id=DataBaseDialect.POSTGRES,
    ),
    pytest.param(
        CredentialTypes.SQL,
        CredentialsManager.sql_credentials(DataBaseDialect.MY_SQL),
        marks=pytest.mark.sql,
        id=DataBaseDialect.MY_SQL,
    ),
    pytest.param(
        CredentialTypes.ELASTIC,
        CredentialsManager.elasticsearch_credentials(),
        marks=pytest.mark.elastic,
        id=CredentialTypes.ELASTIC,
    ),
    pytest.param(
        CredentialTypes.MCP,
        CredentialsManager.mcp_credentials(),
        marks=pytest.mark.mcp,
        id=CredentialTypes.MCP,
    ),
    pytest.param(
        CredentialTypes.AZURE_DEVOPS,
        CredentialsManager.azure_devops_credentials(),
        marks=pytest.mark.azure,
        id=CredentialTypes.AZURE_DEVOPS,
    ),
    pytest.param(
        CredentialTypes.FILESYSTEM,
        CredentialsManager.file_system_credentials(),
        marks=pytest.mark.file_system,
        id=CredentialTypes.FILESYSTEM,
    ),
    pytest.param(
        CredentialTypes.EMAIL,
        CredentialsManager.gmail_credentials(),
        marks=[
            pytest.mark.notification,
            pytest.mark.email,
        ],
        id=CredentialTypes.EMAIL,
    ),
    pytest.param(
        CredentialTypes.TELEGRAM,
        CredentialsManager.telegram_credentials(),
        marks=[
            pytest.mark.notification,
            pytest.mark.telegram,
        ],
        id=CredentialTypes.TELEGRAM,
    ),
    pytest.param(
        CredentialTypes.SERVICE_NOW,
        CredentialsManager.servicenow_credentials(),
        marks=pytest.mark.servicenow,
        id=CredentialTypes.SERVICE_NOW,
    ),
    pytest.param(
        CredentialTypes.KEYCLOAK,
        CredentialsManager.keycloak_credentials(),
        marks=pytest.mark.keycloak,
        id=CredentialTypes.KEYCLOAK,
    ),
    pytest.param(
        CredentialTypes.KUBERNETES,
        CredentialsManager.kubernetes_credentials(),
        marks=[
            pytest.mark.kubernetes,
            pytest.mark.cloud,
            pytest.mark.skipif(
                EnvironmentResolver.is_azure(),
                reason="Still have an issue with encoding long strings",
            ),
        ],
        id=CredentialTypes.KUBERNETES,
    ),
    pytest.param(
        CredentialTypes.REPORT_PORTAL,
        CredentialsManager.report_portal_credentials(),
        marks=pytest.mark.report_portal,
        id=CredentialTypes.REPORT_PORTAL,
    ),
]

testable_integrations = [
    pytest.param(
        CredentialTypes.AWS,
        CredentialsManager.aws_credentials(),
        marks=[
            pytest.mark.aws,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AWS,
    ),
    pytest.param(
        CredentialTypes.AZURE,
        CredentialsManager.azure_credentials(),
        marks=[
            pytest.mark.azure,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AZURE,
    ),
    pytest.param(
        CredentialTypes.GCP,
        CredentialsManager.gcp_credentials(),
        marks=[
            pytest.mark.gcp,
            pytest.mark.cloud,
            pytest.mark.skipif(
                EnvironmentResolver.is_azure(),
                reason="Still have an issue with encoding long strings",
            ),
        ],
        id=CredentialTypes.GCP,
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.sonar_credentials(),
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_server",
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.sonar_cloud_credentials(),
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_cloud",
    ),
    pytest.param(
        CredentialTypes.CONFLUENCE,
        CredentialsManager.confluence_credentials(),
        marks=[
            pytest.mark.confluence,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.CONFLUENCE}_server",
    ),
    pytest.param(
        CredentialTypes.CONFLUENCE,
        CredentialsManager.confluence_cloud_credentials(),
        marks=[
            pytest.mark.confluence,
            pytest.mark.confluence_cloud,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.CONFLUENCE}_cloud",
    ),
    pytest.param(
        CredentialTypes.JIRA,
        CredentialsManager.jira_credentials(),
        marks=[
            pytest.mark.jira,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.JIRA}_server",
    ),
    pytest.param(
        CredentialTypes.JIRA,
        CredentialsManager.jira_cloud_credentials(),
        marks=[
            pytest.mark.jira,
            pytest.mark.jira_cloud,
            pytest.mark.project_management,
        ],
        id=f"{CredentialTypes.JIRA}_cloud",
    ),
    pytest.param(
        CredentialTypes.EMAIL,
        CredentialsManager.gmail_credentials(),
        marks=[
            pytest.mark.email,
            pytest.mark.notification,
            pytest.mark.skipif(
                EnvironmentResolver.is_localhost(),
                reason="Skipping this test on local environment",
            ),
        ],
        id=CredentialTypes.EMAIL,
    ),
    pytest.param(
        CredentialTypes.SERVICE_NOW,
        CredentialsManager.servicenow_credentials(),
        marks=pytest.mark.servicenow,
        id=CredentialTypes.SERVICE_NOW,
    ),
    pytest.param(
        CredentialTypes.KUBERNETES,
        CredentialsManager.kubernetes_credentials(),
        marks=[
            pytest.mark.kubernetes,
            pytest.mark.cloud,
            pytest.mark.skipif(
                EnvironmentResolver.is_azure(),
                reason="Still have an issue with encoding long strings",
            ),
        ],
        id=CredentialTypes.KUBERNETES,
    ),
    pytest.param(
        CredentialTypes.REPORT_PORTAL,
        CredentialsManager.report_portal_credentials(),
        marks=pytest.mark.report_portal,
        id=CredentialTypes.REPORT_PORTAL,
    ),
]

invalid_integrations = [
    pytest.param(
        CredentialTypes.AWS,
        CredentialsManager.invalid_aws_credentials(),
        "An error occurred (SignatureDoesNotMatch) when calling the GetUser operation: The request signature we calculated does not match the signature you provided. Check your AWS Secret Access Key and signing method. Consult the service documentation for details.",
        marks=[
            pytest.mark.aws,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AWS,
    ),
    pytest.param(
        CredentialTypes.AZURE,
        CredentialsManager.invalid_azure_credentials(),
        "Invalid client secret provided. Ensure the secret being sent in the request is the client secret value, not the client secret ID, for a secret added to app",
        marks=[
            pytest.mark.azure,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.AZURE,
    ),
    pytest.param(
        CredentialTypes.GCP,
        CredentialsManager.invalid_gcp_credentials(),
        "Error: ('Could not deserialize key data. The data may be in an incorrect format, "
        + "the provided password may be incorrect, it may be encrypted with an unsupported algorithm, "
        + "or it may be an unsupported key type",
        marks=[
            pytest.mark.gcp,
            pytest.mark.cloud,
            pytest.mark.skipif(
                EnvironmentResolver.is_azure(),
                reason="Still have an issue with encoding long strings",
            ),
        ],
        id=CredentialTypes.GCP,
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.invalid_sonar_credentials(),
        "Invalid token",
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_server",
    ),
    pytest.param(
        CredentialTypes.SONAR,
        CredentialsManager.invalid_sonar_cloud_credentials(),
        "Invalid token",
        marks=pytest.mark.sonar,
        id=f"{CredentialTypes.SONAR}_cloud",
    ),
    pytest.param(
        CredentialTypes.EMAIL,
        CredentialsManager.invalid_gmail_credentials(),
        "SMTP Code: 535. SMTP error",
        marks=[
            pytest.mark.email,
            pytest.mark.notification,
            pytest.mark.skipif(
                EnvironmentResolver.is_localhost(),
                reason="Skipping this test on local environment",
            ),
        ],
        id=CredentialTypes.EMAIL,
    ),
    pytest.param(
        CredentialTypes.JIRA,
        CredentialsManager.invalid_jira_credentials(),
        "Unauthorized (401)",
        marks=pytest.mark.jira,
        id=CredentialTypes.JIRA,
    ),
    pytest.param(
        CredentialTypes.CONFLUENCE,
        CredentialsManager.invalid_confluence_credentials(),
        "Access denied",
        marks=pytest.mark.confluence,
        id=CredentialTypes.CONFLUENCE,
    ),
    pytest.param(
        CredentialTypes.SERVICE_NOW,
        CredentialsManager.invalid_servicenow_credentials(),
        'ServiceNow tool exception. Status: 401. Response: {"error":{"message":"User Not Authenticated","detail":"Required to provide Auth information"}',
        marks=pytest.mark.servicenow,
        id=CredentialTypes.SERVICE_NOW,
    ),
    pytest.param(
        CredentialTypes.KUBERNETES,
        CredentialsManager.invalid_kubernetes_credentials(),
        "Error: (401)\nReason: Unauthorized",
        marks=[
            pytest.mark.kubernetes,
            pytest.mark.cloud,
        ],
        id=CredentialTypes.KUBERNETES,
    ),
    pytest.param(
        CredentialTypes.REPORT_PORTAL,
        CredentialsManager.invalid_report_portal_credentials(),
        "401 Client Error:  for url: https://report-portal.core.kuberocketci.io/api/v1/epm-cdme/launch?page.page=1",
        marks=pytest.mark.report_portal,
        id=CredentialTypes.REPORT_PORTAL,
    ),
]
