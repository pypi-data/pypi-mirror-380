name: Deploy MkDocs to GitHub Pages

on:
  push:
    branches:
      - main
      - develop
      - divya/change-to-mkdocs
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  docs:
    name: Docs
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          uv sync --extra dev --extra nn-cpu --extra docs --extra jupyter

      - name: Print environment info
        run: |
          which python
          uv pip list
          uv pip freeze

      - name: Setup Git user
        run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Build and upload docs (release event)
        if: ${{ github.event_name == 'release' && github.event.action == 'published' }}
        run: |
          uv runmike deploy --update-aliases --allow-empty --push "${{ github.event.release.tag_name }}" stable

      - name: Get tag that 'stable' alias points to, or fallback to 'dev'
        id: get-stable-tag
        run: |
          git fetch origin gh-pages || true
          git checkout origin/gh-pages -- versions.json 2>/dev/null || true

          if [ -f versions.json ]; then
            stable_tag=$(jq -r '.[] | select(.aliases | index("stable")) | .version' versions.json)
          fi

          if [ -z "$stable_tag" ]; then
            echo "No stable alias found. Falling back to 'dev'."
            stable_tag="dev"
          fi

          echo "Using: $stable_tag"
          echo "stable_tag=$stable_tag" >> $GITHUB_OUTPUT


      - name: Build and upload docs (push event)
        if: github.event_name == 'push'
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            uv run mike deploy --update-aliases --allow-empty --push "${{ steps.get-stable-tag.outputs.stable_tag }}" stable
          else
            uv run mike deploy --update-aliases --allow-empty --push dev
          fi