{
  "$id": "https://cantum.id/schemas/cantum_entity_schema.meta.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Cantum Entity JSON Schema (Meta-Schema)",
  "description": "Meta-schema untuk memvalidasi JSON Schema entity Cantum (berbasis draft-07).",
  "type": "object",
  "properties": {
    "$schema": {"const": "http://json-schema.org/draft-07/schema#"},
    "$id": {"type": "string"},
    "title": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "Nama entity dalam snake_case, mis. employee, decision_record."
    },
    "description": {"type": "string"},
    "type": {"const": "object"},
    "properties": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {"$ref": "#/$defs/fieldSchema"}
      },
      "additionalProperties": false
    },
    "required": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9_]*$"
      },
      "uniqueItems": true
    },
    "additionalProperties": {"type": "boolean"},
    "definitions": {"type": "object"},
    "$defs": {"type": "object"}
  },
  "required": ["$schema", "title", "type", "properties"],
  "unevaluatedProperties": false,
  "$defs": {
    "primitiveType": {
      "type": "string",
      "enum": ["string", "number", "integer", "boolean", "array", "object"]
    },
    "enumArray": {
      "type": "array",
      "minItems": 1,
      "items": {"type": ["string", "number", "integer", "boolean"]}
    },
    "fieldSchema": {
      "type": "object",
      "description": "Bentuk schema untuk suatu field entity.",
      "properties": {
        "type": {"$ref": "#/$defs/primitiveType"},
        "description": {"type": "string"},
        "enum": {"$ref": "#/$defs/enumArray"},
        "const": {"type": ["string", "number", "integer", "boolean", "null"]},
        "format": {"type": "string"},
        "minimum": {"type": "number"},
        "maximum": {"type": "number"},
        "exclusiveMinimum": {"type": "number"},
        "exclusiveMaximum": {"type": "number"},
        "minLength": {"type": "integer", "minimum": 0},
        "maxLength": {"type": "integer", "minimum": 0},
        "minItems": {"type": "integer", "minimum": 0},
        "maxItems": {"type": "integer", "minimum": 0},
        "uniqueItems": {"type": "boolean"},
        "pattern": {"type": "string"},

        "items": {
          "description": "Wajib ada jika type=array.",
          "anyOf": [
            {"$ref": "#/$defs/fieldSchema"},
            {
              "type": "object",
              "properties": {
                "type": {"$ref": "#/$defs/primitiveType"}
              },
              "required": ["type"]
            }
          ]
        },

        "properties": {
          "description": "Untuk nested object.",
          "type": "object",
          "patternProperties": {
            "^[a-z][a-z0-9_]*$": {"$ref": "#/$defs/fieldSchema"}
          },
          "additionalProperties": false
        },
        "required": {
          "description": "Untuk nested object.",
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
          },
          "uniqueItems": true
        },
        "additionalProperties": {"type": ["boolean", "object"]}
      },
      "allOf": [
        {
          "if": {"properties": {"type": {"const": "array"}}, "required": ["type"]},
          "then": {"required": ["items"]}
        },
        {
          "if": {"properties": {"type": {"const": "object"}}, "required": ["type"]},
          "then": {"required": ["properties"]}
        }
      ],
      "additionalProperties": false
    }
  }
}
