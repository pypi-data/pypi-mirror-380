stages:
    - test_code
    - publish_docs


.setup: &setup
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    variables:
      UV_LINK_MODE: "copy"

style:
    <<: *setup
    stage: test_code
    script:
        - uv venv --python ${PYTHON_VERSION}
        - uv sync --extra dev
        - uv run ruff check src/ tests/
tests:
    <<: *setup
    stage: test_code
    parallel:
        matrix:
        - PYTHON_VERSION: ['3.9', '3.10', '3.11', '3.12']
    script:
        - uv venv --python ${PYTHON_VERSION}
        - uv sync --extra dev
        - uv run pytest -v tests


docs:
    <<: *setup
    stage: test_code
    script:
        - uv sync --extra docs
        - cd docs
        - uv run sphinx-build -b html . _build/html
    artifacts:
           paths:
             - docs/_build


publish_docs:
    image: cosmo-gitlab.phys.ethz.ch:5005/cosmo/vcosmo-ci:python-cosmo-ci
    script:
        - publish_docs docs/_build/html {{ package_name }}
        - create_index_html
    stage: publish_docs
    dependencies:
          - docs
    when: manual
    only:
        - master
        - main
