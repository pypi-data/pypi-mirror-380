import{r as x,j as e}from"./@radix-3bj3otF9.js";import{E as w,H as C,J as S,K,b9 as E,ba as ne,B as f,bb as B,bc as _,D as q,x as k,I as D,bf as z,bg as $,bh as T,L as H,M as re,ai as V,z as A,be as Q,X as ie,Y as oe,Z as ce,aB as le,$ as de,e as j,N as ue,O as me,Q as xe,R as he,a6 as pe,am as fe,an as ye,ao as je,aq as ge,ar as be,U as I,aa as M,l as L,a3 as ve,a4 as Ae,bD as De,r as Ne,bC as we,aV as Ce}from"./index-1REJ-mbf.js";import{c as Se}from"./helper-BXlR2ZLp.js";import{s as g,A as G,d as Ke,u as ke,b as R,a as U}from"./service-BCNHtwui.js";import{c as F,h as v,b as P}from"./@tanstack-CByuvRcg.js";import{u as Te}from"./bulk-delete-C0Pqi-YB.js";import{P as Re}from"./Pagination-DePVp3ki.js";import{S as Fe}from"./SearchField-CjwYvxg3.js";import{t as Y}from"./zod-36FJuF1H.js";import{u as J,C as N}from"./index.esm-DnoyTjte.js";import{S as Z}from"./trash-B0fyghWi.js";import{D as X,a as W}from"./DeleteAlertDialog-BUIIlTob.js";import{S as ee}from"./key-icon-Bbj2oWN_.js";import{i as Pe,a as Oe}from"./dates-C-zixBbE.js";import{S as Ie}from"./refresh-BaK7e0kN.js";import{A as Me}from"./AlertDialogDropdownItem-CAlqlfdb.js";import{I as Ee}from"./Infobox-D1YtF5f6.js";import{a as O}from"./@react-router-Ct_TgVUW.js";import"./@reactflow-CwWcBchH.js";import"./CodeSnippet-LBT7JnAL.js";import"./Tick-BM7ecWMi.js";import"./check-mTv-6WVU.js";import"./chevron-right-double-BuLe9bCa.js";import"./index-FwZ5fdjO.js";async function Be(t,s){const a=C(K.serviceAccounts.apiKeys.detail(t,s)),i=await w(a,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!i.ok){const n=await i.json().then(r=>Array.isArray(r.detail)?r.detail[1]:r.detail).catch(()=>`Failed to delete api key ${s}`);throw new S({status:i.status,statusText:i.statusText,message:n})}return i.json()}function _e(t){return F({...t,mutationFn:async({serviceAccountId:s,apiKeyId:a})=>{await Be(s,a)}})}const{ContextProvider:qe,useContext:b}=Se();function te(t){const{setRowSelection:s}=b(),{mutateAsync:a}=_e();async function i(n){await a({serviceAccountId:t,apiKeyId:n})}return Te({deleteFn:i,queryKeyToInvalidate:g.serviceAccountsKey(),setRowSelection:s})}function se({serviceAccountId:t,isFallback:s}){const a=v(),[i,n]=x.useState(!1),[r,o]=x.useState(""),u=!!r;function m(){return u?e.jsx(G,{value:r}):e.jsx(ze,{isFallback:s,serviceAccountId:t,setApikeyValue:o})}return e.jsx(e.Fragment,{children:e.jsxs(E,{open:i,onOpenChange:l=>{s&&!l&&a.invalidateQueries({queryKey:g.apiKeysKey(t)}),n(l),o("")},children:[e.jsx(ne,{asChild:!0,children:e.jsx(f,{className:"shrink-0",intent:"primary",size:"sm",children:"Generate API Key"})}),e.jsxs(B,{"data-success":u,className:"mx-auto overflow-x-auto transition-none data-[success=true]:max-w-[800px]",children:[e.jsx(_,{children:e.jsx(q,{children:u?"API Key Created Successfully":"Generate API Key"})}),m()]})]})})}function ze({serviceAccountId:t,setApikeyValue:s,isFallback:a}){const{toast:i}=k(),n=v(),{handleSubmit:r,control:o,formState:{isValid:u},reset:m}=J({resolver:Y(Ke),defaultValues:{name:"",description:""}}),{mutate:l}=ke({onError(c){T(c)&&i({status:"error",emphasis:"subtle",description:c.message,rounded:!0})},onSuccess(c){var y;a||n.invalidateQueries({queryKey:g.apiKeysKey(t)}),s(((y=c.body)==null?void 0:y.key)||""),m()}});function d(c){l({serviceAccountId:t,body:{name:c.name,description:c.description}})}return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"create-secret-form",className:"space-y-5 p-7",onSubmit:r(d),children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("label",{className:"font-inter text-sm text-left font-medium leading-5",children:"Name:"}),e.jsx(N,{name:"name",control:o,render:({field:c})=>e.jsx(D,{...c,className:"w-full",required:!0,placeholder:"Add name"})})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("label",{className:"font-inter text-sm text-left font-medium leading-5",children:"Description:"}),e.jsx(N,{name:"description",control:o,render:({field:c})=>e.jsx(D,{...c,className:"w-full",placeholder:"Add description"})})]})]}),e.jsxs(z,{className:"gap-[10px]",children:[e.jsx($,{asChild:!0,children:e.jsx(f,{size:"sm",intent:"secondary",children:"Cancel"})}),e.jsx(f,{intent:"primary",disabled:!u,type:"submit",form:"create-secret-form",children:"Generate Key"})]})]})}function $e({serviceAccountId:t}){const[s,a]=x.useState(!1),{bulkDelete:i}=te(t),{selectedRowIDs:n,selectedRowCount:r}=b();async function o(){await i(n),a(!1)}return e.jsxs(H,{open:s,onOpenChange:a,children:[e.jsx(re,{asChild:!0,children:e.jsxs(f,{className:"rounded-sharp border-y-0 bg-white",size:"md",emphasis:"subtle",intent:"secondary",children:[e.jsx(Z,{className:"h-5 w-5 shrink-0 gap-1 fill-neutral-400"}),"Delete"]})}),e.jsx(X,{title:`Delete Api Key${r>=2?"s":""}`,handleDelete:o,children:e.jsxs(W,{children:[e.jsx("p",{children:"Are you sure?"}),e.jsx("p",{children:"This action cannot be undone."})]})})]})}function He({serviceAccountId:t}){const{selectedRowCount:s}=b();return e.jsxs("div",{className:"flex items-center divide-x divide-theme-border-moderate overflow-hidden rounded-md border border-theme-border-moderate",children:[e.jsx("div",{className:"bg-primary-25 px-2 py-1 font-semibold text-theme-text-brand",children:`${s} Api Key${s>1?"s":""} selected`}),e.jsx($e,{serviceAccountId:t})]})}async function Ve({apiKeyId:t,body:s,serviceAccountId:a}){const i=C(K.serviceAccounts.apiKeys.rotate(a,t)),n=await w(i,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(n.status===404&&V(),!n.ok){const r=await n.json().then(o=>Array.isArray(o.detail)?o.detail[1]:o.detail).catch(()=>`Failed to rotate key ${t}`);throw new S({status:n.status,statusText:n.statusText,message:r})}return n.json()}function Qe(t){return F({...t,mutationFn:async({serviceAccountId:s,apiKeyId:a,body:i})=>Ve({serviceAccountId:s,apiKeyId:a,body:i})})}const Le=A.object({enableRetention:A.boolean(),rotateMinutes:A.coerce.number().int().min(1).optional()}).refine(t=>!(t.enableRetention&&!t.rotateMinutes));function Ge({serviceAccountId:t,apiKeyId:s,open:a,setOpen:i}){const[n,r]=x.useState(""),o=!!n;function u(){return o?e.jsx(G,{value:n}):e.jsx(Ue,{setApiKeyValue:r,apiKeyId:s,serviceAccountId:t})}return e.jsx(E,{open:a,onOpenChange:m=>{i(m),r("")},children:e.jsxs(B,{className:"mx-auto max-w-[800px] overflow-x-auto",children:[e.jsx(_,{children:e.jsx(q,{children:"Rotate API Key"})}),u()]})})}function Ue({apiKeyId:t,serviceAccountId:s,setApiKeyValue:a}){const{toast:i}=k(),n=v(),{control:r,watch:o,register:u,handleSubmit:m,formState:{errors:l,isValid:d}}=J({resolver:Y(Le),defaultValues:{enableRetention:!1,rotateMinutes:void 0}});function c(p){const h={retain_period_minutes:p.rotateMinutes};y({serviceAccountId:s,apiKeyId:t,body:h})}const{mutate:y}=Qe({onError(p){T(p)&&i({status:"error",emphasis:"subtle",description:p.message,rounded:!0})},onSuccess(p){var h;i({description:"The API key has been rotated successfully.",status:"success",emphasis:"subtle",rounded:!0}),a(((h=p.body)==null?void 0:h.key)||""),n.invalidateQueries({queryKey:[...g.apiKeysKey(s)]})}});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-5 p-7",children:[e.jsx(Ye,{apiKeyId:t,serviceAccountId:s}),e.jsx(Je,{}),e.jsxs("form",{onSubmit:m(c),id:"retention-form",children:[e.jsxs("div",{className:"flex items-center gap-1 rounded-t-md border bg-theme-surface-secondary p-1",children:[e.jsx(N,{control:r,name:"enableRetention",render:({field:{onChange:p,value:h}})=>e.jsx(Q,{className:"data-[state=unchecked]:bg-neutral-200",checked:h,id:"enable-retention",onCheckedChange:ae=>p(!!ae)})}),"Include Retention Period",e.jsx(ie,{children:e.jsxs(oe,{children:[e.jsx(ce,{asChild:!0,children:e.jsxs("button",{type:"button",children:[e.jsx(le,{className:"h-4 w-4 shrink-0 fill-theme-text-tertiary"}),e.jsx("div",{className:"sr-only",children:"Info tooltip"})]})}),e.jsx(de,{className:"z-50 flex max-w-[480px] bg-black",children:e.jsx("p",{className:"text-text-xs text-white",children:"To minimize disruption, you can set a retention period for your current key. Enter the duration(in minutes) you'd like the old key to remain active alongside the new one."})})]})})]}),e.jsxs("fieldset",{disabled:!o("enableRetention"),className:"space-y-5 rounded-b-md border-x border-b p-5 text-text-md text-theme-text-primary",children:[e.jsx("p",{className:"text-text-md text-theme-text-primary",children:"Keep the current key working for the next"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm text-theme-text-primary",htmlFor:"retention-minutes",children:"Minutes"}),e.jsx(D,{id:"retention-minutes",...u("rotateMinutes"),disabled:!o("enableRetention"),placeholder:"0"}),l.rotateMinutes&&e.jsx("p",{className:"text-text-sm text-theme-text-error",children:l.rotateMinutes.message})]})]})]})]}),e.jsxs(z,{className:"gap-[10px]",children:[e.jsx($,{asChild:!0,children:e.jsx(f,{size:"sm",intent:"secondary",children:"Cancel"})}),e.jsx(f,{intent:"primary",disabled:!d,size:"sm",form:"retention-form",children:"Rotate Key"})]})]})}function Ye({apiKeyId:t,serviceAccountId:s}){var r;const{data:a,isPending:i,isError:n}=P({...R.ApiKeysDetail(s,t),throwOnError:!0});return i?e.jsx(j,{className:"h-8 w-full"}):n?null:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"h-5 w-5 flex-shrink-0 fill-primary-400"}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("p",{children:a&&a.name}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:a&&((r=a.metadata)==null?void 0:r.description)})]})]})}function Je(){return e.jsxs(Ee,{children:[e.jsx("strong",{children:"Your current API Key will be deactivated."})," This means any processes or integrations using the old key will no longer function once the new key is generated."]})}function Ze({serviceAccountId:t,apiKeyId:s}){const[a,i]=x.useState(!1),[n,r]=x.useState(!1),[o,u]=x.useState(!1),m=x.useRef(null),l=x.useRef(null),{bulkDelete:d}=te(t);function c(){l.current=m.current}function y(h){u(h),h||i(!1)}async function p(){await d([s]),y(!1)}return e.jsxs(e.Fragment,{children:[e.jsx(Ge,{setOpen:r,open:n,serviceAccountId:t,apiKeyId:s}),e.jsxs(ue,{onOpenChange:i,open:a,children:[e.jsx(me,{ref:m,children:e.jsx(xe,{className:"h-5 w-5 fill-theme-text-secondary"})}),e.jsxs(he,{hidden:o,onCloseAutoFocus:h=>{l.current&&(l.current.focus(),l.current=null,h.preventDefault())},align:"end",sideOffset:7,children:[e.jsx(pe,{className:"px-3",onClick:()=>r(!0),icon:e.jsx(Ie,{}),children:e.jsx("span",{children:"Rotate"})}),e.jsx(Me,{onSelect:c,open:o,onOpenChange:y,triggerChildren:"Delete",icon:e.jsx(Z,{fill:"red"}),children:e.jsx(X,{title:"Delete API Key",handleDelete:p,children:e.jsxs(W,{children:[e.jsx("p",{children:"Are you sure?"}),e.jsx("p",{children:"This action cannot be undone."})]})})})]})]})]})}async function Xe({apiKeyId:t,body:s,serviceAccountId:a}){const i=C(K.serviceAccounts.apiKeys.detail(a,t)),n=await w(i,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(n.status===404&&V(),!n.ok){const r=await n.json().then(o=>Array.isArray(o.detail)?o.detail[0]:o.detail||"An error occurred").catch(()=>`Failed to update key ${t}`);throw new S({status:n.status,statusText:n.statusText,message:r})}return n.json()}function We(t){return F({...t,mutationFn:async({serviceAccountId:s,apiKeyId:a,body:i})=>{await Xe({serviceAccountId:s,apiKeyId:a,body:i})}})}function et({isActive:t,serviceAccountId:s,apiKeyId:a}){const{toast:i}=k(),n=v(),[r,o]=x.useState(!1),{mutate:u}=We({onError(d){T(d)&&i({status:"error",emphasis:"subtle",description:d.message,rounded:!0})},onSuccess(){n.invalidateQueries({queryKey:g.apiKeysKey(s)})}});function m(d){d?l(d):o(!0)}async function l(d){u({serviceAccountId:s,apiKeyId:a,body:{active:d}})}return e.jsxs(e.Fragment,{children:[e.jsx(H,{open:r,onOpenChange:o,children:e.jsxs(fe,{children:[e.jsx(ye,{children:e.jsx(je,{children:"Deactivate API Key"})}),e.jsxs("div",{className:"p-5 text-text-md text-theme-text-secondary",children:[e.jsx("p",{children:"Are you sure?"}),e.jsx("p",{children:"You won't be able to use this API Key to authenticate with the server anymore."})]}),e.jsxs(ge,{className:"gap-[10px]",children:[e.jsx(be,{asChild:!0,children:e.jsx(f,{size:"sm",intent:"secondary",children:"Cancel"})}),e.jsx(f,{onClick:()=>l(!1).then(d=>o(!1)),intent:"primary",type:"button",children:"Deactivate"})]})]})}),e.jsx(Q,{checked:t,onCheckedChange:m})]})}function tt(){return[{id:"select",meta:{width:"1%"},header:({table:t})=>e.jsx(I,{id:"check-all",checked:t.getIsAllRowsSelected(),onCheckedChange:s=>t.toggleAllRowsSelected(s==="indeterminate"?!0:s)}),cell:({row:t})=>e.jsx(I,{id:`check-${t.id}`,checked:t.getIsSelected(),onCheckedChange:t.getToggleSelectedHandler()})},{id:"name",header:"Name",accessorFn:t=>({name:t.name}),cell:({row:t})=>{var s;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"h-5 w-5 flex-shrink-0 fill-primary-400"}),e.jsxs("div",{className:"group/copybutton flex flex-col",children:[e.jsx("div",{className:"flex flex-row items-center space-x-1",children:e.jsx("div",{className:"flex items-center space-x-1 text-text-md font-semibold text-theme-text-primary",children:t.original.name})}),e.jsx("div",{className:"flex items-center gap-1 text-text-sm text-theme-text-secondary",children:(s=t.original.metadata)==null?void 0:s.description})]})]})}},{id:"last-login",header:"Last Login",accessorFn:t=>{var s;return(s=t.metadata)==null?void 0:s.last_login},cell:({row:t})=>{var s,a;return(s=t.original.metadata)!=null&&s.last_login?e.jsx("p",{children:e.jsx(M,{short:!0,dateString:(a=t.original.metadata)==null?void 0:a.last_login})}):e.jsx("p",{children:"Never"})}},{id:"last-rotated",header:"Last Rotated",accessorFn:t=>{var s;return(s=t.metadata)==null?void 0:s.last_rotated},cell:({row:t})=>{var r;const s=(r=t.original.metadata)==null?void 0:r.last_rotated;if(!s)return e.jsx("p",{children:"Never"});const a=new Date(`${s}Z`),i=Pe(a),n=Oe(a);return e.jsxs("div",{children:[e.jsx("p",{children:e.jsx(M,{short:!0,dateString:s})}),(i||n)&&e.jsx("p",{className:`${n?"text-theme-text-error":"text-theme-text-warning"} text-text-xs`,children:n?"More than 1 year old":"More than 6 months old"})]})}},{id:"active",header:"Active",accessorFn:t=>{var s;return(s=t.body)==null?void 0:s.active},cell:({row:t})=>{var s,a;return e.jsx(et,{isActive:!!((s=t.original.body)!=null&&s.active),serviceAccountId:((a=t.original.body)==null?void 0:a.service_account.id)||"",apiKeyId:t.original.id})}},{id:"actions",header:"",meta:{width:"5%"},cell:({row:t})=>{var a;const s=(a=t.original.body)==null?void 0:a.service_account.id;return s?e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(Ze,{serviceAccountId:s,apiKeyId:t.original.id})}):null}}]}function st(){const{serviceAccountId:t}=O();return e.jsxs(L,{className:"flex flex-col items-center justify-center space-y-4 p-9",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("p",{className:"text-display-xs font-semibold text-theme-text-primary",children:"This service account doesn't have any API Keys yet"}),e.jsx("p",{className:"text-theme-text-secondary",children:"Generate your first API Key to enable secure interactions with the ZenML Server."})]}),e.jsx(se,{isFallback:!0,serviceAccountId:t})]})}function at(){const{serviceAccountId:t}=O(),s=U(),{rowSelection:a,setRowSelection:i}=b(),n=x.useMemo(()=>tt(),[]),{data:r}=P({...R.serviceAccountApiKeys(t,{...s,sort_by:"desc:created",hydrate:!0})});return r&&(r==null?void 0:r.items.length)<1&&!s.name?e.jsx(st,{}):e.jsxs(e.Fragment,{children:[e.jsx(nt,{serviceAccountId:t}),e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx("div",{className:"w-full",children:r?e.jsx(ve,{getRowId:o=>o.id,rowSelection:a,onRowSelectionChange:i,columns:n,data:r.items}):e.jsx(j,{className:"h-[500px] w-full"})}),r?r.total_pages>1&&e.jsx(Re,{searchParams:s,paginate:r}):e.jsx(j,{className:"h-[36px] w-[300px]"})]})]})}function nt({serviceAccountId:t}){const s=U(),{selectedRowCount:a}=b();return e.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-2",children:[a?e.jsx(He,{serviceAccountId:t}):e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Fe,{searchParams:s})}),e.jsx(se,{isFallback:!1,serviceAccountId:t})]})}function rt(t){const{setBreadcrumbs:s}=Ae();x.useEffect(()=>{t&&s([...De,{label:t.name,href:Ne.settings.service_accounts.detail(t.id)}])},[s,t])}function it(){var i,n,r,o;const{serviceAccountId:t}=O(),s=P({...R.serviceAccountDetail(t),throwOnError:!0});if(rt(s.data),s.isPending)return e.jsx(ot,{});if(s.isError)return null;const a=s.data;return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{size:"xl",serviceAccountName:a.name,serviceAccountAvatar:((i=a.body)==null?void 0:i.avatar_url)??void 0}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-text-xl font-semibold",children:a.name}),e.jsx(Ce,{size:"sm",color:(n=a.body)!=null&&n.active?"light-purple":"light-grey",className:"text-text-xs font-semibold uppercase",children:(r=a.body)!=null&&r.active?"active":"inactive"})]}),e.jsx("p",{className:"text-text-md text-theme-text-secondary",children:(o=a.metadata)==null?void 0:o.description})]})]})}function ot(){return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{className:"h-9 w-9"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(j,{className:"h-6 w-[100px]"}),e.jsx(j,{className:"h-5 w-[50px]"})]}),e.jsx(j,{className:"h-5 w-[150px]"})]})]})}function Ft(){return e.jsxs(L,{className:"space-y-5 p-5",children:[e.jsxs("div",{children:[e.jsx(it,{}),e.jsx("h1",{className:"my-5 text-text-lg font-semibold",children:"API Keys"})]}),e.jsx(qe,{children:e.jsx(at,{})})]})}export{Ft as default};
