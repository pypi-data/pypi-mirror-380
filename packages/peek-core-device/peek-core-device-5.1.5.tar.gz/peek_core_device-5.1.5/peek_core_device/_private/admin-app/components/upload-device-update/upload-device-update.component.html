<nz-card>
    <div>
        Upload Device Update
        <button
            *ngIf="!(uploadEnabled$ | async)"
            nz-button
            nzType="primary"
            class="next-button"
            (click)="handleNext()"
            [disabled]="!isFormValid"
            [nzLoading]="loading$ | async"
        >
            Next
        </button>
    </div>

    <ng-container *ngIf="uploadEnabled$ | async; else uploadForm">
        <nz-upload
            [nzAction]="uploadUrl$ | async"
            [nzCustomRequest]="customUploadRequest"
            [nzShowUploadList]="false"
            nzType="drag"
            [nzMultiple]="false"
            (nzChange)="handleUploadChange($event)"
        >
            <p class="ant-upload-drag-icon">
                <i nz-icon nzType="cloud-upload" nzTheme="outline"></i>
            </p>
            <ng-container *ngIf="!(progressPercentage$ | async)">
                <p class="ant-upload-text">
                    Click or drag update file to this area
                </p>
                <p class="ant-upload-hint">
                    Support for single file upload only
                </p>
            </ng-container>
            <ng-container *ngIf="progressPercentage$ | async as progress">
                <p class="ant-upload-text">Uploading</p>
                <nz-progress
                    [nzPercent]="progress"
                    [nzShowInfo]="false"
                    nzStatus="active"
                ></nz-progress>
                <p class="progress-text">
                    {{ progress | number: "1.0-0" }}% Complete
                </p>
            </ng-container>
        </nz-upload>
    </ng-container>

    <ng-template #uploadForm>
        <form nz-form [nzLayout]="'vertical'">
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label nzRequired>Device Type</nz-form-label>
                        <nz-form-control nzErrorTip="Please select device type">
                            <nz-select
                                [(ngModel)]="newUpdate.deviceType"
                                name="deviceType"
                                nzPlaceHolder="Select device type"
                            >
                                <nz-option
                                    *ngFor="let type of deviceTypes"
                                    [nzValue]="type.value"
                                    [nzLabel]="type.label"
                                ></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="16">
                    <nz-form-item>
                        <nz-form-label nzRequired>Description</nz-form-label>
                        <nz-form-control nzErrorTip="Please enter description">
                            <input
                                nz-input
                                [(ngModel)]="newUpdate.description"
                                name="description"
                                placeholder="Enter update description"
                            />
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="12">
                    <nz-form-item>
                        <nz-form-label nzRequired>App Version</nz-form-label>
                        <nz-form-control nzErrorTip="Please enter app version">
                            <input
                                nz-input
                                [(ngModel)]="newUpdate.appVersion"
                                name="appVersion"
                                placeholder="Enter app version"
                            />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="12">
                    <nz-form-item>
                        <nz-form-label nzRequired>Update Version</nz-form-label>
                        <nz-form-control
                            nzErrorTip="Please enter update version"
                        >
                            <input
                                nz-input
                                [(ngModel)]="newUpdate.updateVersion"
                                name="updateVersion"
                                placeholder="Enter update version"
                            />
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>
        </form>
    </ng-template>

    <nz-alert
        *ngIf="serverRestarting$ | async"
        nzType="info"
        nzMessage="Server Restarting"
        nzDescription="The server is restarting to apply the update. Please wait a moment..."
        nzShowIcon
    ></nz-alert>
</nz-card>
