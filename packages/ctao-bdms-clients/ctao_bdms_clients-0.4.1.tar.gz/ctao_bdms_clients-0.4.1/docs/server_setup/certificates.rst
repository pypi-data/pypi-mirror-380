Certificates
============

X.509 certificates for BDMS deployment on Kubernetes Test Cluster
-----------------------------------------------------------------

The repository for the certificates generation sub-chart namely ``cert-generator-grid`` is located as ``charts/cert-generator-grid``
under DPPS organization ``dpps/aiv/dpps-aiv-toolkit/`` which is also added as submodule to the main ``bdms`` repository. The gitlab CI job in the ``dpps/aiv/dpps-aiv-toolkit/``
publishes the ``cert-generator-grid`` chart and deploys it to the CTAO Harbor. The cert-generator-grid chart creates certificates (self-signed CA, user and host) by means of a
job that also creates Kubernetes secrets from the certificates. For production environment, the certificates will be signed by DPPS AIV CA and/or Let's Encrypt CA.


The bootstrap_jobs.yaml` under ``templates/`` in the sub-chart defines a job with Helm pre-install/pre-upgrade hook for generating X.509 certificates and storing them as
Kubernetes secrets (``kubectl`` client creates secrets from certificates) and this ensures certificates required by Rucio are available in the K8s namespace where BDMS deployment is being rolled out.
The certificates are generated by running the script ``scripts/certificates/generate_certificates.sh`` (also defined in the job's definition).
The OpenSSL configuration for certificates generation is set-up as Helm ConfigMap with file ``openssl_config_ca.cnf`` and its mounted as volumes in the ``bootstrap_jobs.yaml`` job definition.

The secret name has the prefix ``<HELM_RELEASE_NAME>-`` attached to the secret and the Kubernetes secrets are generated the following: (i) Host certificate of Rucio server,
(ii) Host key of Rucio server, (iii) CA certificate for Rucio server, (iv) CA certificate (as rucio CA bundle) for Rucio server, (v) User certificate and key for DPPS users,
(vi) X509up with user certificate and key, (vii) Host certificate and key for each storages (thus 3 secrets), (viii) Host certificate and key for FTS, (ix) Host certificate for FTS, (x) Host key for FTS
