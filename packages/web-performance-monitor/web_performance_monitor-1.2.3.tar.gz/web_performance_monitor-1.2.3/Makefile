# Web Performance Monitor - Makefile

.PHONY: help clean build test install dev-install upload upload-test check format lint

# é»˜è®¤ç›®æ ‡
help:
	@echo "Web Performance Monitor - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  dev-install    å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  test          è¿è¡Œæµ‹è¯•"
	@echo "  format        æ ¼å¼åŒ–ä»£ç "
	@echo "  lint          ä»£ç æ£€æŸ¥"
	@echo "  check         æ£€æŸ¥ä»£ç è´¨é‡"
	@echo ""
	@echo "æ„å»ºå‘½ä»¤:"
	@echo "  clean         æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  build         æ„å»ºåŒ…"
	@echo "  install       æœ¬åœ°å®‰è£…æµ‹è¯•"
	@echo ""
	@echo "å‘å¸ƒå‘½ä»¤:"
	@echo "  upload-test   ä¸Šä¼ åˆ°æµ‹è¯•PyPI"
	@echo "  upload        ä¸Šä¼ åˆ°æ­£å¼PyPI"
	@echo ""
	@echo "å¿«æ·å‘½ä»¤:"
	@echo "  quick-build   å¿«é€Ÿæ„å»ºå’Œæµ‹è¯•"
	@echo "  release-test  å‘å¸ƒåˆ°æµ‹è¯•PyPI"
	@echo "  release       å‘å¸ƒåˆ°æ­£å¼PyPI"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

# å®‰è£…å¼€å‘ä¾èµ–
dev-install:
	@echo "ğŸ“¦ å®‰è£…å¼€å‘ä¾èµ–..."
	pip install -e ".[dev]"
	pip install build twine

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	python -m pytest tests/ -v --cov=web_performance_monitor --cov-report=term-missing

# æ ¼å¼åŒ–ä»£ç 
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	black web_performance_monitor/ tests/ examples/
	isort web_performance_monitor/ tests/ examples/

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	flake8 web_performance_monitor/ tests/
	mypy web_performance_monitor/

# æ£€æŸ¥ä»£ç è´¨é‡
check: format lint test
	@echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

# æ„å»ºåŒ…
build: clean
	@echo "ğŸ“¦ æ„å»ºåŒ…..."
	python -m build
	@echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:"
	@ls -la dist/

# æ£€æŸ¥åŒ…
check-package:
	@echo "ğŸ” æ£€æŸ¥åŒ…..."
	twine check dist/*

# æœ¬åœ°å®‰è£…æµ‹è¯•
install: build check-package
	@echo "ğŸ“¦ æœ¬åœ°å®‰è£…æµ‹è¯•..."
	python scripts/build_and_test.py

# ä¸Šä¼ åˆ°æµ‹è¯•PyPI
upload-test: build check-package
	@echo "ğŸ“¤ ä¸Šä¼ åˆ°æµ‹è¯•PyPI..."
	twine upload --repository testpypi dist/*

# ä¸Šä¼ åˆ°æ­£å¼PyPI
upload: build check-package
	@echo "ğŸ“¤ ä¸Šä¼ åˆ°æ­£å¼PyPI..."
	twine upload dist/*

# å¿«é€Ÿæ„å»ºå’Œæµ‹è¯•
quick-build: clean build install
	@echo "âœ… å¿«é€Ÿæ„å»ºå’Œæµ‹è¯•å®Œæˆ"

# å‘å¸ƒåˆ°æµ‹è¯•PyPI
release-test: check build upload-test
	@echo "ğŸ‰ å·²å‘å¸ƒåˆ°æµ‹è¯•PyPI"
	@echo "æµ‹è¯•å®‰è£…: pip install --index-url https://test.pypi.org/simple/ web-performance-monitor"

# å‘å¸ƒåˆ°æ­£å¼PyPI
release: check build upload
	@echo "ğŸ‰ å·²å‘å¸ƒåˆ°æ­£å¼PyPI"
	@echo "å®‰è£…: pip install web-performance-monitor"

# ç‰ˆæœ¬æ›´æ–°
bump-patch:
	@echo "â¬†ï¸ æ›´æ–°è¡¥ä¸ç‰ˆæœ¬..."
	@python -c "import re; f='setup.py'; c=open(f).read(); v=re.search(r'version=\"(\d+)\.(\d+)\.(\d+)\"', c); nv=f'{v[1]}.{v[2]}.{int(v[3])+1}'; open(f, 'w').write(re.sub(r'version=\"\d+\.\d+\.\d+\"', f'version=\"{nv}\"', c)); print(f'ç‰ˆæœ¬æ›´æ–°ä¸º: {nv}')"

bump-minor:
	@echo "â¬†ï¸ æ›´æ–°æ¬¡ç‰ˆæœ¬..."
	@python -c "import re; f='setup.py'; c=open(f).read(); v=re.search(r'version=\"(\d+)\.(\d+)\.(\d+)\"', c); nv=f'{v[1]}.{int(v[2])+1}.0'; open(f, 'w').write(re.sub(r'version=\"\d+\.\d+\.\d+\"', f'version=\"{nv}\"', c)); print(f'ç‰ˆæœ¬æ›´æ–°ä¸º: {nv}')"

bump-major:
	@echo "â¬†ï¸ æ›´æ–°ä¸»ç‰ˆæœ¬..."
	@python -c "import re; f='setup.py'; c=open(f).read(); v=re.search(r'version=\"(\d+)\.(\d+)\.(\d+)\"', c); nv=f'{int(v[1])+1}.0.0'; open(f, 'w').write(re.sub(r'version=\"\d+\.\d+\.\d+\"', f'version=\"{nv}\"', c)); print(f'ç‰ˆæœ¬æ›´æ–°ä¸º: {nv}')"