# Pre-commit Integration

PrompTrek includes comprehensive pre-commit hooks to ensure code quality and prevent accidental commits of generated files.

## Quick Setup

```bash
# Install development dependencies (includes pre-commit)
uv sync --group dev
# or with pip: pip install -e .[dev]

# Install pre-commit hooks
uv run pre-commit install

# (Optional) Run hooks on all files
uv run pre-commit run --all-files
```

## What the Hooks Do

### 1. Validate PrompTrek Files
- **Hook**: `validate-promptrek-files`
- **Purpose**: Validates `.promptrek.yaml` files using `promptrek validate`
- **Files**: `*.promptrek.yaml`, `*.promptrek.yml`
- **When**: Before every commit

Example output:
```
Validate PrompTrek files.................................................Passed
```

### 2. Prevent Committing Generated Files
- **Hook**: `prevent-generated-files`
- **Purpose**: Blocks commits of files generated by promptrek
- **Files**: All generated AI editor configuration files
- **When**: Before every commit

Protected file patterns:
- `.github/copilot-instructions.md` - GitHub Copilot prompts
- `.cursor/` - Cursor editor configuration (modern .mdc rules)
- `config.yaml`, `.continue/` - Continue editor configuration
- `.claude/`, `CLAUDE.md` - Claude/Anthropic configuration
- `.cline-rules/` - Cline configuration
- `.codeium/`, `.codeiumrc` - Codeium configuration
- `.ai-prompts/` - General AI prompts directory
- `AGENTS.md` - Agent configuration

Example failure:
```
‚ùå ERROR: Attempting to commit generated prompt files!

The following files appear to be generated by promptrek and should not be committed:
  - .github/copilot-instructions.md
  - .cursor/rules/index.mdc

üí° These files are generated from .promptrek.yaml files and should be:
   ‚Ä¢ Added to .gitignore
   ‚Ä¢ Generated locally as needed
   ‚Ä¢ Not committed to version control

To fix this:
1. Remove these files from staging: git reset HEAD <file>
2. Add them to .gitignore if not already there
3. Commit only your .promptrek.yaml source files
```

### 3. Code Quality Checks
- **black-check**: Ensures code formatting follows black standards
- **isort-check**: Validates import sorting
- **flake8-check**: Checks code style and common issues

### 4. File Quality Checks
- **trailing-whitespace**: Removes trailing spaces
- **end-of-file-fixer**: Ensures files end with a newline
- **check-yaml**: Validates YAML syntax (excludes .promptrek.yaml files)
- **check-merge-conflict**: Detects merge conflict markers
- **debug-statements**: Prevents committing debug statements

## Generated Files and .gitignore

PrompTrek automatically ignores generated files via `.gitignore`:

```gitignore
# Generated AI Editor Configuration Files
# These files are generated by promptrek from .promptrek.yaml files
# and should not be committed to version control

# GitHub Copilot generated files
.github/copilot-instructions.md
.github/instructions/*.instructions.md
.github/prompts/*.prompt.md
.copilot/instructions.md

# Cursor generated files
.cursor/
.cursorignore
.cursorindexingignore

# Continue generated files
config.yaml
.continue/

# Claude generated files
.claude/
CLAUDE.md

# Cline generated files
.cline-rules/

# Codeium generated files
.codeium/
.codeiumrc

# Other AI editor files
.ai-prompts/
AGENTS.md
```

## Workflow

### Normal Development
1. Edit your `.promptrek.yaml` files
2. Commit changes normally - hooks will validate your files
3. Generate editor-specific files locally as needed:
   ```bash
   promptrek generate my-project.promptrek.yaml --all
   ```

### If Hooks Fail
1. **PrompTrek validation fails**: Fix the issues in your `.promptrek.yaml` file
2. **Generated files detected**: Remove them from staging and ensure they're in `.gitignore`
3. **Code formatting issues**: Run the formatters:
   ```bash
   black src/ tests/
   isort src/ tests/
   ```

## Manual Hook Execution

```bash
# Run all hooks on staged files
uv run pre-commit run

# Run all hooks on all files
uv run pre-commit run --all-files

# Run specific hook
uv run pre-commit run validate-promptrek-files
uv run pre-commit run prevent-generated-files

# Skip hooks for a specific commit (not recommended)
git commit --no-verify -m "Emergency commit"
```

## Configuration Files

- `.pre-commit-config.yaml` - Pre-commit hook configuration
- `.yamllint` - YAML linting rules for promptrek files
- `scripts/check_generated_files.py` - Script to detect generated files

## Troubleshooting

### Hook Installation Issues
```bash
# Reinstall hooks
uv run pre-commit uninstall
uv run pre-commit install

# Clear cache if needed
uv run pre-commit clean
```

### Network Issues
The configuration uses only local hooks to avoid network dependencies during commits.

### Bypassing Hooks (Emergency)
```bash
# Skip pre-commit hooks (use sparingly)
git commit --no-verify -m "Emergency commit"

# Re-run hooks later
uv run pre-commit run --all-files
```

## Integration with Make

Use the Makefile for common pre-commit operations:

```bash
# Set up development environment with hooks
make dev

# Install pre-commit hooks
make pre-commit-install

# Run all hooks
make pre-commit-run

# Update hook versions
make pre-commit-update
```

This ensures consistent development practices and prevents accidental commits of generated files that should remain local to each developer's environment.
