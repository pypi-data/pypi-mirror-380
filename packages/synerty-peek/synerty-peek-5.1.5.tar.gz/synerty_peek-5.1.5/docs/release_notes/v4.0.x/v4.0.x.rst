.. _release_notes_v4.0.x:

====================
v4.0.x Release Notes
====================

Platform Changes
----------------

Dependencies have updated as well as the removal of unneeded libraries to
increase Peeks performance and security while reducing it's footprint.

Redesigned Peek Admin User Interface for a modern look.

Greater number of command line tools and scripts make administration of the
services easier to find and use.

Major Plugin Changes
--------------------

Peek One Time password feature allows users to be sent a single use token for
logging onto the Peek Field Mobile Application. This reduces the frequency of
support calls for the administrators for forgotten password.

Peek Field Notes allows field crews to maintain their safety documentation
while offline. Discrepancies between the offline documentation and the
records on the ADMS are caught and can be recorded in custom fields in the ADMS.

PDF Diagram Exports can be configured to increase the scaling of Text and
Lines as well as disable layers by default.

Support Platforms
-----------------

The following platforms are supported:

- **RHEL**:
  - RHEL 8.8 or higher
  - RHEL 9.0 or higher
- **Browsers**:
  - Google Chrome version 78 or above
  - Microsoft Edge version 79 or above
- **iOS**
   - iOS 17, 18

Deployment
----------

There are no deployment changes with this release.

Deployment for Linux remains the same after the changes of Peek v3.4.x

Debian: :ref:`debian_install_prerequisites`

Redhat: :ref:`rhel_install_prerequisites`

Migration Steps
---------------

Please see v3.4 notes for steps relevant to your release.
:ref:`release_notes_v3.4.x`

User Acceptance Test Results
----------------------------

Peek v4.0.0 User Acceptance Test results can be found at:
:ref:`release_notes_v4.0.x_uat`


v4.0.3 Changes
--------------

Bug Fixes
`````````

- [peek/peek#1886] Improved Field Notes comparison with case-insensitive name matching to reduce false discrepancy reports between ADMS and Peek
- [peek/peek#2831] Fixed issue where invalid TextStyle dash pattern prevented lineStyle options from displaying in diagram editor
- [peek/peek#1895] Fixed PDF exporter to only include visible layers when generating exports
- [peek/peek#2796] Fixed PDF export to correctly render hotspot outlines in EDANR diagrams
- [peek/peek#2798] Fixed incident state updates to properly reflect offline transitions
- [peek/peek#2800] Fixed operation filtering to properly handle null substation names
- [peek/peek#2801] Fixed field user display in Permit Notes "Returned By" field
- [peek/peek#2802] Added ``None`` type handling to ``permitLocation`` field for permit notes display
- [peek/peek#2803] Fixed ValueError exception when exporting PDF of diagram regions with blank areas
- [peek/peek#2804] Fixed concurrent GeoJSON splitting processes issue
- [peek/peek#2806] Fixed GeoJSON loader to properly remove compiled shapes when features are disabled
- [peek/peek#2808] Fixed GeoJSON loader to prevent sending invalid NaN coordinates
- [peek/peek#2811] Fixed compatibility issue with UUID generation in NZORA Core Screen
- [peek/peek#2836] Fixed agent configuration updates for ShapeConfigs in GeoJSON Loader
- [peek/peek#2837] Fixed GeoJSON Loader 2D coordinate conversion for Polygon geometry
- [peek/peek#2814] Fixed file descriptor limit issue in GeoJSON loader
- [peek/peek#2813] Fixed SQLAlchemy transaction initialization error in GraphDB segment compiler
- [peek/peek#2816] Fixed GeoJSON loader stalling during natural_wood file processing
- [peek/peek#2786] Fixed email template editing in NZORA incident management system
- [peek&79] Fixed bugs in NZORA module for accurate risk calculations and reporting
- [peek&80] Fixed multiple bugs in NZNPES-41 implementation
- [peek/peek#2775] Fixed offline job state handling to show STATE_CHANGE_ERROR appropriately
- [peek/peek#2823] Fixed DocumentDB compiler task SQLAlchemy 2.0 transaction handling
- [peek/peek#2824] Fixed GeoJSON loader road feature display
- [peek/peek#2825] Fixed polygon fill image rendering transparency
- [peek/peek#2784] Fixed job description display in notifications
- [peek/peek#2785] Fixed NZORA SQL Plugin custom SQL editing
- [peek/peek#2826] Fixed Enable/Disable queue controls in Admin interface
- [peek/peek#2827] Fixed Admin Lookup List name display formatting
- [peek/peek#2829] Fixed GeoJSON loader shape deletion handling

Improvements
````````````

- [peek/peek#2805] Added loading status text indicator to GeoJSON Loader
- [peek/peek#2807] Added warning messages and NaN handling in diagram grid calculations
- [peek/peek#2781] Changed 'Release No' field label to 'Job Number' across interfaces
- [peek/peek#2810] Added "Future" filter option and NZORA field switching functionality
- [peek/peek#2787] Clarified email incident test feature behavior
- [peek/peek#2789] Removed "Work Complete" field editing from NZORA permit screens
- [peek/peek#2777] Aligned NZORA permit screen layouts
- [peek/peek#2778] Renamed "Failure Comments" to "Exact Location ID" in NZORA Incident Fault Report
- [peek/peek#2779] Updated 'Order No' to 'Works Order No' in job details
- [peek/peek#2780] Added read-only voltage field to HV fault report interface
- [peek/peek#2788] Added Job Organiser field display
- [peek/peek#2783] Added NAR Number field to Job header and list views
- [peek/peek#2782] Changed 'Order No' to 'Works Order Number' on Job detail page

Tasks
`````
- [peek/peek#2794] Fixed missing Peek service Python packages in v4.0.0
- [peek/peek#2832] Fixed 404 error for Zepben Ednar frontend endpoint
- [peek/peek#2833] Fixed frontend build failures in Peek Admin App
- [peek/peek#2834] Fixed browser performance degradation on Peek Admin App dashboard
- [peek/peek#2818] Verified Peek Field Switching functionality on iOS 18.2


v4.0.2 Changes
--------------

Bug Fixes
`````````
- [peek/peek#1843] Added "No damaged items" message when Assessment tab is empty
- [peek/peek#1865] Added error message when attempting to view non-existent incidents from Inbox
- [peek/peek#1868] Fixed compatibility with Microsoft Edge 132.x+ for HTTPS connections
- [peek/peek#1832] Fixed equipment navigation state preservation in DMS Diagram when moving between incident and equipment views
- [peek/peek#2721] PDF Exporter now correctly respects Force Hide layer settings
- [peek/peek#2714] DMS diagram now defaults to coordinate set with lowest order value as landing page
- [peek/peek#1692] Fixed conductor rendering in PDF exports for zoomed-in diagram sections
- [peek/peek#2708] Resolved SSL certificate verification issues with PDF Exporter when using mutual TLS
- [peek/peek#2713] Updated EDNAR Frontend for compatibility with Chrome 78.0.3904.108
- [peek/peek#2710] Added clear error message for older browsers when crypto library is missing on non-HTTPS connections
- [peek/peek#2711] Fixed EDNAR web-app loading in Peek Office (requires trailing slash: `/peek_plugin_zepben_ednar_dms_diagram/ednar/`)

Improvements
````````````
- [peek/peek#1894] Added user title column to Devices table
- [peek/peek#2700] Simplified EDNAR Plugin toolbar interface, retaining only essential buttons
- [peek/peek#2707] Enhanced user identification by adding userTitle field to core authentication system

Tasks
`````
- [peek/peek#2689] Updated PDF exporter subprocess implementation
- [peek/peek#2705] Fixed OSM GeoJSON watcher by resolving missing reactor import
- [peek/peek#2706] Fixed ENMAC Equipment Loader tuple indexing
- [peek/peek#2709] Optimized EDNAR frontend build size
- [peek/peek#2712] Updated EDNAR plugin version resource to 3.2.10
- [peek/peek#2703] Released v4.0.2 wit



v4.0.1 Changes
--------------

Pipeline testing build

v4.0.0 Changes
--------------

New Features
````````````

Core Screen
^^^^^^^^^^^
Added new Core Screen functionality providing centralized system monitoring and management capabilities. Key features include:

* Static Paragraph and Heading widgets for fixed text elements
* Select, Text, and Radio edit field types for form inputs
* Date and Time edit widgets
* Support for linking and copying screen definitions
* Debug JSON Display widget for development
* Mandatory field validation
* JSON editing and copying in admin interface

Epics: peek&63

One-Time Password Authentication
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Added one-time password (OTP) authentication to enhance platform security:

* Configurable OTP group management
* Email-based code delivery
* Enhanced warning visibility
* Automatic OTP group creation during migration

Epics: peek&1738

Progressive Web App Support
^^^^^^^^^^^^^^^^^^^^^^^^^^
Converted Peek Field and Office applications to Progressive Web Apps (PWA):

* Offline functionality
* App installation support on compatible devices
* Improved performance and reliability

Epics: peek&2579

Improvements
````````````

Diagram Interface
^^^^^^^^^^^^^^^^
* [peek/peek#2683] Added Display Options menu with modal for branch/layer visibility
* [peek/peek#2701] Added configuration to hide coordinate position labels
* [peek/peek#1705] Enhanced logging clarity for font size import failures
* [peek/peek#1731] Changed coordinate set selection to use new "order" field
* [peek/peek#2554] Enhanced "Toggle Feeder Colors" button tooltip to show current state

User Interface
^^^^^^^^^^^^^
* [peek/peek#464] Enhanced date picker interface with clear parameter labels
* [peek/peek#1806] Added dynamic text scaling support for iOS system font preferences
* [peek/peek#1836] Improved button visibility and color contrast in Admin App

Database & Performance
^^^^^^^^^^^^^^^^^^^^^
* [peek/peek#1458] Enhanced PostgreSQL connectivity with automatic psycopg configuration
* [peek/peek#1605] Optimized database bulk load performance by 47% for large datasets
* [peek/peek#1619] Added LDAP group-based access restrictions for diagram coordinate sets

Bugs
````

Critical Fixes
^^^^^^^^^^^^^
* [peek/peek#1830] Fixed deadlock in logic service during user login
* [peek/peek#1876] Resolved GraphDB loader unique constraint violations
* [peek/peek#1691] Fixed ENMAC Diagram Loader permission handling to prevent incorrect shape deletion
* [peek/peek#1695] Added missing nonScalableTextFrontSizeMultiplier attribute for PDF exports

User Interface
^^^^^^^^^^^^^
* [peek/peek#1831] Fixed blank screen issue when reloading Field App
* [peek/peek#1839] Resolved blank screen display for incidents with zero findings
* [peek/peek#1852] Fixed unacknowledged message counter updates during reconnection
* [peek/peek#1871] Eliminated duplicate user cards on login screen

Data Handling
^^^^^^^^^^^^
* [peek/peek#1682] Fixed corruption of large payloads between browser and server
* [peek/peek#1684] Resolved date/time parsing error in ENMAC SQL plugin
* [peek/peek#2681] Fixed SQLAlchemy compatibility issue during dataset upgrades

Tasks
`````

Build & Development
^^^^^^^^^^^^^^^^^^
* [peek/peek#1629] Added run_peek_logic_service_migrate_only script for AttuneOps.io
* [peek/peek#1400] Updated macOS development environment setup
* [peek/peek#1401] Updated Linux server build automation for v4
* [peek/peek#1439] Updated documentation system for Sphinx 7 support
* [peek/peek#1743] Added live development capabilities with auto-reload
* [peek/peek#1883] Enhanced development workspace configuration tools