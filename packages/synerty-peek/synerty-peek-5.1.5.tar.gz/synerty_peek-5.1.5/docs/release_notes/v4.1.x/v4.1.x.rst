.. _release_notes_v4.1.x:

====================
v4.1.x Release Notes
====================

Platform Changes
----------------

Nil

Major Plugin Changes
--------------------

OSM Loader plugin is now a new more flexible
 'peek-plugin-diagram-geojson-loader' plugin,
 compatible with OpenStreetMaps converted via Osmium and ArcGIS GeoJSON

Support Platforms
-----------------

The following platforms are supported:

- **RHEL**:
  - RHEL 8.8 or higher
  - RHEL 9.0 or higher
- **Browsers**:
  - Google Chrome version 78 or above
  - Microsoft Edge version 79 or above
- **iOS**
  - iOS 17

Deployment
----------

There are no deployment changes with this release.

Deployment for Linux remains the same after the changes of Peek v3.4.x

Redhat: :ref:`rhel_install_prerequisites`


v4.1.9 Changes
--------------

Bug Fixes
`````````

- [peek/peek#2896] PDF Exportor Fixed renders sometimes failing when random tmpdir contains underscrore


v4.1.8 Changes
--------------

The release focus on several key bug fixes improving PDF exports, user interface responsiveness, and notifications. Development tasks included build optimization and logging improvements.


Bug Fixes
`````````

- [peek/peek#2889] PDF Exportor Fixed PDF export rendering randomly omitting shapes by implementing correct layer/level sorting
- [peek/peek#2890] PDF Exportor Fixed PDF export rendering of fill images in polygons, ensuring pattern images display correctly in exported diagrams
- [peek/peek#2892] EventDB Fixed issue where Alarms/Events list page did not load events until user changed filter
- [peek/peek#2893] EventDB Fixed formatting to remove extra space between date and time in EventDB display
- [peek/peek#2894] Diagram Added message when no canvas access permissions are available

Tasks
`````

- [peek/peek#2871] Fixed web builds to ignore ``.angular`` cache directory changes during change detection
- [peek/peek#2888] Release preparation tasks for AttuneOps.io v4.1.8
- [peek/peek#2891] Reduced worker log verbosity by disabling Celery debug output in worker DEBUG setting




v4.1.7 Changes
--------------

This update focuses on bug fixes that improve GeoJSON functionality
and PDF exports in the Peek platform.

The changes enhance diagram display capabilities and search functionality
while ensuring proper handling of curved text and large polygon features.

Bug Fixes
`````````

* [peek/peek#2881] Fixed GeoJSON curved text search functionality by updating JQText format and implementing new key-based linking between docdb search and diagram objects. **Note:** Requires database update to new schema.

* [peek/peek#2882] Fixed PDF export failures when diagrams contain curved text shapes by adding missing horizontalStretch attribute.

* [peek/peek#2883] Resolved issue with large GeoJSON MultiPolygon features not displaying in diagrams by:
    - Correcting projection area handling logic
    - Implementing proper shape splitting for large polygons
    - Fixing shape import tracking and grid compilation
    - Resolving orphaned shape cleanup


v4.1.5 Changes
--------------

Bug Fixes
`````````

* [peek/peek#2879] GeoJSON - Inner and Outer Polygon shapes are identical


v4.1.5 Changes
--------------

Bug Fixes
`````````

* [peek/peek#2708] Fixed SSL verification errors in PDF exports when using mutual TLS authentication by properly configuring SSL context parameters
* [peek/peek#2875] Resolved transaction rollback errors in GraphDB by eliminating subtransactions from ItemKeyIndexCompilerTask
* [peek/peek#2876] Addressed KeyError exception when downloading CSV exports from EventDB by adding missing 'name' field in tuple selector
* [peek/peek#2877] Fixed alarm list filtering to properly respect the "alarms only" toggle state when displaying events


v4.1.4 Changes
--------------

New Features
````````````

Diagram Polyline Border Styling
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Added support for configuring border color and width on polylines in diagram rendering
and GeoJSON loader. This enhancement enables road features to be displayed with
customizable borders, improving visual distinction of different road types.

Issues: peek/peek#2851

GeoJSON Loader Text Enhancements
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Added comprehensive text display capabilities for GeoJSON features:

* Support for text labels within polygon features using centroid calculation
* Configurable JQ text selectors for Text and CurvedText feature handlers
* Customizable display text, object names, and searchable properties

Issues: peek/peek#2855 peek/peek#2856

GeoJSON Shape Splitting
~~~~~~~~~~~~~~~~~~~~~~~

Added grid-based shape splitting to improve large feature rendering.

Each shape that touches a grid in the peek diagrams grid compiler is included
in that grid. This causes significant performance issues with large shapes that
have a large number of points.

This feature allows the GoeJSON loader to split large polygons into smaller
polygons.

The middle of the polygons as they are split are just squares.
The outer areas of the polygons are each smaller, with less points and compile
into less grids.

This allows Peek to consume the polygon around New Zealand's north island,
which is well over 74,000 points as manageable bites.

The performance improvement improves grid sizes and rendering speed.

Issues: peek/peek#2850

Bug Fixes
`````````

Diagram
~~~~~~~

* [peek/peek#2865] Added error message for shape creation without default layer
* [peek/peek#2848] Added visual indicators for selected GeoJSON features

Diagram Editor
~~~~~~~~~~~~~~

* [peek/peek#2863] Fixed diagram edit handles to match visual size with clickable area
* [peek/peek#2864] Fixed diagram branch editor retaining unsaved changes
* [peek/peek#2869] Fixed selection of deleted shapes when clicking their previous location
* [peek/peek#2870] Fixed duplicate LineWidth property in ShapeProperties for ellipses

GeoJSON Loader
~~~~~~~~~~~~~~

* [peek/peek#2839] Fixed unique key violation in loader by updating chunk indexing logic
* [peek/peek#2840] Fixed layer order field to accept negative values
* [peek/peek#2841] Fixed unique key violation when importing multiple levels
* [peek/peek#2842] Fixed polygon shape import for LotType configurations
* [peek/peek#2843] Fixed layer name display when adding new items
* [peek/peek#2853] Fixed line thickness inheritance issues
* [peek/peek#2854] Fixed road name display in curved text imports

PDF Export
~~~~~~~~~~

* [peek/peek#2721] Fixed PDF exporter to properly respect Force Hide layer settings

Tasks
`````

* [peek/peek#2844] Added ``--color`` flag support to iOS app repackaging script
* [peek/peek#2845] Fixed deployment configuration script for PyCharm
* [peek/peek#2847] Fixed dependency specification for peek-plugin-base package
* [peek/peek#2871] Fixed web builds to ignore ``.angular`` cache directory

Improvements
````````````

* [peek/peek#2858] Added filters to remove non-functional polylines and polygons
* [peek/peek#2861] Added ability to edit Lookup Import Hash for new diagrams
* [peek/peek#2862] Added editing capabilities for curved text elements
* [peek/peek#2866] Added shape type field to properties panel
* [peek/peek#2846] Added debug logging for GeoJSON operations

v4.1.3 Changes
--------------

Improvements
````````````

- [peek/peek#2805] Added loading status text indicator to GeoJSON Loader for improved visibility of data import progress
- [peek/peek#2807] Added warning messages and NaN handling in diagram grid calculations
- [peek/peek#2810] Added "Future" filter option and implemented NZORA field switching functionality
- [peek/peek#2821] Enhanced admin interface with improved enabled/disabled toggle switches and save button functionality
- [peek/peek#2780] Added read-only voltage field display to HV fault report interface
- [peek/peek#2783] Added NAR Number field (``SAP_IN_CHARGE``) to the Peek Job header display and job list views
- [peek/peek#2799] Added ability to configure custom logos in PDF Exporter

Bug Fixes
`````````

- [peek/peek#1886] Field Notes comparison now handles case-insensitive name matching to reduce discrepancy reports between ADMS and Peek
- [peek/peek#2831] Fixed issue where invalid TextStyle dash pattern prevented lineStyle options from displaying in diagram editor
- [peek/peek#1895] Fixed PDF exporter to only include visible layers when generating PDF exports
- [peek/peek#2832] Fixed 404 error when accessing Zepben Ednar frontend at ``/peek_plugin_zepben_ednar_dms_diagram/ednar`` endpoint
- [peek/peek#2834] Fixed browser performance degradation on Peek Admin App dashboard
- [peek/peek#2796] Fixed PDF export to correctly render hotspot outlines in EDANR diagrams
- [peek/peek#2798] Fixed incident state updates to correctly reflect offline transitions
- [peek/peek#2800] Fixed operation filtering to properly handle null substation names
- [peek/peek#2801] Fixed field user display in Permit Notes "Returned By" field
- [peek/peek#2802] Added ``| None`` type handling to ``permitLocation`` field to fix permit notes display
- [peek/peek#2803] Fixed ValueError exception when exporting PDF of diagram regions with blank areas
- [peek/peek#2806] Fixed GeoJSON loader to properly remove compiled shapes when features are disabled
- [peek/peek#2808] Fixed GeoJSON loader to prevent sending invalid NaN coordinates to diagram API
- [peek/peek#2811] Fixed compatibility issue with ``window.crypto.randomUUID()`` function in NZORA Core Screen
- [peek/peek#2836] Fixed issue where agent configuration updates for ShapeConfigs were not applying
- [peek/peek#2837] Fixed GeoJSON Loader to properly handle 2D conversion for Polygon geometry types
- [peek/peek#2786] Fixed issue preventing email template editing in NZORA incident management system
- [peek/peek#2721] Fixed PDF Exporter to properly respect Force Hide layer settings
- [peek/peek#2775] Fixed job state handling when offline - now shows STATE_CHANGE_ERROR instead of STATE_CHANGE_PENDING
- [peek/peek#2784] Fixed job description display in SMS and email notifications
- [peek/peek#2785] Fixed issue preventing custom SQL editing in NZORA SQL Plugin
- [peek/peek#2826] Fixed Enable/Disable queue controls functionality in Admin interface
- [peek/peek#2827] Fixed display formatting of Admin Lookup List names
- [peek/peek#2829] Fixed GeoJSON loader shape deletion handling for split files
- [peek/peek#2794] Fixed missing Peek service Python packages in v4.1.0
- [peek/peek#2833] Fixed frontend build failures in Peek Admin App
- [peek/peek#2813] Fixed SQLAlchemy transaction initialization error in GraphDB segment compiler
- [peek/peek#2814] Fixed file descriptor limit issue in GeoJSON loader
- [peek/peek#2816] Fixed GeoJSON loader stalling during natural_wood file processing
- [peek/peek#2823] Fixed DocumentDB compiler task failing due to SQLAlchemy 2.0 transaction handling
- [peek/peek#2824] Fixed GeoJSON loader road feature display issues

v4.1.2 Changes
--------------

Pipeline testing build

v4.1.1 Changes
--------------

Pipeline testing build

v4.1.0 Changes
--------------

New Features
````````````

Diagram Editor Enhancements
^^^^^^^^^^^^^^^^^^^^^^^^^^
Added comprehensive diagram editing capabilities including:

- Live-updating diagram lookup editor for relationship management
- Customizable canvas grid size settings
- Modal-based lookup editor service
- Visual canvas editor with live preview
- Dropdown menus for default lookup selection and editing

Issues: peek/peek#2739 peek/peek#2740 peek/peek#2741 peek/peek#2742 peek/peek#2767

GeoJSON Support
^^^^^^^^^^^^^^^
Introduced extensive GeoJSON support features including:

- Administrative interface for managing GeoJSON profile configurations
- Feature configuration screens supporting multiple shape types:
    - Polygons
    - Text (straight and curved)
    - Polylines
- Color and level customization options
- Profile-based configuration management
- Automatic feature list population from JSON analysis
- Optimized processing for large datasets through:
    - Chunked loading
    - Feature-type based import hashing
    - File state tracking with timestamps

Issues: peek/peek#2732 peek/peek#2733 peek/peek#2734 peek/peek#2735 peek/peek#2736 peek/peek#2737 peek/peek#2764 peek/peek#2765

Improvements
````````````
- [peek/peek#2766] Updated diagram table columns (DispCompilerQueue, DispGroupPointer, DispPolyline) to use bigint data type to prevent integer overflow
- [peek/peek#2763] Added API capability to delete DocDB documents by import group hash
- [peek/peek#2790] Introduced ``@peek_admin`` TypeScript decorator for marking admin-only components and routes

Bug Fixes
`````````
- [peek/peek#2734] Resolved GraphDB Loader error when processing invalid regular expressions in Split Point Configuration component alias matching

Tasks
`````
- [peek/peek#1630] Updated Oracle Instant Client to version 19.16 for macOS compatibility
- [peek/peek#1732] Added code formatting configuration to ``pyproject.toml``
- [peek/peek#2791] Added support for configurable plugin data directories in Peek Agent
- [peek/peek#2727] Created v4.1.x branches for GeoJSON repository maintenance
