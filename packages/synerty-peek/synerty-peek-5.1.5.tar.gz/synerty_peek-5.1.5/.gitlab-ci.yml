include:
    - local: '.gitlab-release-branch.yml'
    - local: '.gitlab-variables.yml'
    - local: 'ci/base.yml'
    - local: 'ci/peek-git-clone-repos.yml'
    - local: 'ci/peek-git-sha1-doc.yml'
    - local: 'ci/peek-py-package-build.yml'
    - local: 'ci/peek-py-package-md5-doc.yml'
    - local: 'ci/peek-py-package-upload.yml'
    - local: 'ci/peek-linux-dependencies-fetch.yml'
    - local: 'ci/peek-linux-package-build.yml'
    - local: 'ci/peek-linux-package-test.yml'
    - local: 'ci/peek-linux-package-upload.yml'
    - local: 'ci/peek-sbom-generation.yml'
    - local: '.gitlab-pipeline-notify.yml'

stages:
    - docs
    - fetch
    - py_package
    - doc
    - lin_package
    - test
    - sbom
    - upload
    - notify

build_html_docs:
    artifacts:
        paths:
            - synerty-peek-html
        expire_in: 1 day
    allow_failure: false
    image: nexus.synerty.com:5000/peek-alma8-doc:${RELEASE_BRANCH}
    only:
        - pushes
        - merge_requests
    script:
        - uname -a
        - which python || true
        - python --version
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - pip install -r docs/rtfd_requirements.txt
        - (cd docs && bash build_html_docs.sh)
        - mv docs/doc_dist synerty-peek-html
    stage: docs
    tags:
        - linux

build_latex_docs:
    artifacts:
        paths:
            - synerty-peek.pdf
        expire_in: 1 day
    allow_failure: false
    image: nexus.synerty.com:5000/peek-alma8-doc:${RELEASE_BRANCH}
    only:
        - pushes
        - merge_requests
    script:
        - uname -a
        - which python || true
        - python --version
        - export PIP_INDEX=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/pypi
        - export PIP_INDEX_URL=http://${NEXUS_USER}:${NEXUS_PASSWORD}@${NEXUS_URL}/repository/pypi-all/simple
        - export PIP_TRUSTED_HOST=${NEXUS_URL}
        - pip install -r docs/rtfd_requirements.txt
        - (cd docs && bash build_pdf_doc.sh)
        - mv docs/doc_dist_latex/SynertyPeek.pdf synerty-peek.pdf
    stage: docs
    tags:
        - linux